<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ù„ÙˆØ­Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ | Artrova</title>
  <link rel="icon" type="image/svg+xml" href="assets/favicon.svg">
  <link rel="icon" type="image/png" sizes="32x32" href="assets/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="assets/favicon-16x16.png">
  <link rel="apple-touch-icon" sizes="180x180" href="assets/apple-touch-icon.png">
  <style>
    :root {
      --bg: #0b1220;
      --panel: #0f172a;
      --card: #111827;
      --text: #e5e7eb;
      --muted: rgba(229,231,235,0.7);
      --border: rgba(255,255,255,0.12);
      --primary: #f08ac0;
      --danger: #ef4444;
      --ok: #10b981;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1000px 700px at 20% -10%, rgba(240,138,192,0.18), transparent 55%),
                  radial-gradient(900px 600px at 90% 0%, rgba(56,189,248,0.16), transparent 55%),
                  var(--bg);
      color: var(--text);
      min-height: 100vh;
    }
    a { color: var(--primary); }
    .wrap { max-width: 1220px; margin: 0 auto; padding: 18px; }

    .kbd {
      padding: 2px 8px;
      border: 1px solid var(--border);
      border-radius: 999px;
      font-size: 0.82rem;
      color: rgba(255,255,255,0.9);
      background: rgba(255,255,255,0.06);
      white-space: nowrap;
    }

    .topbar {
      position: sticky;
      top: 0;
      z-index: 100;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding: 14px 16px;
      border: 1px solid var(--border);
      border-radius: 14px;
      background: rgba(17,24,39,0.7);
      backdrop-filter: blur(10px);
    }
    .topbar h1 { margin: 0; font-size: 1.05rem; font-weight: 900; }
    .topbar .hint { color: var(--muted); font-size: 0.9rem; }

    @media (max-width: 520px) {
      .wrap { padding: 12px; }
      .topbar { border-radius: 16px; padding: 12px 12px; }
      .topbar .hint { display: none; }
    }

    .grid {
      display: grid;
      grid-template-columns: 380px 1fr;
      gap: 16px;
      margin-top: 16px;
    }
    @media (max-width: 980px) { .grid { grid-template-columns: 1fr; } }

    .panel {
      border: 1px solid var(--border);
      border-radius: 14px;
      background: rgba(15, 23, 42, 0.66);
      backdrop-filter: blur(10px);
      overflow: hidden;
    }
    .panel-header {
      padding: 12px 14px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      border-bottom: 1px solid var(--border);
      background: rgba(17, 24, 39, 0.55);
    }
    .panel-header h2 { margin: 0; font-size: 0.98rem; }
    .panel-body { padding: 14px; }

    .row { display: flex; gap: 10px; flex-wrap: wrap; }
    .col { display: flex; flex-direction: column; gap: 8px; }

    label { font-size: 0.85rem; color: var(--muted); }
    input[type="text"], input[type="password"], input[type="url"], select, textarea {
      width: 100%;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(2,6,23,0.55);
      color: var(--text);
      outline: none;
    }
    textarea { min-height: 110px; resize: vertical; }

    .btn {
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.06);
      color: var(--text);
      cursor: pointer;
      font-weight: 800;
    }
    .btn:hover { border-color: rgba(255,255,255,0.2); }
    .btn.primary { background: rgba(240,138,192,0.2); border-color: rgba(240,138,192,0.45); }
    .btn.ok { background: rgba(16,185,129,0.16); border-color: rgba(16,185,129,0.42); }
    .btn.danger { background: rgba(239,68,68,0.14); border-color: rgba(239,68,68,0.5); }
    .btn.small { padding: 6px 10px; border-radius: 10px; font-size: 0.86rem; }

    @media (max-width: 520px) {
      .btn { border-radius: 14px; }
      #btnSync { width: 100%; padding: 12px 14px; }
      #btnPublish, #btnExportJson { display: none; }
    }

    #btnPublish, #btnSync { display: none; }

    .list {
      max-height: 62vh;
      overflow: auto;
      padding-right: 6px;
    }

    .searchbar {
      display: flex;
      gap: 10px;
      align-items: center;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }
    .searchbar input[type="text"] {
      flex: 1;
      min-width: 240px;
    }
    .searchbar .hint {
      font-size: 0.9rem;
      color: var(--muted);
    }

    .header-controls {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }
    .header-controls select {
      width: auto;
      min-width: 140px;
    }

    .project-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
    }
    @media (min-width: 980px) {
      .project-grid { grid-template-columns: 1fr; }
    }
    @media (max-width: 520px) {
      .project-grid { grid-template-columns: repeat(3, minmax(0, 1fr)); gap: 8px; }
    }

    .project-card {
      border: 1px solid var(--border);
      border-radius: 14px;
      background: rgba(2,6,23,0.35);
      overflow: hidden;
      cursor: pointer;
      position: relative;
    }
    .project-card.active { border-color: rgba(240,138,192,0.6); box-shadow: 0 0 0 3px rgba(240,138,192,0.12); }
    .project-card .thumb {
      width: 100%;
      aspect-ratio: 4 / 3;
      background: rgba(255,255,255,0.04);
      overflow: hidden;
    }
    .project-card .thumb img { width: 100%; height: 100%; object-fit: cover; display: block; }
    .project-card .overlay {
      position: absolute;
      inset: auto 8px 8px 8px;
      padding: 8px 10px;
      border-radius: 12px;
      background: linear-gradient(180deg, rgba(15, 23, 42, 0.0), rgba(15, 23, 42, 0.86));
      color: rgba(255,255,255,0.96);
      font-weight: 900;
      line-height: 1.25;
      text-shadow: 0 2px 12px rgba(0,0,0,0.35);
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    @media (max-width: 520px) {
      .project-card { border-radius: 16px; }
      .project-card .overlay { inset: auto 6px 6px 6px; padding: 6px 8px; border-radius: 12px; font-size: 0.88rem; }
      .project-card .count { display: none; }
    }
    .project-card .count {
      position: absolute;
      top: 8px;
      left: 8px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.18);
      background: rgba(0,0,0,0.35);
      color: rgba(255,255,255,0.96);
      font-weight: 900;
      font-size: 0.85rem;
      backdrop-filter: blur(8px);
    }

    .notice {
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(2,6,23,0.35);
      color: var(--muted);
      font-size: 0.92rem;
    }
    .notice.danger { border-color: rgba(239,68,68,0.55); color: rgba(255,255,255,0.92); }
    .notice.ok { border-color: rgba(16,185,129,0.55); color: rgba(255,255,255,0.92); }

    .imgs {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 10px;
    }
    @media (max-width: 820px) {
      .imgs { grid-template-columns: repeat(3, minmax(0, 1fr)); }
    }
    @media (max-width: 520px) {
      .imgs { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }
    .img-card {
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
      background: rgba(2,6,23,0.3);
      display: flex;
      flex-direction: column;
      position: relative;
    }
    .img-card .thumb {
      width: 100%;
      aspect-ratio: 1 / 1;
      background: rgba(255,255,255,0.04);
      display: grid;
      place-items: center;
      overflow: hidden;
      position: relative;
    }
    .img-card img { width: 100%; height: 100%; object-fit: cover; display: block; }
    .img-card .body { padding: 10px; display: none; flex-direction: column; gap: 8px; }
    .img-card.open .body { display: flex; }
    .img-card .flags { display: flex; justify-content: space-between; gap: 8px; }

    .img-badge {
      position: absolute;
      top: 10px;
      left: 10px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.18);
      background: rgba(0,0,0,0.35);
      color: rgba(255,255,255,0.96);
      font-weight: 900;
      font-size: 0.82rem;
      backdrop-filter: blur(8px);
      z-index: 2;
    }
    .img-filename {
      position: absolute;
      left: 8px;
      right: 8px;
      bottom: 8px;
      padding: 8px 10px;
      border-radius: 12px;
      background: linear-gradient(180deg, rgba(0,0,0,0.0), rgba(0,0,0,0.55));
      color: rgba(255,255,255,0.95);
      font-weight: 800;
      font-size: 0.86rem;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      z-index: 1;
      pointer-events: none;
    }
    .img-actions {
      position: absolute;
      top: 8px;
      right: 8px;
      display: flex;
      gap: 8px;
      z-index: 2;
    }
    .img-action-btn {
      width: 36px;
      height: 36px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.18);
      background: rgba(0,0,0,0.35);
      color: rgba(255,255,255,0.96);
      display: grid;
      place-items: center;
      cursor: pointer;
      backdrop-filter: blur(8px);
      font-weight: 900;
    }
    .img-action-btn.danger { border-color: rgba(239,68,68,0.45); background: rgba(239,68,68,0.28); }
    .img-action-btn:active { transform: scale(0.98); }

    .img-action-btn.small {
      width: 34px;
      height: 34px;
      font-size: 0.95rem;
    }

    @media (max-width: 520px) {
      .img-action-btn { width: 38px; height: 38px; }
      .img-action-btn.small { width: 36px; height: 36px; }
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 0.85rem;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.06);
      color: var(--muted);
    }

    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.55);
      display: grid;
      place-items: center;
      padding: 18px;
      z-index: 9999;
    }
    .modal-card {
      width: min(920px, 100%);
      max-height: 86vh;
      overflow: auto;
      border: 1px solid var(--border);
      border-radius: 14px;
      background: rgba(15, 23, 42, 0.92);
      backdrop-filter: blur(12px);
    }
    .modal-card .panel-header { position: sticky; top: 0; z-index: 1; }
    .reorder-list {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 12px;
    }
    .reorder-item {
      border: 1px solid var(--border);
      border-radius: 12px;
      background: rgba(2,6,23,0.35);
      overflow: hidden;
      display: grid;
      grid-template-rows: 120px auto;
    }
    .reorder-item .thumb { height: 120px; overflow: hidden; background: rgba(255,255,255,0.04); }
    .reorder-item .thumb img { width: 100%; height: 100%; object-fit: cover; }
    .reorder-item .info { padding: 10px; display: grid; gap: 8px; }
    .reorder-item .handle {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 40px;
      height: 34px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.06);
      cursor: grab;
      user-select: none;
    }
    .reorder-item.dragging { opacity: 0.6; outline: 2px solid rgba(240,138,192,0.45); }

    .mobile-actionbar {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 64px;
      padding: 10px 12px;
      background: rgba(2, 6, 23, 0.78);
      border-top: 1px solid var(--border);
      backdrop-filter: blur(12px);
      z-index: 999;
      display: none;
    }
    .mobile-actionbar .btn {
      width: 100%;
      padding: 12px 14px;
      border-radius: 14px;
    }
    @media (max-width: 520px) {
      body { padding-bottom: 140px; }
    }

    .admin-bottom-nav {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      height: 64px;
      padding: 10px 12px;
      background: rgba(2, 6, 23, 0.86);
      border-top: 1px solid var(--border);
      backdrop-filter: blur(12px);
      z-index: 1000;
      display: none;
    }
    .admin-bottom-nav .inner {
      max-width: 1220px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      height: 100%;
      align-items: center;
    }
    .admin-bottom-nav .navbtn {
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.06);
      color: var(--text);
      border-radius: 14px;
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      font-weight: 900;
      cursor: pointer;
      user-select: none;
    }
    .admin-bottom-nav .navbtn.active {
      border-color: rgba(240,138,192,0.6);
      background: rgba(240,138,192,0.18);
      box-shadow: 0 0 0 3px rgba(240,138,192,0.12);
    }
    .admin-bottom-nav .ico { width: 22px; height: 22px; display: inline-block; }
    @media (max-width: 520px) {
      body.admin-authed .admin-bottom-nav { display: block; }
      body.admin-authed.admin-view-publish .mobile-actionbar { display: block; }
      body.admin-view-projects #panelEditor { display: none; }
      body.admin-view-projects #panelProjects { display: block; }

      body.admin-view-edit #panelProjects { display: none; }
      body.admin-view-edit #panelEditor { display: block; }
      body.admin-view-edit #sectionPublish { display: none; }
      body.admin-view-edit #sectionEdit { display: block; }

      body.admin-view-publish #panelProjects { display: none; }
      body.admin-view-publish #panelEditor { display: block; }
      body.admin-view-publish #sectionEdit { display: none; }
      body.admin-view-publish #sectionPublish { display: block; }

      body.admin-view-edit #sectionEdit {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
      body.admin-view-edit #editContextBar { order: 0; }
      body.admin-view-edit #uploadControls { order: 1; }
      body.admin-view-edit #uploadPreviewPanel { order: 2; }
      body.admin-view-edit #existingImagesPanel { order: 3; }
      body.admin-view-edit #projectMetaPanel { order: 4; }
      body.admin-view-edit #editHintNotice { order: 5; }
    }

    .edit-context {
      display: none;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      padding: 10px;
      border: 1px solid var(--border);
      border-radius: 14px;
      background: rgba(2, 6, 23, 0.55);
      position: sticky;
      top: 64px;
      z-index: 20;
      backdrop-filter: blur(10px);
    }
    .edit-context .left { display: grid; gap: 4px; min-width: 0; }
    .edit-context .title {
      font-weight: 1000;
      font-size: 0.98rem;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .edit-context .meta { display: flex; gap: 8px; flex-wrap: wrap; }
    .edit-context .meta .pill { font-size: 0.8rem; }
    @media (max-width: 520px) {
      body.admin-authed.admin-view-edit .edit-context { display: flex; }
    }

    .hidden { display: none !important; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div>
        <h1>Ù„ÙˆØ­Ø© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹</h1>
        <div class="hint">Ø±ÙØ¹/Ø­Ø°Ù ØµÙˆØ±ØŒ Ø¥Ø¶Ø§ÙØ©/Ø­Ø°Ù Ù…Ø´Ø§Ø±ÙŠØ¹ØŒ ÙˆØªØ­Ø¯ÙŠØ« Ù…Ù„Ù <code>data/portfolio_projects.json</code></div>
      </div>
      <div class="row">
        <a class="btn" href="index.html" target="_blank" rel="noopener">ÙØªØ­ Ø§Ù„Ù…ÙˆÙ‚Ø¹</a>
        <button class="btn danger" id="btnLogout">Ø®Ø±ÙˆØ¬</button>
      </div>
    </div>

    <div id="loginPanel" class="panel" style="margin-top:16px;">
      <div class="panel-header">
        <h2>Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø£Ø¯Ù…Ù†</h2>
        <span class="pill">Ø±Ø§Ø¨Ø· + Ø¨Ø§Ø³ÙˆØ±Ø¯</span>
      </div>
      <div class="panel-body">
        <div class="notice danger" style="margin-bottom:10px;">
          ØªÙ†Ø¨ÙŠÙ‡: Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯ Ù‡Ù†Ø§ Ø­Ù…Ø§ÙŠØ© ÙˆØ§Ø¬Ù‡Ø© ÙÙ‚Ø· (Client-side). Ù„Ø§ ØªØ´Ø§Ø±Ùƒ Ø±Ø§Ø¨Ø· Ø§Ù„Ø£Ø¯Ù…Ù† Ù…Ø¹ Ø£ÙŠ Ø´Ø®Øµ ØºÙŠØ± Ù…ÙˆØ«ÙˆÙ‚.
        </div>
        <div class="row" style="align-items:flex-end;">
          <div class="col" style="flex:1; min-width: 260px;">
            <label for="adminPass">Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯</label>
            <input id="adminPass" type="password" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯" autocomplete="current-password" />
          </div>
          <button class="btn primary" id="btnLogin">Ø¯Ø®ÙˆÙ„</button>
        </div>
        <div class="notice" style="margin-top:10px;">Ù…Ù„Ø§Ø­Ø¸Ø©: ØºÙŠØ± Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯ Ù…Ù† Ø¯Ø§Ø®Ù„ Ù…Ù„Ù <code>admin.html</code> (Ù…ØªØºÙŠØ± <code>ADMIN_PASSWORD</code>).</div>
      </div>
    </div>

    <div id="app" class="grid hidden">
      <div class="panel" id="panelProjects">
        <div class="panel-header">
          <h2>Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹</h2>
          <span class="pill" id="projectCount">0</span>
        </div>
        <div class="panel-body">
          <div class="searchbar">
            <input id="projectSearch" type="text" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ø´Ø±ÙˆØ¹ Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ù€slug..." />
            <span class="kbd">Ctrl + K</span>
          </div>
          <div class="row" style="align-items:flex-end; margin-bottom: 10px;">
            <div class="col" style="flex:1; min-width: 220px;">
              <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ (AR)</label>
              <input id="newTitleAr" type="text" placeholder="Ù…Ø«Ø§Ù„: Ø³ÙƒÙ†ÙŠ" />
            </div>
            <div class="col" style="flex:1; min-width: 220px;">
              <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ (EN)</label>
              <input id="newTitleEn" type="text" placeholder="Ù…Ø«Ø§Ù„: Residential" />
            </div>
          </div>
          <div class="row" style="align-items:flex-end; margin-bottom: 10px;">
            <div class="col" style="flex:1; min-width: 220px;">
              <label>Slug (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
              <input id="newSlug" type="text" placeholder="Ù…Ø«Ø§Ù„: residential" />
            </div>
            <button class="btn ok" id="btnAddProject">Ø¥Ø¶Ø§ÙØ© Ù…Ø´Ø±ÙˆØ¹</button>
          </div>

          <div class="project-grid list" id="projectList"></div>
        </div>
      </div>

      <div class="panel" id="panelEditor">
        <div class="panel-header">
          <h2 id="selectedTitle">Ø§Ø®ØªØ± Ù…Ø´Ø±ÙˆØ¹</h2>
          <div class="row">
            <button class="btn danger small" id="btnDeleteProject" disabled>Ø­Ø°Ù Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</button>
          </div>
        </div>
        <div class="panel-body">
          <div id="sectionEdit">
          <div class="edit-context" id="editContextBar">
            <div class="left">
              <div class="title" id="selectedTitleMobile">Ø§Ø®ØªØ± Ù…Ø´Ø±ÙˆØ¹</div>
              <div class="meta">
                <span class="pill">ØµÙˆØ±: <span id="imgCountMobile">0</span></span>
                <span class="pill">Ø¬Ø¯ÙŠØ¯Ø©: <span id="uploadCountMobile">0</span></span>
              </div>
            </div>
            <div class="row" style="gap:8px;">
              <button class="btn small" id="btnReorderMobile" type="button" disabled>ØªØ±ØªÙŠØ¨</button>
            </div>
          </div>
          <div id="fileProtoNotice" class="notice danger hidden" style="margin-bottom: 10px;">
            Ù„Ù† ØªØ¹Ù…Ù„ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„ÙØ§Øª/Ø§Ù„Ø±ÙØ¹ Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø© Ø¹Ø¨Ø± <code>file://</code>. Ø´ØºÙ‘Ù„ Live Server Ø£Ùˆ Ø§ÙØªØ­ Ø¹Ø¨Ø± <code>http://localhost</code>.
          </div>

          <div class="row" id="uploadControls" style="margin-bottom: 10px;">
            <div class="col" style="flex:1; min-width: 240px;">
              <label>Ø±ÙØ¹ ØµÙˆØ± Ù„Ù„Ù…Ø´Ø±ÙˆØ¹ (Ø§Ø®ØªÙŠØ§Ø± Ù…ØªØ¹Ø¯Ø¯)</label>
              <input id="imagePicker" type="file" accept="image/*" multiple disabled />
            </div>
            <button class="btn" id="btnAutoNames" disabled>ØªØ³Ù…ÙŠØ© ØªÙ„Ù‚Ø§Ø¦ÙŠØ©</button>
            <button class="btn" id="btnApplyUploads" disabled>Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØµÙˆØ± Ù„Ù„Ù…Ø´Ø±ÙˆØ¹</button>
            <button class="btn" id="btnRepairPick" disabled type="button">Ø±ÙØ¹ Ø§Ù„ØµÙˆØ± Ø§Ù„Ù†Ø§Ù‚ØµØ©</button>
            <input id="repairPicker" type="file" accept="image/*" multiple class="hidden" />
          </div>

          <div class="panel" id="projectMetaPanel" style="border-radius: 12px; margin-bottom: 12px;">
            <div class="panel-header">
              <h2 style="margin:0; font-size:0.92rem;">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø´Ø±ÙˆØ¹</h2>
              <span class="pill">ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø³Ù…</span>
            </div>
            <div class="panel-body">
              <div class="row" style="align-items:flex-end;">
                <div class="col" style="flex:1; min-width: 220px;">
                  <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ (AR)</label>
                  <input id="editTitleAr" type="text" placeholder="Ù…Ø«Ø§Ù„: Ø³ÙƒÙ†ÙŠ" disabled />
                </div>
                <div class="col" style="flex:1; min-width: 220px;">
                  <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ (EN)</label>
                  <input id="editTitleEn" type="text" placeholder="Ù…Ø«Ø§Ù„: Residential" disabled />
                </div>
                <button class="btn ok" id="btnSaveProjectTitles" disabled>Ø­ÙØ¸ Ø§Ù„Ø§Ø³Ù…</button>
              </div>
              <div class="notice" style="margin-top: 10px;">ØªØºÙŠÙŠØ± Ø§Ù„Ø§Ø³Ù… Ù‡Ù†Ø§ Ù„Ø§ ÙŠØºÙŠÙ‘Ø± Ø§Ø³Ù… Ø§Ù„ÙÙˆÙ„Ø¯Ø± (slug). ÙŠØªÙ… Ø­ÙØ¸Ù‡ Ø¯Ø§Ø®Ù„ Ù…Ù„Ù Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙ‚Ø·.</div>
            </div>
          </div>

          <div class="notice" id="editHintNotice" style="margin-bottom: 10px;">
            Ø¹Ø¯Ù‘Ù„ Ø§Ù„ØµÙˆØ± Ù‡Ù†Ø§ (ØªØ±ØªÙŠØ¨/Ø­Ø°Ù/Ø¥Ø¹Ø§Ø¯Ø© ØªØ³Ù…ÙŠØ©)ØŒ Ø«Ù… ØµØ¯Ù‘Ø± Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©.
          </div>

          <div class="panel" id="existingImagesPanel" style="border-radius: 12px; margin-bottom: 12px;">
            <div class="panel-header">
              <h2 style="margin:0; font-size:0.92rem;">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØµÙˆØ± (Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹)</h2>
              <span class="pill" id="imgCount">0</span>
              <div class="header-controls">
                <label style="font-size:0.82rem; color: var(--muted);">Ø¹Ø±Ø¶</label>
                <select id="existingLimit" aria-label="Ø¹Ø¯Ø¯ Ø§Ù„ØµÙˆØ± Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶Ø©">
                  <option value="60">60 ØµÙˆØ±Ø©</option>
                  <option value="120">120 ØµÙˆØ±Ø©</option>
                  <option value="240">240 ØµÙˆØ±Ø©</option>
                  <option value="0">Ø§Ù„ÙƒÙ„</option>
                </select>
                <button class="btn small" id="btnReorder" disabled>ØªØ±ØªÙŠØ¨ Ø§Ù„ØµÙˆØ±</button>
              </div>
            </div>
            <div class="panel-body">
              <div class="imgs" id="existingImages"></div>
            </div>
          </div>

          <div class="panel" id="uploadPreviewPanel" style="border-radius: 12px;">
            <div class="panel-header">
              <h2 style="margin:0; font-size:0.92rem;">ØµÙˆØ± Ø¬Ø¯ÙŠØ¯Ø© (Preview Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø¶Ø§ÙØ©)</h2>
              <span class="pill" id="uploadCount">0</span>
            </div>
            <div class="panel-body">
              <div class="imgs" id="uploadPreview"></div>
            </div>
          </div>

          </div>

          <div id="sectionPublish" class="panel" style="border-radius: 12px; margin-top: 12px;">
            <div class="panel-header">
              <h2 style="margin:0; font-size:0.92rem;">Ù†Ø´Ø± Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</h2>
              <span class="pill">GitHub</span>
            </div>
            <div class="panel-body">
              <div class="notice danger" style="margin-bottom: 10px;">
                Ø§Ù„ØµÙ‚ GitHub Token Ù‡Ù†Ø§ ÙˆÙ‚Øª Ø§Ù„Ù†Ø´Ø± ÙÙ‚Ø·. Ù„Ø§ ØªØ­ÙØ¸Ù‡ ÙÙŠ Ø£ÙŠ Ù…ÙƒØ§Ù†.
              </div>

              <div class="row" style="align-items:flex-end;">
                <div class="col" style="flex:1; min-width: 280px;">
                  <label>GitHub Token</label>
                  <input id="ghToken" type="password" placeholder="ghp_..." autocomplete="off" />
                </div>
                <div class="col" style="min-width: 220px;">
                  <label>&nbsp;</label>
                  <button class="btn" id="btnRememberToken" type="button">ØªØ°ÙƒÙ‘Ø± Ø§Ù„ØªÙˆÙƒÙ† Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø²</button>
                </div>
                <button class="btn" id="btnReloadData" type="button">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
                <button class="btn primary" id="btnOneClickPublish" disabled>Ø±ÙØ¹ + Ù†Ø´Ø± ÙÙˆØ±ÙŠ</button>
                <button class="btn ok" id="btnPublish" disabled>Ù†Ø´Ø± Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
                <button class="btn primary" id="btnSync" disabled>Ø­ÙØ¸ + Ø±ÙØ¹ Ø¹Ù„Ù‰ GitHub</button>
                <button class="btn" id="btnExportJson" disabled>Export JSON</button>
              </div>

              <div class="notice" id="statusBox" style="margin-top: 10px;">Ø¬Ø§Ù‡Ø².</div>
              <div id="progressWrap" class="hidden" style="margin-top:10px;">
                <div class="notice" style="margin:0 0 8px 0;">Ø§Ù„ØªÙ‚Ø¯Ù…: <span id="progressText">0%</span></div>
                <div style="border:1px solid var(--border); border-radius:999px; overflow:hidden; background: rgba(2,6,23,0.35); height: 12px;">
                  <div id="progressBar" style="height:100%; width:0%; background: linear-gradient(90deg, rgba(240,138,192,0.7), rgba(56,189,248,0.6));"></div>
                </div>
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>

  </div>

  <div class="mobile-actionbar" role="region" aria-label="Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ">
    <button class="btn primary" type="button" id="mobilePrimarySync">Ø±ÙØ¹ + Ù†Ø´Ø± ÙÙˆØ±ÙŠ</button>
  </div>

  <div class="admin-bottom-nav" role="navigation" aria-label="ØªÙ†Ù‚Ù„ Ø§Ù„Ø£Ø¯Ù…Ù†">
    <div class="inner">
      <button class="navbtn" type="button" data-view="projects">
        <span class="ico">ğŸ“</span>
        <span>Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹</span>
      </button>
      <button class="navbtn" type="button" data-view="edit">
        <span class="ico">ğŸ–¼ï¸</span>
        <span>ØªØ¹Ø¯ÙŠÙ„</span>
      </button>
      <button class="navbtn" type="button" data-view="publish">
        <span class="ico">â¬†ï¸</span>
        <span>Ù†Ø´Ø±</span>
      </button>
    </div>
  </div>

  <div id="reorderModal" class="modal hidden" role="dialog" aria-modal="true">
    <div class="modal-card panel">
      <div class="panel-header">
        <h2>ØªØ±ØªÙŠØ¨ Ø§Ù„ØµÙˆØ±</h2>
        <div class="row">
          <button class="btn small" id="btnReorderAuto" type="button">ØªØ±ØªÙŠØ¨ ØªÙ„Ù‚Ø§Ø¦ÙŠ (Ø­Ø³Ø¨ Ø§Ù„Ø§Ø³Ù…)</button>
          <button class="btn ok small" id="btnReorderSave" type="button">Ø­ÙØ¸ Ø§Ù„ØªØ±ØªÙŠØ¨</button>
          <button class="btn danger small" id="btnReorderClose" type="button">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
      </div>
      <div class="panel-body">
        <div class="notice" style="margin-bottom:10px;">
          Ø§Ø³Ø­Ø¨ Ø§Ù„ÙƒØ±ÙˆØª Ù…Ù† Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ø³Ø­Ø¨ Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„ØµÙˆØ±. Ø£ÙˆÙ„ ØµÙˆØ±Ø© Ø³ØªÙƒÙˆÙ† Ø§Ù„ØºÙ„Ø§Ù.
        </div>
        <div id="reorderList" class="reorder-list"></div>
      </div>
    </div>
  </div>

  <script>
    // ====== CONFIG ======
    // ØªØºÙŠÙŠØ± Ø§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯ Ù…Ù† Ù‡Ù†Ø§
    const ADMIN_PASSWORD = 'artrova123';

    const TOKEN_STORE_KEY = 'artrova_admin_gh_token_v1';

    // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª GitHub (Ø«Ø§Ø¨ØªØ© Ù„ØªØ¨Ø³ÙŠØ· Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…)
    // ØºÙŠÙ‘Ø±Ù‡Ø§ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© Ø«Ù… Ø§Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù Ø¹Ù„Ù‰ GitHub
    const GITHUB_OWNER = 'Artovastudio';
    const GITHUB_REPO = 'Artrova';
    const GITHUB_BRANCH = 'main';
    const GITHUB_PUBLISH_BRANCHES = ['main', 'gh-pages'];

    // Ù…Ù„Ø§Ø­Ø¸Ø©: Ù„Ø§ Ù†Ø³ØªØ®Ø¯Ù… localStorage/sessionStorage Ù„ØªØ¬Ù†Ø¨ Ù‚ÙŠÙˆØ¯ Ø§Ù„Ù…ØªØµÙØ­ (Tracking Prevention)
    const state = {
      authed: false,
      data: { source: 'portfolio_projects', count: 0, projects: [] },
      selectedSlug: null,
      projectSearch: '',
      existingLimit: 60,
      deleteSet: new Set(),
      renameMap: new Map(),
      dragExistingIndex: null,
      /** @type {Array<{file: File, previewUrl: string, name: string, targetPath: (string|null), appliedPath: (string|null), projectSlug: (string|null)}>} */
      uploads: [],
      /** @type {Array<{file: File, optimizedFile: (File|null), name: string, targetPath: string, projectSlug: string}>} */
      repairs: []
    };

    // ====== UTILS ======
    const $ = (id) => document.getElementById(id);

    function isFileProtocol() {
      try { return window.location && window.location.protocol === 'file:'; } catch (e) { return false; }
    }

    function slugify(input) {
      return String(input || '')
        .trim()
        .toLowerCase()
        .replace(/[^a-z0-9\s-_]/g, '')
        .replace(/\s+/g, '-')
        .replace(/-+/g, '-')
        .replace(/^\-+|\-+$/g, '') || 'project';
    }

    function sanitizeFilename(name) {
      const cleaned = String(name || '')
        .trim()
        .replace(/\s+/g, '-')
        .replace(/[^a-zA-Z0-9._-]/g, '')
        .replace(/-+/g, '-');
      return cleaned || 'image';
    }

    function getProjectBySlug(slug) {
      return (state.data.projects || []).find(p => p.slug === slug) || null;
    }

    function findProjectByImagePath(path) {
      const projects = state.data && Array.isArray(state.data.projects) ? state.data.projects : [];
      for (const p of projects) {
        if (p && Array.isArray(p.images) && p.images.includes(path)) return p;
      }
      return null;
    }

    function normalizeImagePathForProject(p, path) {
      let s = String(path || '').trim();
      if (!s) return '';

      // leave absolute URLs unchanged
      if (/^https?:\/\//i.test(s)) return s;

      // remove leading ./ or /
      s = s.replace(/^\.\//, '');
      s = s.replace(/^\//, '');

      // If it's already a relative path with folders, keep it.
      // The problematic case we want to fix is a bare filename like "000241.jpg".
      if (s.includes('/')) return s;

      const slug = p && p.slug ? String(p.slug) : '';
      if (!slug) return s;
      return `assets/site_images/projects/portfolio_projects/${slug}/${s}`;
    }

    function normalizePortfolioDataPaths() {
      const projects = state.data && Array.isArray(state.data.projects) ? state.data.projects : [];
      for (const p of projects) {
        if (!p) continue;
        if (Array.isArray(p.images)) {
          p.images = p.images.map((img) => normalizeImagePathForProject(p, img)).filter(Boolean);
        }
        if (p.cover) {
          p.cover = normalizeImagePathForProject(p, p.cover);
        }
        p.imageCount = Array.isArray(p.images) ? p.images.length : 0;
        if (!p.cover && Array.isArray(p.images) && p.images[0]) p.cover = p.images[0];
      }
    }

    function getProjectTitle(p) {
      if (!p) return '';
      const ar = String(p.titleAr || '').trim();
      const en = String(p.titleEn || '').trim();
      const any = String(p.title || '').trim();
      if (ar && en && ar.toLowerCase() !== en.toLowerCase()) return `${ar} | ${en}`;
      return ar || en || any || p.slug;
    }

    function updateCounts() {
      $('projectCount').textContent = String((state.data.projects || []).length);
      const p = state.selectedSlug ? getProjectBySlug(state.selectedSlug) : null;
      const imgCount = p && Array.isArray(p.images) ? String(p.images.length) : '0';
      const uploadCount = String(state.uploads.length);
      const repairCount = String((state.repairs || []).length);
      $('imgCount').textContent = imgCount;
      $('uploadCount').textContent = uploadCount;
      if ($('imgCountMobile')) $('imgCountMobile').textContent = imgCount;
      if ($('uploadCountMobile')) $('uploadCountMobile').textContent = uploadCount;
      if ($('btnReorderMobile')) $('btnReorderMobile').disabled = !p || !(p.images || []).length;
      const repairBtn = $('btnRepairPick');
      if (repairBtn) {
        repairBtn.disabled = !p;
        repairBtn.textContent = repairCount === '0' ? 'Ø±ÙØ¹ Ø§Ù„ØµÙˆØ± Ø§Ù„Ù†Ø§Ù‚ØµØ©' : `Ø±ÙØ¹ Ø§Ù„ØµÙˆØ± Ø§Ù„Ù†Ø§Ù‚ØµØ© (${repairCount})`;
      }
    }

    function setStatus(text, kind) {
      const box = $('statusBox');
      box.textContent = text;
      box.classList.remove('danger', 'ok');
      if (kind === 'danger') box.classList.add('danger');
      if (kind === 'ok') box.classList.add('ok');
    }

    try {
      window.addEventListener('error', (ev) => {
        try {
          const msg = ev && ev.message ? String(ev.message) : 'JS Error';
          setStatus(`Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØµÙØ­Ø©: ${msg}`, 'danger');
        } catch (e) {}
      });
      window.addEventListener('unhandledrejection', (ev) => {
        try {
          const r = ev && ev.reason ? ev.reason : null;
          const msg = (r && r.message) ? String(r.message) : String(r || 'Promise rejection');
          setStatus(`Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹: ${msg}`, 'danger');
        } catch (e) {}
      });
    } catch (e) {}

    function setProgress(current, total) {
      const wrap = $('progressWrap');
      const bar = $('progressBar');
      const text = $('progressText');
      const pct = total ? Math.max(0, Math.min(100, Math.round((current / total) * 100))) : 0;
      wrap.classList.remove('hidden');
      bar.style.width = `${pct}%`;
      text.textContent = `${pct}% (${current}/${total})`;
    }

    function clearProgress() {
      const wrap = $('progressWrap');
      const bar = $('progressBar');
      const text = $('progressText');
      wrap.classList.add('hidden');
      bar.style.width = '0%';
      text.textContent = '0%';
    }

    function formatError(e) {
      if (!e) return 'Unknown error';
      if (typeof e === 'string') return e;
      const msg = e && e.message ? String(e.message) : String(e);
      const status = e && e.status ? ` (HTTP ${e.status})` : '';
      return `${msg}${status}`;
    }

    function handleError(userPrefix, e) {
      try { console.error(userPrefix, e); } catch (_) {}
      setStatus(`${userPrefix}: ${formatError(e)}`, 'danger');
    }

    function isNotFoundError(e) {
      try {
        if (!e) return false;
        if (e.status === 404) return true;
        const msg = String(e && e.message ? e.message : e).toLowerCase();
        return msg.includes('not found') || msg.includes('404');
      } catch (_) {
        return false;
      }
    }

    function downloadText(filename, content) {
      const blob = new Blob([content], { type: 'application/json;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    // ====== RENDER ======
    function renderProjects() {
      const list = $('projectList');
      list.innerHTML = '';
      const q = String(state.projectSearch || '').trim().toLowerCase();
      const projects = (state.data.projects || [])
        .slice()
        .filter((p) => {
          if (!q) return true;
          const t = String(getProjectTitle(p) || '').toLowerCase();
          const s = String(p && p.slug ? p.slug : '').toLowerCase();
          return t.includes(q) || s.includes(q);
        })
        .sort((a,b) => String(getProjectTitle(a)).localeCompare(String(getProjectTitle(b))));

      const frag = document.createDocumentFragment();
      for (const p of projects) {
        const div = document.createElement('div');
        div.className = 'project-card' + (p.slug === state.selectedSlug ? ' active' : '');
        const cover = (p && p.cover) ? String(p.cover) : ((p && Array.isArray(p.images) && p.images[0]) ? String(p.images[0]) : '');
        const count = (p && Array.isArray(p.images)) ? p.images.length : 0;
        div.innerHTML = `
          <div class="thumb">${cover ? `<img src="${cover.replace(/"/g,'&quot;')}" alt="" loading="lazy" decoding="async" />` : ''}</div>
          <div class="count">${count}</div>
          <div class="overlay"></div>
        `;
        div.querySelector('.overlay').textContent = getProjectTitle(p);
        div.addEventListener('click', () => selectProject(p.slug));
        frag.appendChild(div);
      }

      list.appendChild(frag);

      updateCounts();
    }

    function renderExistingImages() {
      const wrap = $('existingImages');
      wrap.innerHTML = '';
      const p = state.selectedSlug ? getProjectBySlug(state.selectedSlug) : null;
      const imgs = p && Array.isArray(p.images) ? p.images : [];

      const limit = Number(state.existingLimit || 0);
      const max = (!limit || Number.isNaN(limit) || limit <= 0) ? imgs.length : Math.min(imgs.length, limit);

      const frag = document.createDocumentFragment();

      for (let idx = 0; idx < max; idx++) {
        const path = imgs[idx];
        const originalPath = path;
        const currentFile = String(path).split('/').pop() || '';
        const currentDir = String(path).split('/').slice(0, -1).join('/');
        const card = document.createElement('div');
        card.className = 'img-card';
        card.draggable = true;
        card.dataset.idx = String(idx);
        card.innerHTML = `
          <div class="thumb"></div>
          <div class="img-badge">${idx === 0 ? 'ØºÙ„Ø§Ù' : String(idx + 1)}</div>
          <div class="img-filename">${currentFile.replace(/\"/g,'&quot;')}</div>
          <div class="img-actions">
            <button class="img-action-btn" data-act="edit" type="button" aria-label="ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø³Ù…">âœ</button>
            <button class="img-action-btn danger" data-act="delete" type="button" aria-label="Ø­Ø°Ù">Ã—</button>
          </div>
          <div class="body">
            <div class="col">
              <label>Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù (ØªØºÙŠÙŠØ± Ø§Ù„Ø§Ø³Ù… ÙŠØ­Ø¯Ù‘Ø« JSON ÙÙ‚Ø·)</label>
              <input type="text" value="${currentFile.replace(/\"/g,'&quot;')}" />
            </div>
            <div class="flags">
              <span class="btn small" style="cursor:grab; user-select:none;">Ø§Ø³Ø­Ø¨ Ù„ØªØ±ØªÙŠØ¨</span>
              <button class="btn small" data-act="close" type="button">Ø¥ØºÙ„Ø§Ù‚</button>
            </div>
          </div>
        `;

        const thumb = card.querySelector('.thumb');
        const img = document.createElement('img');
        img.src = path;
        img.alt = '';
        img.loading = 'lazy';
        img.decoding = 'async';
        thumb.appendChild(img);

        const nameInput = card.querySelector('input');
        const filenameBadge = card.querySelector('.img-filename');
        nameInput.addEventListener('input', (e) => {
          const newName = sanitizeFilename(e.target.value);
          try {
            e.target.value = newName;
            if (filenameBadge) filenameBadge.textContent = newName;
          } catch (e) {}
          const newPath = (currentDir ? `${currentDir}/${newName}` : newName);
          const fromPath = originalPath;
          if (!newPath || newPath === fromPath) {
            state.renameMap.delete(fromPath);
            return;
          }

          imgs[idx] = newPath;
          state.renameMap.set(fromPath, newPath);

          // if it was marked delete, move mark to new path
          if (state.deleteSet.has(fromPath)) {
            state.deleteSet.delete(fromPath);
            state.deleteSet.add(newPath);
          }
        });

        card.querySelector('[data-act="edit"]').addEventListener('click', (e) => {
          e.preventDefault();
          card.classList.toggle('open');
          try { if (card.classList.contains('open')) nameInput.focus(); } catch (e) {}
        });
        card.querySelector('[data-act="close"]').addEventListener('click', (e) => {
          e.preventDefault();
          card.classList.remove('open');
        });
        card.querySelector('[data-act="delete"]').addEventListener('click', async () => {
          await deleteImage(imgs[idx]);
        });

        card.addEventListener('dragstart', () => {
          state.dragExistingIndex = idx;
          try { card.style.opacity = '0.6'; } catch (e) {}
        });
        card.addEventListener('dragend', () => {
          state.dragExistingIndex = null;
          try { card.style.opacity = '1'; } catch (e) {}
        });
        card.addEventListener('dragover', (ev) => {
          ev.preventDefault();
        });
        card.addEventListener('drop', (ev) => {
          ev.preventDefault();
          if (state.dragExistingIndex === null || state.dragExistingIndex === idx) return;
          reorderExisting(state.dragExistingIndex, idx);
          state.dragExistingIndex = null;
          renderExistingImages();
        });

        frag.appendChild(card);
      }

      wrap.appendChild(frag);

      updateCounts();
    }

    function renderUploadPreview() {
      const wrap = $('uploadPreview');
      wrap.innerHTML = '';

      const frag = document.createDocumentFragment();
      state.uploads.forEach((u, idx) => {
        const card = document.createElement('div');
        card.className = 'img-card';
        card.dataset.uploadIdx = String(idx);
        card.innerHTML = `
          <div class="thumb"><img src="${u.previewUrl}" alt="" /></div>
          <div class="img-badge">${String(idx + 1)}</div>
          <div class="img-filename">${String(u.name || '').replace(/\"/g,'&quot;')}</div>
          <div class="img-actions">
            <button class="img-action-btn" data-act="edit" type="button" aria-label="ØªØ¹Ø¯ÙŠÙ„">âœ</button>
            <button class="img-action-btn small" data-act="up" type="button" aria-label="Ø£Ø¹Ù„Ù‰">â†‘</button>
            <button class="img-action-btn small" data-act="down" type="button" aria-label="Ø£Ø³ÙÙ„">â†“</button>
            <button class="img-action-btn danger" data-act="remove" type="button" aria-label="Ø­Ø°Ù">Ã—</button>
          </div>
          <div class="body">
            <div class="col">
              <label>Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù</label>
              <input type="text" value="${u.name.replace(/\"/g,'&quot;')}" />
            </div>
            <div class="col">
              <label>Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</label>
              <input type="text" value="${String(u.targetPath || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯ Ø¨Ø¹Ø¯ (Ø§Ø¶ØºØ· Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØµÙˆØ± Ù„Ù„Ù…Ø´Ø±ÙˆØ¹)').replace(/\"/g,'&quot;')}" disabled />
            </div>
            <div class="flags">
              <button class="btn small" data-act="close" type="button">Ø¥ØºÙ„Ø§Ù‚</button>
              <span class="pill" style="justify-content:center;">Ø§Ø³Ø­Ø¨/Ø±ØªÙ‘Ø¨ Ù…Ù† Ø§Ù„Ø£Ø³Ù‡Ù…</span>
            </div>
          </div>
        `;

        const input = card.querySelector('input');
        const filenameBadge = card.querySelector('.img-filename');
        input.addEventListener('input', (e) => {
          const newName = sanitizeFilename(e.target.value);
          state.uploads[idx].name = newName;
          try {
            e.target.value = newName;
            if (filenameBadge) filenameBadge.textContent = newName;
          } catch (e) {}

          // If already applied to project, keep JSON + targetPath in sync
          const applied = state.uploads[idx].appliedPath;
          const target = state.uploads[idx].targetPath;
          if (applied && target) {
            const dir = String(target).split('/').slice(0, -1).join('/');
            const newPath = dir ? `${dir}/${newName}` : newName;

            // Update the correct project's images array (do not rely on selected project)
            const p = findProjectByImagePath(applied);
            if (p && Array.isArray(p.images)) {
              const ix = p.images.indexOf(applied);
              if (ix !== -1) {
                p.images[ix] = newPath;
                p.cover = p.images[0] || '';
                p.imageCount = p.images.length;
              }
            }

            state.uploads[idx].targetPath = newPath;
            state.uploads[idx].appliedPath = newPath;
            try {
              const targetInput = card.querySelectorAll('input')[1];
              if (targetInput) targetInput.value = newPath;
            } catch (e) {}
          }
        });

        card.querySelector('[data-act="edit"]').addEventListener('click', (e) => {
          e.preventDefault();
          card.classList.toggle('open');
          try { if (card.classList.contains('open')) input.focus(); } catch (e) {}
        });
        card.querySelector('[data-act="close"]').addEventListener('click', (e) => {
          e.preventDefault();
          card.classList.remove('open');
        });

        card.querySelector('[data-act="up"]').addEventListener('click', (e) => {
          e.preventDefault();
          moveUpload(idx, -1);
        });
        card.querySelector('[data-act="down"]').addEventListener('click', (e) => {
          e.preventDefault();
          moveUpload(idx, 1);
        });
        card.querySelector('[data-act="remove"]').addEventListener('click', (e) => {
          e.preventDefault();
          removeUpload(idx);
        });

        frag.appendChild(card);
      });

      wrap.appendChild(frag);

      updateCounts();
    }

    function refreshUI() {
      renderProjects();
      renderExistingImages();
      renderUploadPreview();
      updateActionsEnabled();
    }

    function onPickRepairFiles(files) {
      const p = state.selectedSlug ? getProjectBySlug(state.selectedSlug) : null;
      if (!p) return;
      const picked = Array.from(files || []);
      if (!picked.length) return;

      const baseDir = `assets/site_images/projects/portfolio_projects/${p.slug}`;

      // Map by exact filename (case-sensitive) because GitHub paths are case-sensitive
      const byName = new Map();
      for (const f of picked) {
        if (!f || !f.name) continue;
        byName.set(String(f.name), f);
      }

      // Build repair ops for any selected file (upload to expected project folder)
      state.repairs = Array.from(byName.entries()).map(([name, file]) => ({
        file,
        optimizedFile: null,
        name,
        targetPath: `${baseDir}/${name}`,
        projectSlug: p.slug
      }));

      // Optimize large repair images immediately so publish is reliable
      const pending = state.repairs.filter(r => r && r.file && !r.optimizedFile && r.file.size > 950 * 1024);
      if (pending.length) {
        (async () => {
          try {
            for (let i = 0; i < pending.length; i++) {
              const r = pending[i];
              setStatus(`Ø¶ØºØ· ØµÙˆØ±Ø© Ù†Ø§Ù‚ØµØ© ${i + 1}/${pending.length}: ${sanitizeFilename(r.file.name)}`, '');
              setProgress(i + 1, pending.length);
              const resOpt = await optimizeImageFile(r.file, { maxBytes: 950 * 1024, maxDim: 2200, preferWebp: true });
              if (resOpt && resOpt.file && resOpt.changed) r.optimizedFile = resOpt.file;
            }
          } catch (e) {
            handleError('ÙØ´Ù„ Ø¶ØºØ· Ø¨Ø¹Ø¶ Ø§Ù„ØµÙˆØ± Ø§Ù„Ù†Ø§Ù‚ØµØ© (Ø³ÙŠØªÙ… Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø±ÙØ¹ ÙƒÙ…Ø§ Ù‡ÙŠ)', e);
          } finally {
            clearProgress();
            setStatus('ØªÙ… ØªØ¬Ù‡ÙŠØ² Ø§Ù„ØµÙˆØ± Ø§Ù„Ù†Ø§Ù‚ØµØ© Ù„Ù„Ø±ÙØ¹. Ø§Ø¶ØºØ· "Ù†Ø´Ø± Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª".', 'ok');
            updateCounts();
          }
        })();
      } else {
        setStatus('ØªÙ… ØªØ¬Ù‡ÙŠØ² Ø§Ù„ØµÙˆØ± Ø§Ù„Ù†Ø§Ù‚ØµØ© Ù„Ù„Ø±ÙØ¹. Ø§Ø¶ØºØ· "Ù†Ø´Ø± Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª".', 'ok');
      }

      updateCounts();
    }

    // ====== ACTIONS ======
    function selectProject(slug) {
      state.selectedSlug = slug;
      state.deleteSet.clear();
      state.uploads.forEach(u => URL.revokeObjectURL(u.previewUrl));
      state.uploads = [];
      state.repairs = [];

      const p = getProjectBySlug(slug);
      $('selectedTitle').textContent = p ? getProjectTitle(p) : 'Ø§Ø®ØªØ± Ù…Ø´Ø±ÙˆØ¹';
      if ($('selectedTitleMobile')) $('selectedTitleMobile').textContent = p ? getProjectTitle(p) : 'Ø§Ø®ØªØ± Ù…Ø´Ø±ÙˆØ¹';
      if ($('editTitleAr')) $('editTitleAr').value = p ? (p.titleAr || '') : '';
      if ($('editTitleEn')) $('editTitleEn').value = p ? (p.titleEn || '') : '';
      refreshUI();
    }

    function updateActionsEnabled() {
      const hasProject = !!state.selectedSlug && !!getProjectBySlug(state.selectedSlug);
      $('btnDeleteProject').disabled = !hasProject;
      $('imagePicker').disabled = !hasProject;
      $('btnAutoNames').disabled = !hasProject || state.uploads.length === 0;
      $('btnApplyUploads').disabled = !hasProject || state.uploads.length === 0;
      if ($('btnRepairPick')) $('btnRepairPick').disabled = !hasProject;
      if ($('btnReorder')) $('btnReorder').disabled = !hasProject;
      if ($('editTitleAr')) $('editTitleAr').disabled = !hasProject;
      if ($('editTitleEn')) $('editTitleEn').disabled = !hasProject;
      if ($('btnSaveProjectTitles')) $('btnSaveProjectTitles').disabled = !hasProject;

      const canExport = !!(state.data && Array.isArray(state.data.projects));
      $('btnExportJson').disabled = !canExport;
      $('btnPublish').disabled = !canExport;
      if ($('btnSync')) $('btnSync').disabled = !canExport;
      if ($('btnOneClickPublish')) $('btnOneClickPublish').disabled = !canExport;
    }

    function openReorderModal() {
      const p = state.selectedSlug ? getProjectBySlug(state.selectedSlug) : null;
      if (!p || !Array.isArray(p.images) || !p.images.length) {
        alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØµÙˆØ± Ù„ØªØ±ØªÙŠØ¨Ù‡Ø§');
        return;
      }
      state.reorderDraft = p.images.slice();
      $('reorderModal').classList.remove('hidden');
      renderReorderList();
    }

    function closeReorderModal() {
      $('reorderModal').classList.add('hidden');
      state.reorderDraft = null;
    }

    function autoSortReorderDraft() {
      if (!Array.isArray(state.reorderDraft)) return;
      const collator = new Intl.Collator(undefined, { numeric: true, sensitivity: 'base' });
      state.reorderDraft.sort((a, b) => {
        const aa = String(a).split('/').pop() || '';
        const bb = String(b).split('/').pop() || '';
        return collator.compare(aa, bb);
      });
      renderReorderList();
    }

    function renderReorderList() {
      const list = $('reorderList');
      list.innerHTML = '';
      const draft = Array.isArray(state.reorderDraft) ? state.reorderDraft : [];
      let dragIndex = null;

      for (let i = 0; i < draft.length; i++) {
        const path = draft[i];
        const file = String(path).split('/').pop() || '';
        const card = document.createElement('div');
        card.className = 'reorder-item';
        card.draggable = true;
        card.dataset.idx = String(i);
        card.innerHTML = `
          <div class="thumb"><img src="${path}" alt="" loading="lazy" decoding="async" /></div>
          <div class="info">
            <div class="row" style="justify-content:space-between; align-items:center;">
              <span class="pill">${i === 0 ? 'ØºÙ„Ø§Ù' : String(i + 1)}</span>
              <span class="handle" title="Ø§Ø³Ø­Ø¨">â‡…</span>
            </div>
            <div class="notice" style="margin:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${file}</div>
          </div>
        `;

        card.addEventListener('dragstart', (ev) => {
          dragIndex = i;
          card.classList.add('dragging');
          try { ev.dataTransfer.effectAllowed = 'move'; } catch (e) {}
        });
        card.addEventListener('dragend', () => {
          dragIndex = null;
          card.classList.remove('dragging');
        });
        card.addEventListener('dragover', (ev) => {
          ev.preventDefault();
          try { ev.dataTransfer.dropEffect = 'move'; } catch (e) {}
        });
        card.addEventListener('drop', (ev) => {
          ev.preventDefault();
          const toIndex = parseInt(card.dataset.idx, 10);
          if (dragIndex === null || Number.isNaN(toIndex) || dragIndex === toIndex) return;
          const arr = state.reorderDraft;
          const [moved] = arr.splice(dragIndex, 1);
          arr.splice(toIndex, 0, moved);
          renderReorderList();
        });

        list.appendChild(card);
      }
    }

    function saveReorderDraft() {
      const p = state.selectedSlug ? getProjectBySlug(state.selectedSlug) : null;
      if (!p || !Array.isArray(state.reorderDraft) || !state.reorderDraft.length) return;
      p.images = state.reorderDraft.slice();
      p.cover = p.images[0] || '';
      p.imageCount = p.images.length;
      closeReorderModal();
      refreshUI();
      setStatus('ØªÙ… Ø­ÙØ¸ ØªØ±ØªÙŠØ¨ Ø§Ù„ØµÙˆØ± Ù…Ø­Ù„ÙŠÙ‹Ø§. Ø§Ø¶ØºØ· "Ø­ÙØ¸ + Ø±ÙØ¹ Ø¹Ù„Ù‰ GitHub" Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆÙ‚Ø¹.', 'ok');
    }

    async function syncNow() {
      const token = $('ghToken').value.trim();
      if (!token) {
        alert('Ø§Ù„ØµÙ‚ GitHub Token');
        return;
      }
      const pendingNoTarget = state.uploads.filter(u => !!u && !!u.file && !u.targetPath);
      if (pendingNoTarget.length) applyUploadsToProject();
      await publish();
    }

    function saveProjectTitles() {
      const p = state.selectedSlug ? getProjectBySlug(state.selectedSlug) : null;
      if (!p) return;
      const ar = String($('editTitleAr').value || '').trim();
      const en = String($('editTitleEn').value || '').trim();
      p.titleAr = ar || null;
      p.titleEn = en || null;
      p.title = (en || ar || p.slug);
      $('selectedTitle').textContent = getProjectTitle(p);
      if ($('selectedTitleMobile')) $('selectedTitleMobile').textContent = getProjectTitle(p);
      renderProjects();
      setStatus('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø§Ø³Ù… Ù…Ø­Ù„ÙŠÙ‹Ø§. Ø§Ø¶ØºØ· "Ø­ÙØ¸ + Ø±ÙØ¹ Ø¹Ù„Ù‰ GitHub" Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆÙ‚Ø¹.', 'ok');
    }

    function tryLoadRememberedToken() {
      try {
        const t = localStorage.getItem(TOKEN_STORE_KEY);
        if (t && $('ghToken')) $('ghToken').value = t;
      } catch (e) {}
    }

    function rememberToken() {
      const token = $('ghToken').value.trim();
      if (!token) {
        alert('Ø§Ù„ØµÙ‚ Ø§Ù„ØªÙˆÙƒÙ† Ø£ÙˆÙ„Ø§Ù‹');
        return;
      }
      try {
        localStorage.setItem(TOKEN_STORE_KEY, token);
        setStatus('ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªÙˆÙƒÙ† Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø². (Ù„Ùˆ Ø§Ù„Ù…ØªØµÙØ­ ÙŠÙ…Ù†Ø¹ Ø§Ù„ØªØ®Ø²ÙŠÙ†ØŒ Ø³ÙŠÙØ·Ù„Ø¨ Ù…Ù†Ùƒ ÙƒÙ„ Ù…Ø±Ø©).', 'ok');
      } catch (e) {
        setStatus('Ø§Ù„Ù…ØªØµÙØ­ Ù…Ù†Ø¹ Ø­ÙØ¸ Ø§Ù„ØªÙˆÙƒÙ† Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø². Ø³ØªØ­ØªØ§Ø¬ Ù„ØµÙ‚Ù‡ ÙƒÙ„ Ù…Ø±Ø©.', 'danger');
      }
    }

    function addProject() {
      const titleAr = $('newTitleAr').value.trim();
      const titleEn = $('newTitleEn').value.trim();
      const slugInput = $('newSlug').value.trim();

      const base = slugInput || titleEn || titleAr;
      const slug = slugify(base);

      if (!titleAr && !titleEn) {
        alert('Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø¹Ø±Ø¨ÙŠ Ø£Ùˆ Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ.');
        return;
      }
      if ((state.data.projects || []).some(p => p.slug === slug)) {
        alert('Slug Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„. ØºÙŠÙ‘Ø± Ø§Ù„Ù€ slug.');
        return;
      }

      const proj = {
        slug,
        titleAr: titleAr || null,
        titleEn: titleEn || null,
        title: (titleEn || titleAr || slug),
        images: [],
        cover: '',
        imageCount: 0
      };

      state.data.projects.push(proj);
      state.data.count = state.data.projects.length;

      $('newTitleAr').value = '';
      $('newTitleEn').value = '';
      $('newSlug').value = '';

      selectProject(slug);
    }

    function deleteProject() {
      const p = state.selectedSlug ? getProjectBySlug(state.selectedSlug) : null;
      if (!p) return;

      const ok = confirm(`ØªØ£ÙƒÙŠØ¯ Ø­Ø°Ù Ø§Ù„Ù…Ø´Ø±ÙˆØ¹: ${getProjectTitle(p)} ØŸ`);
      if (!ok) return;

      // mark all images for deletion so you can export a delete list
      if (Array.isArray(p.images)) {
        for (const img of p.images) state.deleteSet.add(img);
      }

      state.data.projects = (state.data.projects || []).filter(x => x.slug !== p.slug);
      state.data.count = state.data.projects.length;
      state.selectedSlug = null;
      $('selectedTitle').textContent = 'Ø§Ø®ØªØ± Ù…Ø´Ø±ÙˆØ¹';

      refreshUI();
    }

    async function deleteImage(path) {
      const p = state.selectedSlug ? getProjectBySlug(state.selectedSlug) : null;
      if (!p || !Array.isArray(p.images)) return;

      const ok = confirm('ØªØ£ÙƒÙŠØ¯ Ø­Ø°Ù Ø§Ù„ØµÙˆØ±Ø© Ù†Ù‡Ø§Ø¦ÙŠÙ‹Ø§ Ù…Ù† Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ØŸ (Ø³ÙŠØªÙ… Ø­Ø°ÙÙ‡Ø§ Ù…Ù† GitHub Ø¹Ù†Ø¯ Ù†Ø´Ø± Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª)');
      if (!ok) return;

      const token = $('ghToken') ? $('ghToken').value.trim() : '';

      const prevImages = Array.isArray(p.images) ? p.images.slice() : [];
      const prevCover = p.cover;
      const prevCount = p.imageCount;
      const prevDeleteHad = state.deleteSet.has(path);

      // Remove from current project JSON immediately
      p.images = p.images.filter(x => x !== path);
      p.cover = (p.images || [])[0] || '';
      p.imageCount = (p.images || []).length;

      // Ensure it gets deleted on publish
      state.deleteSet.add(path);

      // If this path is involved in a pending rename, remove that plan and delete both sides just in case
      for (const [fromSite, toSite] of Array.from(state.renameMap.entries())) {
        if (fromSite === path || toSite === path) {
          state.deleteSet.add(fromSite);
          state.deleteSet.add(toSite);
          state.renameMap.delete(fromSite);
        }
      }

      renderExistingImages();
      renderProjects();
      updateCounts();

      if (!token) {
        setStatus('ØªÙ… Ø­Ø°Ù Ø§Ù„ØµÙˆØ±Ø© Ù…Ù† Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ù…Ø­Ù„ÙŠÙ‹Ø§. Ø§Ù„ØµÙ‚ GitHub Token Ø«Ù… Ø§Ø¶ØºØ· "Ù†Ø´Ø± Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª" Ù„Ù„Ø­Ø°Ù Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ù…Ù† GitHub.', 'ok');
        return;
      }

      const owner = GITHUB_OWNER;
      const repo = GITHUB_REPO;

      const branches = Array.isArray(GITHUB_PUBLISH_BRANCHES) && GITHUB_PUBLISH_BRANCHES.length
        ? GITHUB_PUBLISH_BRANCHES
        : [GITHUB_BRANCH];

      try {
        const repoPath = sitePathToRepoPath(path);
        const payload = {
          source: 'portfolio_projects',
          count: (state.data.projects || []).length,
          projects: state.data.projects
        };

        for (let bi = 0; bi < branches.length; bi++) {
          const branch = branches[bi];
          const gh = createGithubClient(owner, repo, branch, token);
          setStatus(`(${branch}) Ø­Ø°Ù Ù…Ù† GitHub: ${repoPath}`, '');
          setProgress(bi + 1, branches.length + 1);

          // Delete the file from repo (best effort)
          try {
            let meta;
            try {
              meta = await gh.getFileMeta(repoPath, branch, true);
            } catch (e) {
              const retryPath = sitePathToRepoPath(path);
              if (retryPath !== repoPath) {
                meta = await gh.getFileMeta(retryPath, branch, true);
              } else {
                throw e;
              }
            }
            if (meta && meta.sha) {
              await gh.deleteFile(repoPath, `Delete portfolio image: ${repoPath}`, meta.sha);
            }
          } catch (e) {
            // Ignore 404s per-branch
            if (!isNotFoundError(e)) {
              try { console.warn('delete failed', branch, repoPath, e); } catch (_) {}
            }
          }

          // Update JSON on that branch so deletion reflects immediately
          setStatus(`(${branch}) ØªØ­Ø¯ÙŠØ« data/portfolio_projects.json ...`, '');
          await putPortfolioProjectsJsonWithRetry(gh, payload, branch);
        }

        clearProgress();
        setStatus('ØªÙ… Ø­Ø°Ù Ø§Ù„ØµÙˆØ±Ø© Ù†Ù‡Ø§Ø¦ÙŠÙ‹Ø§ Ù…Ù† GitHub ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª âœ…', 'ok');
      } catch (e) {
        clearProgress();

        if (isNotFoundError(e)) {
          // The file is already missing on GitHub. Keep local deletion + JSON update as success.
          setStatus('Ø§Ù„ØµÙˆØ±Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¹Ù„Ù‰ GitHub (404) Ù„ÙƒÙ†Ù‡Ø§ Ø­ÙØ°ÙØª Ù…Ù† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ ÙˆØ³ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« JSON Ø¹Ù„Ù‰ GitHub âœ…', 'ok');
          return;
        }

        // For other errors, revert local state so there is no hidden/pending mismatch
        p.images = prevImages;
        p.cover = prevCover;
        p.imageCount = prevCount;
        if (!prevDeleteHad) state.deleteSet.delete(path);
        refreshUI();
        handleError('ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„ØµÙˆØ±Ø© Ù…Ù† GitHub', e);
      }
    }

    function moveExisting(index, delta) {
      const p = state.selectedSlug ? getProjectBySlug(state.selectedSlug) : null;
      if (!p || !Array.isArray(p.images)) return;
      const next = index + delta;
      if (next < 0 || next >= p.images.length) return;
      const arr = p.images;
      const tmp = arr[index];
      arr[index] = arr[next];
      arr[next] = tmp;
      p.cover = arr[0] || '';
      p.imageCount = arr.length;
      renderExistingImages();
    }

    function reorderExisting(fromIndex, toIndex) {
      const p = state.selectedSlug ? getProjectBySlug(state.selectedSlug) : null;
      if (!p || !Array.isArray(p.images)) return;
      const arr = p.images;
      if (fromIndex < 0 || fromIndex >= arr.length) return;
      if (toIndex < 0 || toIndex >= arr.length) return;
      const [item] = arr.splice(fromIndex, 1);
      arr.splice(toIndex, 0, item);
      p.cover = arr[0] || '';
      p.imageCount = arr.length;
    }

    function onPickFiles(files) {
      const picked = Array.from(files || []);
      if (!picked.length) return;

      for (const f of picked) {
        const url = URL.createObjectURL(f);
        state.uploads.push({ file: f, optimizedFile: null, previewUrl: url, name: sanitizeFilename(f.name), targetPath: null, appliedPath: null, projectSlug: null });
      }

      renderUploadPreview();
      updateActionsEnabled();
    }

    function moveUpload(index, delta) {
      const next = index + delta;
      if (next < 0 || next >= state.uploads.length) return;
      const tmp = state.uploads[index];
      state.uploads[index] = state.uploads[next];
      state.uploads[next] = tmp;
      renderUploadPreview();
    }

    function removeUpload(index) {
      const u = state.uploads[index];
      if (u) URL.revokeObjectURL(u.previewUrl);
      state.uploads.splice(index, 1);
      renderUploadPreview();
      updateActionsEnabled();
    }

    function autoNameUploads() {
      const p = state.selectedSlug ? getProjectBySlug(state.selectedSlug) : null;
      if (!p) return;

      const extFrom = (fileName) => {
        const dot = fileName.lastIndexOf('.');
        return dot !== -1 ? fileName.slice(dot).toLowerCase() : '.jpg';
      };

      let start = 1;
      if (Array.isArray(p.images) && p.images.length) {
        // find max number in existing filenames for this slug
        const rx = new RegExp(`${p.slug}-?(\\d{3,})`, 'i');
        for (const img of p.images) {
          const file = String(img).split('/').pop() || '';
          const m = file.match(rx);
          if (m && m[1]) {
            const n = parseInt(m[1], 10);
            if (!Number.isNaN(n)) start = Math.max(start, n + 1);
          }
        }
      }

      for (let i = 0; i < state.uploads.length; i++) {
        const u = state.uploads[i];
        const ext = extFrom(u.name || u.file.name);
        const num = String(start + i).padStart(3, '0');
        state.uploads[i].name = sanitizeFilename(`${p.slug}-${num}${ext}`);
      }

      renderUploadPreview();
    }

    function applyUploadsToProject() {
      const p = state.selectedSlug ? getProjectBySlug(state.selectedSlug) : null;
      if (!p) return;

      const baseDir = `assets/site_images/projects/portfolio_projects/${p.slug}`;

      // Optimize large images before binding them to the project so publish is reliable
      try {
        const pendingToOptimize = state.uploads.filter(u => !!u && !!u.file && !u.optimizedFile && u.file.size > 950 * 1024);
        if (pendingToOptimize.length) {
          setStatus(`Ø¶ØºØ· Ø§Ù„ØµÙˆØ± Ø§Ù„ÙƒØ¨ÙŠØ±Ø©... (${pendingToOptimize.length})`, '');
        }
      } catch (e) {}

      const pendingUploadsForOptimize = state.uploads.filter(u => !!u && !!u.file && !u.optimizedFile && u.file.size > 950 * 1024);
      if (pendingUploadsForOptimize.length) {
        (async () => {
          try {
            for (let i = 0; i < pendingUploadsForOptimize.length; i++) {
              const u = pendingUploadsForOptimize[i];
              setStatus(`Ø¶ØºØ· ØµÙˆØ±Ø© ${i + 1}/${pendingUploadsForOptimize.length}: ${sanitizeFilename(u.file.name)}`, '');
              setProgress(i + 1, pendingUploadsForOptimize.length);
              const resOpt = await optimizeImageFile(u.file, { maxBytes: 950 * 1024, maxDim: 2200, preferWebp: true });
              if (resOpt && resOpt.file && resOpt.changed) {
                u.optimizedFile = resOpt.file;
              }
            }
          } catch (e) {
            handleError('ÙØ´Ù„ Ø¶ØºØ· Ø¨Ø¹Ø¶ Ø§Ù„ØµÙˆØ± (Ø³ÙŠØªÙ… Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø±ÙØ¹ ÙƒÙ…Ø§ Ù‡ÙŠ)', e);
          } finally {
            clearProgress();
            // continue applying after optimization
            applyUploadsToProject();
          }
        })();
        return;
      }

      const used = new Set((p.images || []).map(x => String(x).split('/').pop() || ''));
      const pendingUploads = state.uploads.filter(u => !!u && !!u.file && !u.targetPath);
      for (const u of pendingUploads) {
        let fileName = sanitizeFilename(u.name);
        if (!fileName) fileName = sanitizeFilename(u.file.name);

        // keep name in sync if we already optimized and the extension changed
        try {
          const opt = u.optimizedFile;
          if (opt && opt.name) {
            const optExt = (String(opt.name).match(/\.[a-z0-9]+$/i) || [''])[0];
            if (optExt) {
              fileName = String(fileName).replace(/\.[a-z0-9]+$/i, '') + optExt.toLowerCase();
              u.name = fileName;
            }
          }
        } catch (e) {}
        // ensure unique
        if (used.has(fileName)) {
          const dot = fileName.lastIndexOf('.');
          const ext = dot !== -1 ? fileName.slice(dot) : '';
          const stem = dot !== -1 ? fileName.slice(0, dot) : fileName;
          let k = 2;
          while (used.has(`${stem}-${k}${ext}`)) k++;
          fileName = `${stem}-${k}${ext}`;
        }
        used.add(fileName);
        const relPath = `${baseDir}/${fileName}`;
        p.images = Array.isArray(p.images) ? p.images : [];
        p.images.push(relPath);

        // bind upload to its final target path so publish doesn't depend on current selection
        u.targetPath = relPath;
        u.appliedPath = relPath;
        u.projectSlug = p.slug;
      }
      p.cover = (p.images || [])[0] || '';
      p.imageCount = (p.images || []).length;

      setStatus('ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØµÙˆØ± Ù„Ù„Ù…Ø´Ø±ÙˆØ¹. Ø§Ù„Ø¢Ù† Ø§Ø¶ØºØ· "Ù†Ø´Ø± Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª" Ù„Ø±ÙØ¹ Ø§Ù„ØµÙˆØ± ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù„Ù‰ GitHub.', 'ok');
      refreshUI();
    }

    function exportJson() {
      const payload = {
        source: 'portfolio_projects',
        count: (state.data.projects || []).length,
        projects: state.data.projects
      };
      downloadText('portfolio_projects.json', JSON.stringify(payload, null, 2));
    }

    function createGithubClient(owner, repo, branch, token) {
      const headers = () => ({
        'Accept': 'application/vnd.github+json',
        'Authorization': `Bearer ${token}`
      });

      const contentsUrl = (path, ref, bustCache) => {
        const enc = encodeURIComponent(path).replace(/%2F/g, '/');
        const qs = [];
        if (ref) qs.push(`ref=${encodeURIComponent(ref)}`);
        if (bustCache) qs.push(`ts=${Date.now()}`);
        return `https://api.github.com/repos/${owner}/${repo}/contents/${enc}` + (qs.length ? `?${qs.join('&')}` : '');
      };

      const requestJson = async (url, method, payload) => {
        const res = await fetch(url, {
          method,
          cache: 'no-store',
          headers: payload ? { ...headers(), 'Content-Type': 'application/json' } : headers(),
          body: payload ? JSON.stringify(payload) : undefined
        });
        const text = await res.text();
        let body = null;
        try { body = text ? JSON.parse(text) : null; } catch (e) {}
        if (!res.ok) {
          const msg = body && body.message ? body.message : text;
          const err = new Error(msg || `GitHub error: ${res.status}`);
          err.status = res.status;
          err.body = body;
          throw err;
        }
        return body;
      };

      const getFileMeta = (path, ref, bustCache) => requestJson(contentsUrl(path, ref, bustCache), 'GET');
      const putFile = (path, message, contentBase64, sha) => requestJson(contentsUrl(path, null), 'PUT', { message, content: contentBase64, branch, sha });
      const deleteFile = (path, message, sha) => requestJson(contentsUrl(path, null), 'DELETE', { message, branch, sha });
      const downloadToBase64 = async (downloadUrl) => {
        if (!downloadUrl) throw new Error('Missing download_url');
        const res = await fetch(downloadUrl, { headers: headers() });
        if (!res.ok) throw new Error(`Download failed: ${res.status}`);
        const buf = await res.arrayBuffer();
        return arrayBufferToBase64(buf);
      };

      return { getFileMeta, putFile, deleteFile, downloadToBase64 };
    }

    function delay(ms) {
      return new Promise((resolve) => setTimeout(resolve, ms));
    }

    function arrayBufferToBase64(buffer) {
      let binary = '';
      const bytes = new Uint8Array(buffer);
      for (let i = 0; i < bytes.byteLength; i++) binary += String.fromCharCode(bytes[i]);
      return btoa(binary);
    }

    async function fileToBase64(file) {
      const buf = await file.arrayBuffer();
      return arrayBufferToBase64(buf);
    }

    async function optimizeImageFile(file, options) {
      const opts = options || {};
      const maxBytes = typeof opts.maxBytes === 'number' ? opts.maxBytes : 950 * 1024;
      const maxDim = typeof opts.maxDim === 'number' ? opts.maxDim : 2200;
      const preferWebp = opts.preferWebp !== false;

      if (!file) return { file: null, changed: false, note: 'missing file' };
      const type = String(file.type || '').toLowerCase();
      const isImage = type.startsWith('image/');
      if (!isImage) return { file, changed: false, note: 'not image' };
      if (file.size <= maxBytes) return { file, changed: false, note: 'already small' };

      let imgBitmap = null;
      try {
        imgBitmap = await createImageBitmap(file);
      } catch (e) {
        return { file, changed: false, note: 'decode failed' };
      }

      let w = imgBitmap.width || 1;
      let h = imgBitmap.height || 1;
      const scale = Math.min(1, maxDim / Math.max(w, h));
      const tw = Math.max(1, Math.round(w * scale));
      const th = Math.max(1, Math.round(h * scale));

      const canvas = document.createElement('canvas');
      canvas.width = tw;
      canvas.height = th;
      const ctx = canvas.getContext('2d', { alpha: false });
      ctx.drawImage(imgBitmap, 0, 0, tw, th);

      const mimeCandidates = [];
      if (preferWebp) mimeCandidates.push('image/webp');
      mimeCandidates.push('image/jpeg');

      let outBlob = null;
      let outType = null;
      let quality = 0.85;

      for (const mime of mimeCandidates) {
        quality = 0.85;
        for (let i = 0; i < 7; i++) {
          try {
            outBlob = await new Promise((resolve) => canvas.toBlob(resolve, mime, quality));
          } catch (e) {
            outBlob = null;
          }
          outType = mime;
          if (outBlob && outBlob.size <= maxBytes) break;
          quality = Math.max(0.55, quality - 0.07);
        }
        if (outBlob && outBlob.size <= maxBytes) break;
      }

      if (!outBlob) return { file, changed: false, note: 'encode failed' };
      if (outBlob.size > maxBytes) return { file, changed: false, note: 'still too big' };

      let baseName = sanitizeFilename(String(file.name || 'image'));
      baseName = baseName.replace(/\.[a-z0-9]+$/i, '');
      const ext = outType === 'image/webp' ? '.webp' : '.jpg';
      const outName = `${baseName}${ext}`;
      const outFile = new File([outBlob], outName, { type: outType });
      return { file: outFile, changed: true, note: 'optimized' };
    }

    async function ghDownloadToBase64(downloadUrl, token) {
      if (!downloadUrl) throw new Error('Missing download_url');
      const res = await fetch(downloadUrl, { headers: { 'Accept': 'application/vnd.github+json', 'Authorization': `Bearer ${token}` } });
      if (!res.ok) throw new Error(`Download failed: ${res.status}`);
      const buf = await res.arrayBuffer();
      return arrayBufferToBase64(buf);
    }

    function utf8ToBase64(str) {
      return btoa(unescape(encodeURIComponent(str)));
    }

    function sitePathToRepoPath(sitePath) {
      let p = String(sitePath || '').trim();
      if (!p) return '';

      // If an absolute URL is stored, convert it to a repo-relative path
      if (/^https?:\/\//i.test(p)) {
        try {
          const u = new URL(p);
          p = u.pathname || '';
        } catch (e) {}
      }

      // strip query/hash (cache busting)
      p = p.split('#')[0];
      p = p.split('?')[0];

      // normalize common prefixes
      p = p.replace(/^\.\//, '');
      p = p.replace(/^\//, '');

      return p;
    }

    async function putPortfolioProjectsJsonWithRetry(gh, payload, branch) {
      const jsonPath = 'data/portfolio_projects.json';
      const jsonB64 = utf8ToBase64(JSON.stringify(payload, null, 2));

      for (let attempt = 1; attempt <= 6; attempt++) {
        try {
          let jsonSha = undefined;
          try {
            const meta = await gh.getFileMeta(jsonPath, branch, true);
            if (meta && meta.sha) jsonSha = meta.sha;
          } catch (e) {}

          await gh.putFile(jsonPath, 'Update portfolio projects data', jsonB64, jsonSha);
          return;
        } catch (e) {
          const msg = String(e && e.message ? e.message : e);
          const isShaMismatch = msg.toLowerCase().includes('does not match') || msg.toLowerCase().includes('sha') || e.status === 409;
          if (!isShaMismatch || attempt === 6) throw e;
          await delay(450 * attempt * attempt);
        }
      }
    }

    async function publish() {
      const token = $('ghToken').value.trim();
      if (!token) {
        alert('Ø§Ù„ØµÙ‚ GitHub Token');
        return;
      }

      const pendingNoTarget = state.uploads.filter(u => !!u && !!u.file && !u.targetPath);
      if (pendingNoTarget.length) {
        alert('ÙÙŠ ØµÙˆØ± ØªÙ… Ø§Ø®ØªÙŠØ§Ø±Ù‡Ø§ Ù…Ù† Ø§Ù„Ø¬Ù‡Ø§Ø² Ù„ÙƒÙ† Ù„Ù… ÙŠØªÙ… Ø¥Ø¶Ø§ÙØªÙ‡Ø§ Ù„Ù„Ù…Ø´Ø±ÙˆØ¹ Ø¨Ø¹Ø¯. Ø§Ø¶ØºØ· "Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØµÙˆØ± Ù„Ù„Ù…Ø´Ø±ÙˆØ¹" Ø£ÙˆÙ„Ø§Ù‹.');
        return;
      }

      try {
        const owner = GITHUB_OWNER;
        const repo = GITHUB_REPO;

        const payload = {
          source: 'portfolio_projects',
          count: (state.data.projects || []).length,
          projects: state.data.projects
        };

        const branches = Array.isArray(GITHUB_PUBLISH_BRANCHES) && GITHUB_PUBLISH_BRANCHES.length
          ? GITHUB_PUBLISH_BRANCHES
          : [GITHUB_BRANCH];

        for (let bi = 0; bi < branches.length; bi++) {
          const branch = branches[bi];
          const gh = createGithubClient(owner, repo, branch, token);
          setStatus(`Ø¨Ø¯Ø¡ Ø§Ù„Ù†Ø´Ø± Ø¹Ù„Ù‰ ${branch}... (Ù‚Ø¯ ÙŠØ£Ø®Ø° ÙˆÙ‚Øª Ø­Ø³Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„ØµÙˆØ±)`, '');
          clearProgress();

          // 1) Upload new files (bound to targetPath after "Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØµÙˆØ± Ù„Ù„Ù…Ø´Ø±ÙˆØ¹")
          const uploadOps = state.uploads.filter(u => !!u && !!u.file && !!u.targetPath)
            .concat((state.repairs || []).filter(r => !!r && !!r.file && !!r.targetPath));
          if (uploadOps.length) {
            for (let i = 0; i < uploadOps.length; i++) {
              const u = uploadOps[i];
              const repoPath = sitePathToRepoPath(u.targetPath);
              setStatus(`(${branch}) Ø±ÙØ¹ ØµÙˆØ±Ø© ${i + 1}/${uploadOps.length}: ${repoPath}`, '');
              setProgress(i + 1, uploadOps.length);

              let sha = undefined;
              try {
                const meta = await gh.getFileMeta(repoPath, branch);
                if (meta && meta.sha) sha = meta.sha;
              } catch (e) { try { console.warn('getFileMeta failed', repoPath, e); } catch (_) {} }

              let fileToSend = u.optimizedFile || u.file;
              try {
                if (!u.optimizedFile && u.file && u.file.size > 950 * 1024) {
                  const resOpt = await optimizeImageFile(u.file, { maxBytes: 950 * 1024, maxDim: 2200, preferWebp: true });
                  if (resOpt && resOpt.file && resOpt.changed) {
                    u.optimizedFile = resOpt.file;
                    fileToSend = u.optimizedFile;
                  }
                }
              } catch (e) {}

              const b64 = await fileToBase64(fileToSend);
              await gh.putFile(repoPath, `Update portfolio image: ${repoPath}`, b64, sha);
            }
          }

          // 2) Rename files (copy content to new path then delete old)
          const renames = Array.from(state.renameMap.entries());
          if (renames.length) {
            for (let i = 0; i < renames.length; i++) {
              const [fromSite, toSite] = renames[i];
              const fromPath = sitePathToRepoPath(fromSite);
              const toPath = sitePathToRepoPath(toSite);
              if (fromPath === toPath) continue;
              setStatus(`(${branch}) Ø¥Ø¹Ø§Ø¯Ø© ØªØ³Ù…ÙŠØ© ${i + 1}/${renames.length}: ${fromPath} -> ${toPath}`, '');
              setProgress(i + 1, renames.length);

              let fromMeta = null;
              try {
                fromMeta = await gh.getFileMeta(fromPath, branch);
              } catch (e) {
                continue;
              }
              if (!fromMeta || !fromMeta.sha) continue;

              let fromB64 = null;
              try {
                if (fromMeta.content && String(fromMeta.encoding || '').toLowerCase() === 'base64') {
                  fromB64 = String(fromMeta.content).replace(/\n/g, '');
                } else if (fromMeta.download_url) {
                  fromB64 = await ghDownloadToBase64(fromMeta.download_url, token);
                }
              } catch (e) {
                fromB64 = null;
              }
              if (!fromB64) continue;

              let toSha = undefined;
              try {
                const toMeta = await gh.getFileMeta(toPath, branch);
                if (toMeta && toMeta.sha) toSha = toMeta.sha;
              } catch (e) { try { console.warn('getFileMeta failed', toPath, e); } catch (_) {} }

              await gh.putFile(toPath, `Rename portfolio image: ${toPath}`, fromB64, toSha);
              try {
                await gh.deleteFile(fromPath, `Delete old portfolio image: ${fromPath}`, fromMeta.sha);
              } catch (e) {
                if (!isNotFoundError(e)) throw e;
              }
            }
          }

          // 3) Delete marked images
          const dels = Array.from(state.deleteSet.values()).map(sitePathToRepoPath);
          if (dels.length) {
            for (let i = 0; i < dels.length; i++) {
              const rp = dels[i];
              setStatus(`(${branch}) Ø­Ø°Ù ØµÙˆØ±Ø© ${i + 1}/${dels.length}: ${rp}`, '');
              setProgress(i + 1, dels.length);
              try {
                const meta = await gh.getFileMeta(rp, branch);
                if (meta && meta.sha) {
                  await gh.deleteFile(rp, `Delete portfolio image: ${rp}`, meta.sha);
                }
              } catch (e) {
                // 404 means it's already gone; do not fail publish for that
                if (!isNotFoundError(e)) {
                  try { console.warn('delete failed', rp, e); } catch (_) {}
                }
              }
            }
          }

          // 4) Update JSON (strong retry on SHA mismatch)
          setStatus(`(${branch}) ØªØ­Ø¯ÙŠØ« data/portfolio_projects.json ...`, '');
          await putPortfolioProjectsJsonWithRetry(gh, payload, branch);
        }

        state.deleteSet.clear();
        state.renameMap.clear();
        state.uploads.forEach(u => URL.revokeObjectURL(u.previewUrl));
        state.uploads = [];
        state.repairs = [];
        clearProgress();

        setStatus('ØªÙ… Ø§Ù„Ø±ÙØ¹ + Ø§Ù„Ù†Ø´Ø± Ø¹Ù„Ù‰ GitHub Pages Ø¨Ù†Ø¬Ø§Ø­ âœ…', 'ok');
        refreshUI();
      } catch (e) {
        clearProgress();
        handleError('ÙØ´Ù„ Ø§Ù„Ù†Ø´Ø±', e);
      }
    }

    // ====== LOAD DATA ======
    async function loadPortfolioJson(bustCache) {
      // on GitHub pages/static server, this will work.
      const url = bustCache ? `data/portfolio_projects.json?ts=${Date.now()}` : 'data/portfolio_projects.json';
      const res = await fetch(url, { cache: 'no-store' });
      if (!res.ok) throw new Error('data/portfolio_projects.json not found');
      const j = await res.json();
      if (!j || !Array.isArray(j.projects)) throw new Error('Invalid JSON structure');
      state.data = j;
      state.data.projects = state.data.projects || [];
      state.data.count = state.data.projects.length;

      // Fix legacy data where images/cover are stored as bare filenames (causes 404 in admin).
      try { normalizePortfolioDataPaths(); } catch (e) {}
    }

    async function reloadData() {
      try {
        await loadPortfolioJson(true);
        setStatus('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ù…ÙˆÙ‚Ø¹. (Ø¢Ø®Ø± Ù†Ø³Ø®Ø©)', 'ok');
        refreshUI();
      } catch (e) {
        handleError('ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', e);
      }
    }

    // ====== AUTH ======
    function isAuthed() {
      return !!state.authed;
    }

    function setAuthed(val) {
      state.authed = !!val;
    }

    function showApp() {
      $('loginPanel').classList.add('hidden');
      $('app').classList.remove('hidden');
      try { document.body.classList.add('admin-authed'); } catch (e) {}
    }

    function showLogin() {
      $('app').classList.add('hidden');
      $('loginPanel').classList.remove('hidden');
      try { document.body.classList.remove('admin-authed'); } catch (e) {}
    }

    async function init() {
      const mobileSyncBtn = $('mobilePrimarySync');
      if (mobileSyncBtn) {
        mobileSyncBtn.addEventListener('click', () => {
          const btn = $('btnOneClickPublish') || $('btnSync');
          if (btn) btn.click();
        });
      }

      const mobileReorderBtn = $('btnReorderMobile');
      if (mobileReorderBtn) {
        mobileReorderBtn.addEventListener('click', () => {
          const btn = $('btnReorder');
          if (btn) btn.click();
        });
      }

      function setAdminView(view) {
        const v = String(view || 'edit');
        document.body.classList.remove('admin-view-projects', 'admin-view-edit', 'admin-view-publish');
        document.body.classList.add(`admin-view-${v}`);

        try { localStorage.setItem('artrova_admin_view', v); } catch (e) {}

        try {
          document.querySelectorAll('.admin-bottom-nav .navbtn').forEach((b) => {
            b.classList.toggle('active', b.getAttribute('data-view') === v);
          });
        } catch (e) {}

        try { window.scrollTo({ top: 0, behavior: 'smooth' }); } catch (e) { try { window.scrollTo(0, 0); } catch (_) {} }
      }

      try {
        document.querySelectorAll('.admin-bottom-nav .navbtn').forEach((b) => {
          b.addEventListener('click', () => setAdminView(b.getAttribute('data-view')));
        });
      } catch (e) {}

      // default view
      try {
        const saved = localStorage.getItem('artrova_admin_view');
        setAdminView(saved || 'edit');
      } catch (e) {
        setAdminView('edit');
      }

      $('btnLogout').addEventListener('click', () => {
        setAuthed(false);
        showLogin();
      });

      $('btnLogin').addEventListener('click', async () => {
        const pass = $('adminPass').value;
        if (pass !== ADMIN_PASSWORD) {
          alert('Ø¨Ø§Ø³ÙˆØ±Ø¯ ØºÙŠØ± ØµØ­ÙŠØ­');
          return;
        }
        setAuthed(true);
        showApp();
        await boot();
      });

      showLogin();
    }

    async function boot() {
      $('fileProtoNotice').classList.toggle('hidden', !isFileProtocol());

      const search = $('projectSearch');
      if (search) {
        search.addEventListener('input', (e) => {
          state.projectSearch = String(e.target.value || '');
          renderProjects();
        });
        search.addEventListener('keydown', (e) => {
          if (e.key === 'Escape') {
            e.preventDefault();
            e.target.value = '';
            state.projectSearch = '';
            renderProjects();
          }
        });
      }

      document.addEventListener('keydown', (e) => {
        if ((e.ctrlKey || e.metaKey) && (e.key === 'k' || e.key === 'K')) {
          const el = $('projectSearch');
          if (el) {
            e.preventDefault();
            el.focus();
          }
        }
      });

      const limitSel = $('existingLimit');
      if (limitSel) {
        try { limitSel.value = String(state.existingLimit); } catch (e) {}
        limitSel.addEventListener('change', (e) => {
          const v = parseInt(String(e.target.value || '60'), 10);
          state.existingLimit = Number.isNaN(v) ? 60 : v;
          renderExistingImages();
        });
      }

      $('btnAddProject').addEventListener('click', addProject);
      $('btnDeleteProject').addEventListener('click', deleteProject);

      $('imagePicker').addEventListener('change', (e) => onPickFiles(e.target.files));
      $('btnAutoNames').addEventListener('click', autoNameUploads);
      $('btnApplyUploads').addEventListener('click', applyUploadsToProject);

      if ($('btnRepairPick') && $('repairPicker')) {
        $('btnRepairPick').addEventListener('click', () => {
          try { $('repairPicker').click(); } catch (e) {}
        });
        $('repairPicker').addEventListener('change', (e) => onPickRepairFiles(e.target.files));
      }

      if ($('btnSaveProjectTitles')) $('btnSaveProjectTitles').addEventListener('click', saveProjectTitles);
      if ($('btnRememberToken')) $('btnRememberToken').addEventListener('click', rememberToken);
      if ($('btnReloadData')) $('btnReloadData').addEventListener('click', reloadData);
      tryLoadRememberedToken();

      $('btnExportJson').addEventListener('click', exportJson);
      $('btnPublish').addEventListener('click', publish);
      if ($('btnSync')) $('btnSync').addEventListener('click', syncNow);
      if ($('btnOneClickPublish')) $('btnOneClickPublish').addEventListener('click', publish);

      if ($('btnReorder')) $('btnReorder').addEventListener('click', openReorderModal);
      if ($('btnReorderClose')) $('btnReorderClose').addEventListener('click', closeReorderModal);
      if ($('btnReorderSave')) $('btnReorderSave').addEventListener('click', saveReorderDraft);
      if ($('btnReorderAuto')) $('btnReorderAuto').addEventListener('click', autoSortReorderDraft);

      try {
        await loadPortfolioJson(true);
        setStatus('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹.', 'ok');
      } catch (e) {
        handleError('ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ data/portfolio_projects.json', e);
      }

      refreshUI();
      updateActionsEnabled();
    }

    init();
  </script>
</body>
</html>
