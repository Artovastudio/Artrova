<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Artrova Admin (V2)</title>
  <link rel="icon" href="assets/favicon.svg" />
  <style>
    :root{
      --bg: #070A12;
      --panel: rgba(255,255,255,.06);
      --panel2: rgba(255,255,255,.04);
      --border: rgba(255,255,255,.10);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.65);
      --danger: #ff4d6d;
      --ok: #22c55e;
      --brand1: #f08ac0;
      --brand2: #38bdf8;
      --shadow: 0 24px 72px rgba(0,0,0,.55);
      --shadow2: 0 22px 68px rgba(0,0,0,.62);
      --glowBrand: 0 0 0 1px rgba(240,138,192,.10), 0 0 24px rgba(240,138,192,.18), 0 0 44px rgba(56,189,248,.14);
      --glowBlue: 0 0 0 1px rgba(56,189,248,.12), 0 0 24px rgba(56,189,248,.18), 0 0 44px rgba(56,189,248,.12);
      --glowPink: 0 0 0 1px rgba(240,138,192,.12), 0 0 22px rgba(240,138,192,.18), 0 0 40px rgba(240,138,192,.12);
      --glowOk: 0 0 0 1px rgba(34,197,94,.14), 0 0 22px rgba(34,197,94,.16);
      --glowDanger: 0 0 0 1px rgba(255,77,109,.16), 0 0 22px rgba(255,77,109,.16);
      --radius: 18px;
      --radius2: 14px;
      --gap: 14px;
      --pad: 14px;
      --padHd: 14px;
      --wrapPadY: 22px;
      --wrapPadBottom: 80px;
      --sep: 12px;
      --imgGap: 10px;
      --ease: cubic-bezier(.2,.8,.2,1);
    }
    *{box-sizing:border-box;}
    body{margin:0; background: radial-gradient(1200px 700px at 70% -10%, rgba(56,189,248,.28), transparent 56%), radial-gradient(1100px 600px at 10% -30%, rgba(240,138,192,.22), transparent 54%), radial-gradient(900px 500px at 90% 40%, rgba(56,189,248,.12), transparent 58%), var(--bg); color:var(--text); font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;}
    a{color:inherit}
    .wrap{max-width:1180px; margin:0 auto; padding: var(--wrapPadY) 16px var(--wrapPadBottom);}
    .topbar{display:flex; align-items:center; justify-content:space-between; gap:14px; margin-bottom:16px;}
    .brand{display:flex; align-items:center; gap:10px;}
    .logo{width:38px; height:38px; border-radius:12px; background: linear-gradient(135deg, rgba(240,138,192,.9), rgba(56,189,248,.85)); box-shadow: 0 0 0 1px rgba(255,255,255,.12), 0 16px 60px rgba(56,189,248,.14), 0 0 34px rgba(240,138,192,.14);}
    .titlebox{display:flex; flex-direction:column;}
    .titlebox .t{font-weight:800; letter-spacing:.2px;}
    .titlebox .s{font-size:.88rem; color:var(--muted);}

    .grid{display:grid; grid-template-columns: 420px 1fr; gap: var(--gap); align-items:start;}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr;} }

    .card{background: linear-gradient(180deg, rgba(255,255,255,.075), rgba(255,255,255,.025)); border:1px solid var(--border); border-radius: var(--radius); box-shadow: var(--shadow); overflow:hidden; transition: transform .18s var(--ease), box-shadow .22s var(--ease), border-color .22s var(--ease), background .22s var(--ease);}
    .card:hover{border-color: rgba(255,255,255,.16); box-shadow: var(--shadow2), var(--glowBrand);}
    .card .hd{display:flex; align-items:center; justify-content:space-between; padding: var(--padHd) var(--padHd); border-bottom:1px solid var(--border); background: rgba(0,0,0,.25);}
    .card .hd h2{margin:0; font-size:1rem;}
    .card .bd{padding: var(--pad);}

    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap;}
    .col{display:flex; flex-direction:column; gap:6px; flex:1; min-width: 180px;}
    label{font-size:.82rem; color:var(--muted);}
    input[type="text"], input[type="password"], select{width:100%; padding:11px 12px; border-radius: 14px; border:1px solid var(--border); background: rgba(2,6,23,.55); color:var(--text); outline:none;}
    input[type="file"]{width:100%;}

    .btn{appearance:none; border:1px solid var(--border); background: rgba(255,255,255,.06); color:var(--text); padding:10px 12px; border-radius: 14px; cursor:pointer; transition: transform .16s var(--ease), background .22s var(--ease), border-color .22s var(--ease), box-shadow .22s var(--ease), filter .22s var(--ease);}
    .btn:hover{background: rgba(255,255,255,.10); border-color: rgba(255,255,255,.16);}
    .btn:active{transform: translateY(1px) scale(.99);}
    .btn:disabled{opacity:.5; cursor:not-allowed;}
    .btn.primary{background: linear-gradient(135deg, rgba(240,138,192,.78), rgba(56,189,248,.68)); border-color: rgba(255,255,255,.18); box-shadow: 0 18px 70px rgba(56,189,248,.14), 0 0 0 1px rgba(255,255,255,.10);}
    .btn.primary:hover{background: linear-gradient(135deg, rgba(240,138,192,.92), rgba(56,189,248,.82)); box-shadow: 0 22px 86px rgba(240,138,192,.16), var(--glowBrand);}
    .btn.ok{border-color: rgba(34,197,94,.55);}
    .btn.danger{border-color: rgba(255,77,109,.55);}
    .btn.ok:hover{box-shadow: var(--glowOk);}
    .btn.danger:hover{box-shadow: var(--glowDanger);}
    .btn.big{padding:14px 14px; border-radius: 16px; font-weight:800;}

    .pill{font-size:.78rem; color: rgba(255,255,255,.78); border:1px solid rgba(255,255,255,.14); background: rgba(0,0,0,.16); padding:6px 10px; border-radius: 999px; box-shadow: 0 0 0 1px rgba(0,0,0,.22) inset;}

    .notice{border:1px solid var(--border); background: rgba(2,6,23,.45); border-radius: 16px; padding:12px 12px; color: var(--muted);}
    .notice.ok{border-color: rgba(34,197,94,.55); color: rgba(229,255,242,.92); background: rgba(34,197,94,.08);}
    .notice.danger{border-color: rgba(255,77,109,.55); color: rgba(255,226,232,.92); background: rgba(255,77,109,.08);}

    .kpi{display:grid; grid-template-columns: repeat(3, 1fr); gap:10px; margin-top:10px;}
    @media (max-width: 520px){ .kpi{grid-template-columns: 1fr;} }
    .kpi .box{border:1px solid var(--border); background: rgba(0,0,0,.18); border-radius: 16px; padding:10px 10px;}
    .kpi .box .n{font-weight:900; font-size:1.1rem;}
    .kpi .box .l{font-size:.82rem; color: var(--muted);}

    .log{white-space:pre-line; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:.88rem; line-height:1.35; min-height: 130px;}

    .imgs{display:grid; grid-template-columns: repeat(5, 1fr); gap: var(--imgGap);}
    @media (max-width: 980px){ .imgs{grid-template-columns: repeat(4, 1fr);} }
    @media (max-width: 720px){ .imgs{grid-template-columns: repeat(3, 1fr);} }
    @media (max-width: 460px){ .imgs{grid-template-columns: repeat(2, 1fr);} }

    .projects{display:grid; grid-template-columns: repeat(2, 1fr); gap: var(--imgGap);}
    @media (max-width: 980px){ .projects{grid-template-columns: 1fr;} }
    .proj{border:1px solid var(--border); border-radius: 16px; background: rgba(0,0,0,.18); overflow:hidden; cursor:pointer; transition: transform .18s var(--ease), background .22s var(--ease), border-color .22s var(--ease), box-shadow .22s var(--ease);}
    .proj:hover{background: rgba(255,255,255,.06); transform: translateY(-1px); box-shadow: 0 18px 60px rgba(0,0,0,.45);}
    .proj:active{transform: translateY(0px) scale(.995);}
    .proj.sel{border-color: rgba(240,138,192,.62); box-shadow: 0 0 0 2px rgba(240,138,192,.14) inset, var(--glowPink);}
    .proj .thumb{aspect-ratio: 16/9; background: rgba(0,0,0,.35);}
    .proj .thumb img{width:100%; height:100%; object-fit:cover; display:block;}
    .proj .meta{padding:10px 10px; display:flex; flex-direction:column; gap:8px;}
    .proj .meta .t{font-weight:800; font-size:.95rem;}
    .proj .meta .s{font-size:.82rem; color: var(--muted);}

    .img{border:1px solid var(--border); border-radius: 16px; background: rgba(0,0,0,.22); overflow:hidden; transition: transform .18s var(--ease), border-color .22s var(--ease), box-shadow .22s var(--ease), filter .22s var(--ease);}
    .img .thumb{position: relative; aspect-ratio: 1/1; background: rgba(0,0,0,.35); display:flex; align-items:center; justify-content:center;}
    .img img{width:100%; height:100%; object-fit:cover; display:block;}
    .img .meta{padding:10px 10px; display:flex; flex-direction:column; gap:8px;}
    .img .name{font-size:.86rem; color: rgba(255,255,255,.78); overflow:hidden; text-overflow: ellipsis; white-space:nowrap;}
    .img .name input{width:100%; padding:9px 10px; border-radius: 12px; border:1px solid var(--border); background: rgba(2,6,23,.55); color:var(--text); outline:none;}

    .img .thumb{position: relative;}
    .img.sel{border-color: rgba(240,138,192,.78); box-shadow: 0 0 0 2px rgba(240,138,192,.18) inset, var(--glowPink);}
    .img .selBox{position:absolute; top:8px; right:8px; z-index:5; display:flex; align-items:center; justify-content:center; width:26px; height:26px; border-radius: 10px; border:1px solid rgba(255,255,255,.22); background: rgba(0,0,0,.42);}
    .img .selBox input{width:16px; height:16px;}

    .img:hover{transform: translateY(-1px); box-shadow: 0 18px 64px rgba(0,0,0,.50); filter: saturate(1.06);}

    .selbar{display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap; margin-top:10px;}
    .selbar .left{display:flex; gap:8px; align-items:center; flex-wrap:wrap;}
    .selbar .right{display:flex; gap:8px; align-items:center; flex-wrap:wrap;}

    details{border:1px solid var(--border); border-radius: 16px; background: rgba(0,0,0,.18); overflow:hidden;}
    details > summary{cursor:pointer; list-style:none; padding:12px 12px; font-weight:800; user-select:none; display:flex; align-items:center; justify-content:space-between; gap:10px;}
    details > summary::-webkit-details-marker{display:none;}
    details .details-body{padding:12px 12px; border-top:1px solid var(--border);}

    .modal{position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:1000;}
    .modal.open{display:flex;}
    .modal .backdrop{position:absolute; inset:0; background: rgba(0,0,0,.58); backdrop-filter: blur(10px);}
    .modal .panel{position:relative; width:min(980px, 92vw); border:1px solid rgba(255,255,255,.16); border-radius: 18px; background: linear-gradient(180deg, rgba(255,255,255,.095), rgba(255,255,255,.028)); box-shadow: var(--shadow2), var(--glowBlue); overflow:hidden;}
    .modal .panel .hd{display:flex; align-items:center; justify-content:space-between; gap:10px; padding:12px 12px; border-bottom:1px solid var(--border); background: rgba(0,0,0,.25);}
    .modal .panel .hd .t{font-weight:900; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;}
    .modal .panel .bd{display:grid; grid-template-columns: 1.1fr .9fr; gap:12px; padding:12px 12px;}
    @media (max-width: 880px){ .modal .panel .bd{grid-template-columns:1fr;} }
    .modal .preview{border:1px solid var(--border); border-radius: 16px; background: rgba(0,0,0,.20); overflow:hidden;}
    .modal .preview img{width:100%; height:100%; max-height: 62vh; object-fit:contain; display:block; background: rgba(0,0,0,.35);}
    .modal .stack{display:flex; flex-direction:column; gap:10px;}
    .modal .stack .row{justify-content:flex-start;}
    .modal .badges{display:flex; gap:8px; flex-wrap:wrap;}

    .sep{height:1px; background: var(--border); margin: var(--sep) 0;}

    .scrollArea{overflow:auto; scrollbar-gutter: stable both-edges;}
    .projectsScroll{max-height: 360px;}
    .imagesScroll{max-height: calc(100vh - 330px);}
    @media (max-width: 980px){
      .projectsScroll{max-height: none;}
      .imagesScroll{max-height: none;}
    }

    body.compact{
      --gap: 10px;
      --pad: 12px;
      --padHd: 12px;
      --wrapPadY: 14px;
      --wrapPadBottom: 36px;
      --sep: 10px;
      --imgGap: 8px;
    }
    body.compact .topbar{margin-bottom: 10px;}
    body.compact .projectsScroll{max-height: 260px;}
    body.compact .proj .thumb{aspect-ratio: 21/9;}
    body.compact .proj .meta{padding: 8px 10px; gap:6px;}
    body.compact .proj .meta .t{font-size:.92rem;}
    body.compact .proj .meta .s{font-size:.78rem;}
    body.compact .imgs{grid-template-columns: repeat(6, 1fr);}
    @media (max-width: 980px){ body.compact .imgs{grid-template-columns: repeat(4, 1fr);} }
    @media (max-width: 720px){ body.compact .imgs{grid-template-columns: repeat(3, 1fr);} }
    @media (max-width: 460px){ body.compact .imgs{grid-template-columns: repeat(2, 1fr);} }

    .hidden{display:none !important;}

    @keyframes fadeUp {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes pop {
      from { opacity: 0; transform: translateY(8px) scale(.985); }
      to { opacity: 1; transform: translateY(0) scale(1); }
    }
    @keyframes modalIn {
      from { opacity: 0; transform: translateY(10px) scale(.985); }
      to { opacity: 1; transform: translateY(0) scale(1); }
    }
    @keyframes backdropIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    body.ui-ready .topbar{animation: fadeUp .45s var(--ease) both;}
    body.ui-ready #app .card{animation: pop .45s var(--ease) both;}
    body.ui-ready #app .card:nth-child(2){animation-delay: .06s;}
    body.ui-ready #loginCard.card{animation: pop .45s var(--ease) both;}
    .modal.open .backdrop{animation: backdropIn .18s var(--ease) both;}
    .modal.open .panel{animation: modalIn .22s var(--ease) both;}

    @media (prefers-reduced-motion: reduce) {
      *{animation:none !important; transition:none !important;}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div class="titlebox">
          <div class="t">Artrova Admin (V2)</div>
          <div class="s">إدارة المشاريع والصور — رفع/حذف/تعديل + نشر</div>
        </div>
      </div>
      <div class="row">
        <span class="pill" id="envPill">—</span>
        <button class="btn" id="btnCompact">وضع مدمج</button>
        <button class="btn" id="btnLogout">خروج</button>
      </div>
    </div>

    <div id="loginCard" class="card">
      <div class="hd"><h2>تسجيل الدخول</h2><span class="pill">محلي</span></div>
      <div class="bd">
        <div class="row">
          <div class="col" style="min-width:260px; flex:1;">
            <label>كلمة مرور الأدمن</label>
            <input id="adminPass" type="password" placeholder="••••••••" autocomplete="current-password" />
          </div>
          <button class="btn primary big" id="btnLogin" style="min-width: 200px;">دخول</button>
        </div>
        <div class="sep"></div>
        <div class="notice" id="fileProtoNotice">لو فتحت الصفحة عبر <b>file://</b> بعض العمليات هتفشل. شغّل Live Server أو افتح عبر <b>http://localhost</b>.</div>
      </div>
    </div>

    <div id="app" class="grid hidden">
      <div class="card">
        <div class="hd"><h2>إعدادات + مشاريع</h2><span class="pill" id="projectsCount">0</span></div>
        <div class="bd">
          <div class="row">
            <div class="col" style="min-width:240px;">
              <label>بحث</label>
              <input id="search" type="text" placeholder="ابحث بالاسم أو الـslug..." />
            </div>
            <div class="col" style="min-width:220px;">
              <label>اختر مشروع</label>
              <select id="projectSelect"></select>
            </div>
          </div>

          <div class="sep"></div>

          <div class="scrollArea projectsScroll">
            <div class="projects" id="projectsGrid"></div>
          </div>

          <div class="sep"></div>

          <div class="kpi">
            <div class="box"><div class="n" id="kpiImages">0</div><div class="l">صور بالمشروع</div></div>
            <div class="box"><div class="n" id="kpiPending">0</div><div class="l">تغييرات جاهزة للنشر</div></div>
            <div class="box"><div class="n" id="kpiNew">0</div><div class="l">صور جديدة</div></div>
          </div>

          <div class="sep"></div>

          <div class="row">
            <button class="btn danger" id="btnDeleteProject" disabled>حذف المشروع</button>
            <button class="btn" id="btnNewProject">إنشاء مشروع جديد</button>
          </div>

          <div class="sep"></div>

          <details>
            <summary>
              <span>إعدادات GitHub</span>
              <span class="pill">Token</span>
            </summary>
            <div class="details-body">
              <div class="row">
                <div class="col" style="min-width:260px; flex:1;">
                  <label>GitHub Token</label>
                  <input id="ghToken" type="password" placeholder="ghp_..." autocomplete="off" />
                </div>
                <div class="col" style="min-width:260px; flex:1;">
                  <label>GitHub API</label>
                  <select id="ghApiMode">
                    <option value="direct">مباشر (قد يفشل بسبب CORS)</option>
                    <option value="proxy">Proxy محلي (موصى به)</option>
                  </select>
                </div>
                <button class="btn" id="btnRemember">تذكّر التوكن</button>
                <button class="btn" id="btnTestGh">اختبار الاتصال</button>
                <button class="btn" id="btnReload">تحديث البيانات</button>
              </div>
            </div>
          </details>

          <div class="notice log" id="log">جاهز.</div>
        </div>
      </div>

      <div class="card">
        <div class="hd"><h2 id="editorTitle">تحرير المشروع</h2><span class="pill" id="slugPill">—</span></div>
        <div class="bd">
          <div class="row">
            <div class="col">
              <label>اسم المشروع (AR)</label>
              <input id="titleAr" type="text" placeholder="مثال: سكني" disabled />
            </div>
            <div class="col">
              <label>اسم المشروع (EN)</label>
              <input id="titleEn" type="text" placeholder="Example: Residential" disabled />
            </div>
            <button class="btn ok" id="btnSaveNames" disabled>حفظ الاسم</button>
          </div>

          <div class="sep"></div>

          <div class="row">
            <div class="col" style="min-width: 280px; flex:1;">
              <label>اختيار الصور (متعدد)</label>
              <input id="filePicker" type="file" accept="image/*" multiple disabled />
            </div>
            <button class="btn primary big" id="btnPublish" disabled style="min-width:260px;">رفع ونشر الآن</button>
            <button class="btn" id="btnOpenSiteFresh" type="button" disabled style="min-width:240px;">فتح الموقع (تحديث)</button>
          </div>

          <div class="sep"></div>

          <div class="row" style="justify-content:space-between;">
            <div class="pill">الصور</div>
            <div class="pill" id="imagesPill">0</div>
          </div>

          <div class="selbar" id="selectionBar">
            <div class="left">
              <div class="pill" id="selectedCount">المحدد: 0</div>
            </div>
            <div class="right">
              <button class="btn" id="btnSelectAll" type="button" disabled>تحديد الكل</button>
              <button class="btn" id="btnSelectNone" type="button" disabled>إلغاء التحديد</button>
              <button class="btn danger" id="btnDeleteSelected" type="button" disabled>حذف المحدد</button>
              <button class="btn ok" id="btnSetCoverSelected" type="button" disabled>تعيين غلاف</button>
            </div>
          </div>

          <div class="scrollArea imagesScroll" style="margin-top:10px;">
            <div class="imgs" id="imagesGrid"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal" id="imgModal" aria-hidden="true">
    <div class="backdrop" id="imgModalBackdrop"></div>
    <div class="panel" role="dialog" aria-modal="true">
      <div class="hd">
        <div class="t" id="imgModalTitle">—</div>
        <button class="btn" id="imgModalClose">إغلاق</button>
      </div>
      <div class="bd">
        <div class="preview"><img id="imgModalImg" alt="" /></div>
        <div class="stack">
          <div class="badges" id="imgModalBadges"></div>
          <div class="col" id="imgModalNameWrap">
            <label>اسم الصورة (قبل الرفع)</label>
            <input id="imgModalName" type="text" />
          </div>
          <div class="row">
            <button class="btn ok" id="btnModalCover">تعيين كغلاف</button>
            <button class="btn" id="btnModalPrev">◀</button>
            <button class="btn" id="btnModalNext">▶</button>
          </div>
          <div class="row">
            <button class="btn danger" id="btnModalDelete">حذف</button>
          </div>
          <div class="notice">اضغط على الصور في الشبكة لفتح أدوات التحكم.</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const ADMIN_PASSWORD = 'artrova123';
    const TOKEN_STORE_KEY = 'artrova_admin_gh_token_v2';
    const COMPACT_STORE_KEY = 'artrova_admin_compact_v2';
    const API_MODE_STORE_KEY = 'artrova_admin_gh_api_mode_v2';

    const GITHUB_OWNER = 'Artovastudio';
    const GITHUB_REPO = 'Artrova';
    const GITHUB_BRANCH = 'main';
    const GITHUB_PUBLISH_BRANCHES = ['main', 'gh-pages'];

    const $ = (id) => document.getElementById(id);

    const state = {
      authed: false,
      data: { source: 'portfolio_projects', count: 0, projects: [] },
      selectedSlug: null,
      filter: '',
      ui: {
        imgModalOpen: false,
        imgModalSlug: null,
        imgModalPath: null,
        selectedImages: new Set()
      },
      pending: {
        uploads: [],
        deletes: new Set(),
        projectDeletes: new Set(),
        nameEdits: new Map(),
        coverEdits: new Map(),
        orderEdits: new Map()
      },
      publishInFlight: false
    };

    function isFileProtocol() {
      try { return window.location && window.location.protocol === 'file:'; } catch (e) { return false; }
    }

    function setEnvPill() {
      $('envPill').textContent = isFileProtocol() ? 'file://' : 'http(s)';
    }

    function setCompactMode(on) {
      const flag = !!on;
      try {
        document.body.classList.toggle('compact', flag);
      } catch (e) {}
      try {
        localStorage.setItem(COMPACT_STORE_KEY, flag ? '1' : '0');
      } catch (e) {}
      const btn = $('btnCompact');
      if (btn) btn.textContent = flag ? 'وضع عادي' : 'وضع مدمج';
    }

    function getCompactMode() {
      try {
        return String(localStorage.getItem(COMPACT_STORE_KEY) || '') === '1';
      } catch (e) {
        return false;
      }
    }

    async function runWithConcurrency(items, limit, worker) {
      const arr = Array.isArray(items) ? items : [];
      const max = Math.max(1, Math.min(Number(limit || 1) || 1, 6));
      let idx = 0;
      const results = new Array(arr.length);

      const runners = Array.from({ length: Math.min(max, arr.length) }, async () => {
        while (true) {
          const my = idx++;
          if (my >= arr.length) break;
          try {
            results[my] = { ok: true, value: await worker(arr[my], my) };
          } catch (e) {
            results[my] = { ok: false, error: e };
          }
        }
      });

      await Promise.all(runners);
      return results;
    }

    function setLog(text, kind) {
      const el = $('log');
      el.textContent = text;
      el.classList.remove('ok', 'danger');
      if (kind === 'ok') el.classList.add('ok');
      if (kind === 'danger') el.classList.add('danger');
    }

    function getEffectiveToken() {
      const direct = String(($('ghToken') && $('ghToken').value) || '').trim();
      if (direct) return direct;
      try {
        return String(localStorage.getItem(TOKEN_STORE_KEY) || '').trim();
      } catch (e) {
        return '';
      }
    }

    function getApiMode() {
      try {
        const saved = String(localStorage.getItem(API_MODE_STORE_KEY) || '').trim();
        if (saved) return saved;
        return isLocalhost() ? 'proxy' : 'direct';
      } catch (e) {
        return isLocalhost() ? 'proxy' : 'direct';
      }
    }

    function setApiMode(mode) {
      const v = (mode === 'direct' || mode === 'proxy') ? mode : 'proxy';
      try { localStorage.setItem(API_MODE_STORE_KEY, v); } catch (e) {}
      const sel = $('ghApiMode');
      if (sel) sel.value = v;
    }

    function getGithubApiBase() {
      const mode = getApiMode();
      if (mode === 'direct') return 'https://api.github.com';
      return 'http://localhost:8787';
    }

    function isLocalhost() {
      try {
        const h = String(window.location && window.location.hostname ? window.location.hostname : '').toLowerCase();
        return h === 'localhost' || h === '127.0.0.1';
      } catch (e) {
        return false;
      }
    }

    const sleep = (ms) => new Promise(r => setTimeout(r, ms));

    function rememberToken() {
      const token = String(($('ghToken') && $('ghToken').value) || '').trim();
      if (!token) {
        setLog('❌ فشل\nالسبب: GitHub Token غير موجود\nالحل: الصق التوكن ثم اضغط تذكّر', 'danger');
        return;
      }
      try {
        localStorage.setItem(TOKEN_STORE_KEY, token);
        setLog('✓ تم حفظ التوكن على هذا الجهاز.', 'ok');
      } catch (e) {
        setLog('❌ المتصفح منع حفظ التوكن. ستحتاج لصقه كل مرة.', 'danger');
      }
    }

    function slugify(input) {
      const s = String(input || '').trim().toLowerCase();
      const cleaned = s
        .replace(/[\u064B-\u065F]/g, '')
        .replace(/[^a-z0-9\s-_]/g, '')
        .replace(/\s+/g, '-')
        .replace(/-+/g, '-')
        .replace(/^[-_]+|[-_]+$/g, '');
      return cleaned || 'project';
    }

    function getProjectBySlug(slug) {
      return (state.data.projects || []).find(p => String(p.slug) === String(slug)) || null;
    }

    function getProjectTitle(p) {
      if (!p) return '';
      const ar = String(p.titleAr || '').trim();
      const en = String(p.titleEn || '').trim();
      const any = String(p.title || '').trim();
      if (ar && en && ar.toLowerCase() !== en.toLowerCase()) return `${ar} | ${en}`;
      return ar || en || any || p.slug;
    }

    function normalizeDataPaths() {
      for (const p of (state.data.projects || [])) {
        if (!p || !p.slug) continue;
        const baseDir = `assets/site_images/projects/portfolio_projects/${p.slug}`;
        if (Array.isArray(p.images)) {
          p.images = p.images.map((img) => {
            let s = String(img || '').trim();
            if (!s) return s;
            if (/^https?:\/\//i.test(s)) {
              try {
                const u = new URL(s);
                s = u.pathname || '';
              } catch (e) {}
            }
            s = s.split('#')[0].split('?')[0];
            s = s.replace(/^\.\//, '').replace(/^\//, '');
            if (s.includes('/')) return s;
            return `${baseDir}/${s}`;
          });
        } else {
          p.images = [];
        }
        if (p.cover) {
          let c = String(p.cover).trim();
          c = c.replace(/^\.\//, '').replace(/^\//, '');
          if (c && !c.includes('/')) c = `${baseDir}/${c}`;
          p.cover = c;
        } else {
          p.cover = p.images[0] || '';
        }
        p.imageCount = Array.isArray(p.images) ? p.images.length : 0;
      }
    }

    async function loadPortfolioJson(bust) {
      const url = bust ? `data/portfolio_projects.json?ts=${Date.now()}` : 'data/portfolio_projects.json';
      const res = await fetch(url, { cache: 'no-store' });
      if (!res.ok) throw new Error('data/portfolio_projects.json not found');
      const j = await res.json();
      if (!j || !Array.isArray(j.projects)) throw new Error('Invalid JSON structure');
      state.data = j;
      state.data.projects = state.data.projects || [];
      state.data.count = state.data.projects.length;
      normalizeDataPaths();
    }

    function applyFilter() {
      const q = String(state.filter || '').trim().toLowerCase();
      const all = state.data.projects || [];
      const kept = all.filter(p => p && !state.pending.projectDeletes.has(String(p.slug)));
      if (!q) return kept;
      return kept.filter(p => {
        const slug = String(p.slug || '').toLowerCase();
        const edited = state.pending.nameEdits.get(String(p.slug));
        const t = `${String((edited && edited.titleAr) || p.titleAr || '')} ${String((edited && edited.titleEn) || p.titleEn || '')} ${String((edited && edited.title) || p.title || '')}`.toLowerCase();
        return slug.includes(q) || t.includes(q);
      });
    }

    function renderProjects() {
      const list = applyFilter();
      $('projectsCount').textContent = String(list.length);

      const sel = $('projectSelect');
      sel.innerHTML = '';

      const opt0 = document.createElement('option');
      opt0.value = '';
      opt0.textContent = '— اختر مشروع —';
      sel.appendChild(opt0);

      for (const p of list) {
        const o = document.createElement('option');
        o.value = String(p.slug);
        const edited = state.pending.nameEdits.get(String(p.slug));
        const title = edited ? getProjectTitle({ ...p, ...edited }) : getProjectTitle(p);
        o.textContent = `${title}  (${p.slug})`;
        sel.appendChild(o);
      }

      if (state.selectedSlug) {
        try { sel.value = state.selectedSlug; } catch (e) {}
      }

      const grid = $('projectsGrid');
      if (grid) {
        grid.innerHTML = '';
        for (const p of list) {
          const slug = String(p.slug);
          const edited = state.pending.nameEdits.get(slug);
          const effective = edited ? ({ ...p, ...edited }) : p;
          const order = getOrderedVisibleImagesForProject(p);

          const coverPref = state.pending.coverEdits.get(slug);
          let cover = coverPref || String(effective.cover || '') || (order[0] || '');
          if (cover && state.pending.deletes.has(cover)) cover = order[0] || '';

          const card = document.createElement('div');
          card.className = 'proj' + (state.selectedSlug === slug ? ' sel' : '');
          card.addEventListener('click', () => {
            try { sel.value = slug; } catch (e) {}
            selectProject(slug);
          });

          const th = document.createElement('div');
          th.className = 'thumb';
          if (cover) {
            const im = document.createElement('img');
            const staged = getStagedUploadByTargetPath(slug, cover);
            im.loading = 'lazy';
            im.src = staged && staged.previewUrl ? staged.previewUrl : cover;
            im.alt = '';
            th.appendChild(im);
          }

          const meta = document.createElement('div');
          meta.className = 'meta';
          const t = document.createElement('div');
          t.className = 't';
          t.textContent = getProjectTitle(effective);
          const s = document.createElement('div');
          s.className = 's';
          s.textContent = `${slug} — ${order.length} صورة`;

          meta.appendChild(t);
          meta.appendChild(s);

          card.appendChild(th);
          card.appendChild(meta);
          grid.appendChild(card);
        }
      }
    }

    function closeImageModal() {
      state.ui.imgModalOpen = false;
      state.ui.imgModalSlug = null;
      state.ui.imgModalPath = null;
      const m = $('imgModal');
      if (m) m.classList.remove('open');
      try { if (m) m.setAttribute('aria-hidden', 'true'); } catch (e) {}
    }

    function openImageModal(path) {
      const p = state.selectedSlug ? getProjectBySlug(state.selectedSlug) : null;
      if (!p) return;
      const slug = String(p.slug);
      state.ui.imgModalOpen = true;
      state.ui.imgModalSlug = slug;
      state.ui.imgModalPath = String(path);
      const m = $('imgModal');
      if (m) m.classList.add('open');
      try { if (m) m.setAttribute('aria-hidden', 'false'); } catch (e) {}
      renderImageModal();
    }

    function renderImageModal() {
      if (!state.ui.imgModalOpen) return;
      const p = state.ui.imgModalSlug ? getProjectBySlug(state.ui.imgModalSlug) : null;
      if (!p) {
        closeImageModal();
        return;
      }

      const slug = String(p.slug);
      const order = getOrderedVisibleImagesForProject(p);
      const path = String(state.ui.imgModalPath || '');
      const idx = order.findIndex(x => String(x) === String(path));
      if (idx === -1) {
        closeImageModal();
        return;
      }

      const staged = getStagedUploadByTargetPath(slug, path);
      const coverPref = state.pending.coverEdits.get(slug);
      let effectiveCover = coverPref || String(p.cover || '') || (order[0] || '');
      if (effectiveCover && state.pending.deletes.has(effectiveCover)) effectiveCover = order[0] || '';

      const titleEl = $('imgModalTitle');
      if (titleEl) titleEl.textContent = String(path).split('/').pop() || path;

      const imgEl = $('imgModalImg');
      if (imgEl) imgEl.src = staged && staged.previewUrl ? staged.previewUrl : path;

      const badges = $('imgModalBadges');
      if (badges) {
        badges.innerHTML = '';
        if (staged) {
          const b = document.createElement('span');
          b.className = 'pill';
          b.textContent = 'جديد';
          badges.appendChild(b);
        }
        if (String(path) === String(effectiveCover)) {
          const b = document.createElement('span');
          b.className = 'pill';
          b.textContent = 'غلاف';
          badges.appendChild(b);
        }
        const b2 = document.createElement('span');
        b2.className = 'pill';
        b2.textContent = `${idx + 1}/${order.length}`;
        badges.appendChild(b2);
      }

      const nameWrap = $('imgModalNameWrap');
      const nameInput = $('imgModalName');
      if (nameWrap) nameWrap.classList.toggle('hidden', !staged);
      if (staged && nameInput) {
        nameInput.value = String(staged.name || '').trim() || (String(path).split('/').pop() || path);
      }

      const btnPrev = $('btnModalPrev');
      const btnNext = $('btnModalNext');
      if (btnPrev) btnPrev.disabled = idx === 0;
      if (btnNext) btnNext.disabled = idx === order.length - 1;

      const btnDel = $('btnModalDelete');
      if (btnDel) btnDel.textContent = staged ? 'إزالة' : 'حذف';
    }

    function computePendingCount() {
      return (state.pending.uploads.length) + (state.pending.deletes.size) + (state.pending.projectDeletes.size) + (state.pending.nameEdits.size) + (state.pending.coverEdits.size) + (state.pending.orderEdits.size) + (state.pending.dirtyJson ? 1 : 0);
    }

    function getStagedUploadsForProject(slug) {
      return state.pending.uploads.filter(u => u && String(u.projectSlug) === String(slug));
    }

    function getStagedUploadByTargetPath(slug, targetPath) {
      const list = getStagedUploadsForProject(slug);
      for (const u of list) {
        if (u && String(u.targetPath) === String(targetPath)) return u;
      }
      return null;
    }

    function normalizeOrderForProject(p, preferredOrder) {
      const base = Array.isArray(p.images) ? p.images.slice() : [];
      const staged = getStagedUploadsForProject(p.slug).map(u => u.targetPath);
      const universe = base.concat(staged).filter(x => x && !state.pending.deletes.has(x));
      const inUniverse = new Set(universe);

      const initial = Array.isArray(preferredOrder) ? preferredOrder.slice() : [];
      const out = [];
      const used = new Set();

      for (const x of initial) {
        if (inUniverse.has(x) && !used.has(x)) {
          used.add(x);
          out.push(x);
        }
      }

      for (const x of universe) {
        if (!used.has(x)) {
          used.add(x);
          out.push(x);
        }
      }

      return out;
    }

    function getOrderedVisibleImagesForProject(p) {
      if (!p) return [];
      const pref = state.pending.orderEdits.get(String(p.slug));
      return normalizeOrderForProject(p, pref);
    }

    function getVisibleImagesForProject(p) {
      if (!p) return [];
      return getOrderedVisibleImagesForProject(p);
    }

    function updateKpis() {
      const p = state.selectedSlug ? getProjectBySlug(state.selectedSlug) : null;
      const visibleCount = p ? getVisibleImagesForProject(p).length : 0;
      $('kpiImages').textContent = String(visibleCount);
      $('kpiNew').textContent = String(state.pending.uploads.length);
      $('kpiPending').textContent = String(computePendingCount());
    }

    function updateEditorState() {
      const p = state.selectedSlug ? getProjectBySlug(state.selectedSlug) : null;
      const has = !!p;

      $('btnDeleteProject').disabled = !has;
      $('filePicker').disabled = !has;
      $('titleAr').disabled = !has;
      $('titleEn').disabled = !has;
      $('btnSaveNames').disabled = !has;

      const canPublish = computePendingCount() > 0;
      $('btnPublish').disabled = !canPublish;

      const edited = has ? state.pending.nameEdits.get(String(p.slug)) : null;
      const effective = has && edited ? ({ ...p, ...edited }) : p;
      $('editorTitle').textContent = has ? `تحرير: ${getProjectTitle(effective)}` : 'تحرير المشروع';
      $('slugPill').textContent = has ? p.slug : '—';

      $('titleAr').value = has ? String((edited && edited.titleAr) || p.titleAr || '') : '';
      $('titleEn').value = has ? String((edited && edited.titleEn) || p.titleEn || '') : '';

      const imgCount = has ? getVisibleImagesForProject(p).length : 0;
      $('imagesPill').textContent = String(imgCount);

      updateKpis();
    }

    function renderImages() {
      const grid = $('imagesGrid');
      grid.innerHTML = '';

      const p = state.selectedSlug ? getProjectBySlug(state.selectedSlug) : null;
      if (!p) return;

      const slug = String(p.slug);
      const order = getOrderedVisibleImagesForProject(p);
      const coverPref = state.pending.coverEdits.get(slug);
      let effectiveCover = coverPref || String(p.cover || '') || (order[0] || '');
      if (effectiveCover && state.pending.deletes.has(effectiveCover)) effectiveCover = order[0] || '';

      for (let idx = 0; idx < order.length; idx++) {
        const path = order[idx];
        const staged = getStagedUploadByTargetPath(slug, path);
        const card = document.createElement('div');
        const isSel = state.ui.selectedImages.has(String(path));
        card.className = 'img' + (isSel ? ' sel' : '');
        card.addEventListener('click', () => openImageModal(path));

        const thumb = document.createElement('div');
        thumb.className = 'thumb';

        const selBox = document.createElement('div');
        selBox.className = 'selBox';
        const cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.checked = isSel;
        cb.addEventListener('click', (e) => {
          try { e.preventDefault(); e.stopPropagation(); } catch (x) {}
          toggleImageSelection(path);
        });
        selBox.addEventListener('click', (e) => {
          try { e.preventDefault(); e.stopPropagation(); } catch (x) {}
          toggleImageSelection(path);
        });
        selBox.appendChild(cb);
        thumb.appendChild(selBox);

        const im = document.createElement('img');
        im.loading = 'lazy';
        im.src = staged && staged.previewUrl ? staged.previewUrl : String(path);
        im.alt = '';
        thumb.appendChild(im);

        const meta = document.createElement('div');
        meta.className = 'meta';
        const name = document.createElement('div');
        name.className = 'name';
        const fileName = String(path).split('/').pop() || String(path);
        name.textContent = staged ? (`(جديد) ${fileName}`) : fileName;

        meta.appendChild(name);

        card.appendChild(thumb);
        card.appendChild(meta);
        grid.appendChild(card);
      }

      renderImageModal();
      updateSelectionBar();
    }

    function updateSelectionBar() {
      const bar = $('selectionBar');
      if (!bar) return;
      const p = state.selectedSlug ? getProjectBySlug(state.selectedSlug) : null;
      const hasProject = !!p;

      // prune selections that no longer exist
      if (p) {
        const visible = new Set(getVisibleImagesForProject(p).map(x => String(x)));
        for (const x of Array.from(state.ui.selectedImages)) {
          if (!visible.has(String(x))) state.ui.selectedImages.delete(String(x));
        }
      } else {
        state.ui.selectedImages.clear();
      }

      const count = state.ui.selectedImages.size;
      $('selectedCount').textContent = `المحدد: ${count}`;

      const btnAll = $('btnSelectAll');
      const btnNone = $('btnSelectNone');
      const btnDel = $('btnDeleteSelected');
      const btnCover = $('btnSetCoverSelected');

      const visibleCount = p ? getVisibleImagesForProject(p).length : 0;

      btnAll.disabled = !hasProject || visibleCount === 0;
      btnNone.disabled = !hasProject || count === 0;
      btnDel.disabled = !hasProject || count === 0;
      btnCover.disabled = !hasProject || count !== 1;
    }

    function toggleImageSelection(path) {
      const k = String(path);
      if (!k) return;
      if (state.ui.selectedImages.has(k)) state.ui.selectedImages.delete(k);
      else state.ui.selectedImages.add(k);
      renderImages();
    }

    function selectAllVisibleImages() {
      const p = state.selectedSlug ? getProjectBySlug(state.selectedSlug) : null;
      if (!p) return;
      state.ui.selectedImages.clear();
      for (const x of getVisibleImagesForProject(p)) state.ui.selectedImages.add(String(x));
      renderImages();
    }

    function clearImageSelection() {
      state.ui.selectedImages.clear();
      renderImages();
    }

    function deleteSelectedImagesLocal() {
      const p = state.selectedSlug ? getProjectBySlug(state.selectedSlug) : null;
      if (!p) return;
      const items = Array.from(state.ui.selectedImages);
      if (!items.length) return;
      const ok = confirm(`تأكيد حذف ${items.length} صورة؟ سيتم حذفها من GitHub عند النشر.`);
      if (!ok) return;

      // delete without asking per-image
      for (const path of items) {
        state.pending.deletes.add(path);

        const slug = String(p.slug);
        const pref = state.pending.orderEdits.get(slug);
        if (pref && Array.isArray(pref)) {
          state.pending.orderEdits.set(slug, pref.filter(x => String(x) !== String(path)));
        }
        const c = state.pending.coverEdits.get(slug);
        if (c && String(c) === String(path)) {
          const order = getOrderedVisibleImagesForProject(p);
          state.pending.coverEdits.set(slug, order[0] || '');
        }
      }

      state.ui.selectedImages.clear();
      state.pending.dirtyJson = true;
      updateEditorState();
      renderImages();
      renderProjects();
      setLog('✓ تم حذف الصور المحددة محليًا\nجاهز للنشر. اضغط "رفع ونشر الآن".', 'ok');

      if (state.ui.imgModalOpen && state.ui.imgModalPath && state.pending.deletes.has(String(state.ui.imgModalPath))) {
        closeImageModal();
      }
    }

    function setCoverFromSelection() {
      const only = Array.from(state.ui.selectedImages);
      if (only.length !== 1) return;
      setCoverLocal(only[0]);
      state.ui.selectedImages.clear();
      renderImages();
    }

    function clearPendingUploads() {
      try {
        for (const u of state.pending.uploads) {
          try { if (u && u.previewUrl) URL.revokeObjectURL(u.previewUrl); } catch (e) {}
        }
      } catch (e) {}
      state.pending.uploads = [];
    }

    function removeStagedUpload(u) {
      if (!u) return;
      const idx = state.pending.uploads.indexOf(u);
      if (idx !== -1) {
        try { if (u.previewUrl) URL.revokeObjectURL(u.previewUrl); } catch (e) {}
        state.pending.uploads.splice(idx, 1);
      }

      const slug = String(u.projectSlug || '');
      if (slug) {
        const pref = state.pending.orderEdits.get(slug);
        if (pref && Array.isArray(pref)) {
          state.pending.orderEdits.set(slug, pref.filter(x => String(x) !== String(u.targetPath)));
        }
        const c = state.pending.coverEdits.get(slug);
        if (c && String(c) === String(u.targetPath)) {
          const p = getProjectBySlug(slug);
          if (p) {
            const order = getOrderedVisibleImagesForProject(p);
            state.pending.coverEdits.set(slug, order[0] || '');
          } else {
            state.pending.coverEdits.delete(slug);
          }
        }
      }

      state.pending.dirtyJson = true;
      updateEditorState();
      renderImages();
      renderProjects();
      setLog('✓ تم إزالة صورة من قائمة النشر\nجاهز للنشر.', 'ok');

      if (state.ui.imgModalOpen && String(state.ui.imgModalPath) === String(u.targetPath)) {
        closeImageModal();
      }
    }

    function sanitizeUploadFilename(name) {
      const s = String(name || '').trim();
      const base = s.replace(/[^a-z0-9\-_.]/gi, '_').replace(/_+/g, '_');
      if (!base) return '';
      const withExt = /\.(jpg|jpeg|png|webp)$/i.test(base) ? base : `${base}.jpg`;
      return withExt;
    }

    function stageRenameUpload(u, newName) {
      if (!u) return;
      const cleaned = sanitizeUploadFilename(newName);
      if (!cleaned) return;

      const slug = String(u.projectSlug || '');
      const dir = String(u.targetPath || '').split('/').slice(0, -1).join('/');
      const nextTarget = dir ? `${dir}/${cleaned}` : cleaned;

      const conflict = state.pending.uploads.some(x => x && String(x.projectSlug) === slug && x !== u && String(x.targetPath) === nextTarget);
      if (conflict) return;

      const oldTarget = u.targetPath;
      u.name = cleaned;
      u.targetPath = nextTarget;

      if (state.ui.imgModalOpen && String(state.ui.imgModalPath) === String(oldTarget)) {
        state.ui.imgModalPath = nextTarget;
      }

      const pref = state.pending.orderEdits.get(slug);
      if (pref && Array.isArray(pref)) {
        state.pending.orderEdits.set(slug, pref.map(x => (String(x) === String(oldTarget) ? nextTarget : x)));
      }
      const c = state.pending.coverEdits.get(slug);
      if (c && String(c) === String(oldTarget)) {
        state.pending.coverEdits.set(slug, nextTarget);
      }

      state.pending.dirtyJson = true;
      updateEditorState();
      renderImages();
      renderProjects();
    }

    function setCoverLocal(path) {
      const p = state.selectedSlug ? getProjectBySlug(state.selectedSlug) : null;
      if (!p) return;
      state.pending.coverEdits.set(String(p.slug), String(path));
      state.pending.dirtyJson = true;
      renderProjects();
      updateEditorState();
      renderImages();
      setLog('✓ تم تعيين الغلاف محليًا\nجاهز للنشر. اضغط "رفع ونشر الآن".', 'ok');
      renderImageModal();
    }

    function moveImageLocal(path, dir) {
      const p = state.selectedSlug ? getProjectBySlug(state.selectedSlug) : null;
      if (!p) return;
      const slug = String(p.slug);
      const order = getOrderedVisibleImagesForProject(p).slice();
      const i = order.findIndex(x => String(x) === String(path));
      if (i === -1) return;
      const j = i + dir;
      if (j < 0 || j >= order.length) return;
      const tmp = order[i];
      order[i] = order[j];
      order[j] = tmp;
      state.pending.orderEdits.set(slug, order);
      if (!state.pending.coverEdits.has(slug)) {
        state.pending.coverEdits.set(slug, order[0] || '');
      }
      state.pending.dirtyJson = true;
      renderProjects();
      updateEditorState();
      renderImages();
      setLog('✓ تم تحديث ترتيب الصور محليًا\nجاهز للنشر. اضغط "رفع ونشر الآن".', 'ok');
      renderImageModal();
    }

    function nextNumberForProject(p) {
      const rx = /^(\d{3,})/;
      let max = 0;
      for (const img of (Array.isArray(p.images) ? p.images : [])) {
        const file = String(img).split('/').pop() || '';
        const m = file.match(rx);
        if (m && m[1]) {
          const n = parseInt(m[1], 10);
          if (!Number.isNaN(n)) max = Math.max(max, n);
        }
      }
      for (const u of getStagedUploadsForProject(p.slug)) {
        const m = String(u.name || '').match(rx);
        if (m && m[1]) {
          const n = parseInt(m[1], 10);
          if (!Number.isNaN(n)) max = Math.max(max, n);
        }
      }
      return max + 1;
    }

    function pickFiles(files) {
      const p = state.selectedSlug ? getProjectBySlug(state.selectedSlug) : null;
      const picked = Array.from(files || []);
      if (!p || !picked.length) return;

      const baseDir = `assets/site_images/projects/portfolio_projects/${p.slug}`;
      const used = new Set((Array.isArray(p.images) ? p.images : []).map(x => String(x).split('/').pop() || ''));
      for (const u of getStagedUploadsForProject(p.slug)) {
        used.add(String(u.name || '').trim());
      }
      let n = nextNumberForProject(p);

      const uploads = [];
      for (const f of picked) {
        let name;
        do {
          name = `${String(n).padStart(3, '0')}.jpg`;
          n++;
        } while (used.has(name));
        used.add(name);
        const relPath = `${baseDir}/${name}`;
        const previewUrl = URL.createObjectURL(f);
        uploads.push({ file: f, optimizedFile: null, targetPath: relPath, name, previewUrl, projectSlug: p.slug });
      }

      state.pending.uploads = state.pending.uploads.concat(uploads);
      state.pending.dirtyJson = true;

      const normalized = getOrderedVisibleImagesForProject(p);
      state.pending.orderEdits.set(String(p.slug), normalized);
      if (!state.pending.coverEdits.has(String(p.slug))) {
        state.pending.coverEdits.set(String(p.slug), normalized[0] || '');
      }

      setLog(`✓ تم اختيار ${uploads.length} صورة\nجاهز للنشر. اضغط "رفع ونشر الآن".`, 'ok');
      updateEditorState();
      renderImages();
      renderProjects();
    }

    function saveNamesLocal() {
      const p = state.selectedSlug ? getProjectBySlug(state.selectedSlug) : null;
      if (!p) return;
      const titleAr = String($('titleAr').value || '').trim() || null;
      const titleEn = String($('titleEn').value || '').trim() || null;
      const title = (String(titleEn || '').trim() || String(titleAr || '').trim() || p.slug);
      state.pending.nameEdits.set(String(p.slug), { titleAr, titleEn, title });
      state.pending.dirtyJson = true;
      renderProjects();
      updateEditorState();
      setLog('✓ تم حفظ الاسم محليًا\nجاهز للنشر. اضغط "رفع ونشر الآن".', 'ok');
    }

    function deleteImageLocal(path) {
      const p = state.selectedSlug ? getProjectBySlug(state.selectedSlug) : null;
      if (!p || !Array.isArray(p.images)) return;
      const ok = confirm('تأكيد حذف الصورة؟ سيتم حذفها من GitHub عند النشر.');
      if (!ok) return;

      try { state.ui.selectedImages.delete(String(path)); } catch (e) {}

      state.pending.deletes.add(path);
      state.pending.dirtyJson = true;

      const slug = String(p.slug);
      const pref = state.pending.orderEdits.get(slug);
      if (pref && Array.isArray(pref)) {
        state.pending.orderEdits.set(slug, pref.filter(x => String(x) !== String(path)));
      }
      const c = state.pending.coverEdits.get(slug);
      if (c && String(c) === String(path)) {
        const order = getOrderedVisibleImagesForProject(p);
        state.pending.coverEdits.set(slug, order[0] || '');
      }

      updateEditorState();
      renderImages();
      renderProjects();
      setLog('✓ تم حذف الصورة محليًا\nجاهز للنشر. اضغط "رفع ونشر الآن".', 'ok');

      if (state.ui.imgModalOpen && String(state.ui.imgModalPath) === String(path)) {
        closeImageModal();
      }
    }

    function deleteProjectLocal() {
      const p = state.selectedSlug ? getProjectBySlug(state.selectedSlug) : null;
      if (!p) return;
      const ok = confirm(`تأكيد حذف المشروع: ${getProjectTitle(p)} ؟`);
      if (!ok) return;

      if (Array.isArray(p.images)) {
        for (const img of p.images) state.pending.deletes.add(img);
      }

      state.pending.projectDeletes.add(String(p.slug));
      state.pending.nameEdits.delete(String(p.slug));
      state.pending.coverEdits.delete(String(p.slug));
      state.pending.orderEdits.delete(String(p.slug));

      // remove staged uploads for this project (since it will be deleted)
      const keep = [];
      for (const u of state.pending.uploads) {
        if (u && String(u.projectSlug) === String(p.slug)) {
          try { if (u.previewUrl) URL.revokeObjectURL(u.previewUrl); } catch (e) {}
        } else {
          keep.push(u);
        }
      }
      state.pending.uploads = keep;

      state.selectedSlug = null;
      state.pending.dirtyJson = true;

      renderProjects();
      updateEditorState();
      renderImages();
      setLog('✓ تم حذف المشروع محليًا\nجاهز للنشر. اضغط "رفع ونشر الآن".', 'ok');
    }

    async function newProjectFlow() {
      const titleAr = prompt('اسم المشروع (AR):');
      const titleEn = prompt('اسم المشروع (EN):');
      const base = String(titleEn || titleAr || '').trim();
      if (!base) {
        setLog('❌ فشل\nالسبب: اسم المشروع فارغ', 'danger');
        return;
      }
      let slug = slugify(prompt('Slug (اختياري):') || base);
      const exists = (state.data.projects || []).some(p => String(p.slug) === String(slug));
      if (exists) {
        slug = `${slug}-${Math.floor(Math.random()*900+100)}`;
      }
      const proj = { slug, titleAr: titleAr ? String(titleAr).trim() : null, titleEn: titleEn ? String(titleEn).trim() : null, title: String(titleEn || titleAr || slug).trim(), images: [], cover: '', imageCount: 0 };
      state.data.projects.push(proj);
      state.data.count = state.data.projects.length;
      state.pending.dirtyJson = true;
      state.selectedSlug = slug;
      renderProjects();
      updateEditorState();
      renderImages();
      setLog('✓ تم إنشاء مشروع محليًا\nجاهز للنشر. اضغط "رفع ونشر الآن".', 'ok');
    }

    function arrayBufferToBase64(buffer) {
      let binary = '';
      const bytes = new Uint8Array(buffer);
      for (let i = 0; i < bytes.byteLength; i++) binary += String.fromCharCode(bytes[i]);
      return btoa(binary);
    }

    async function fileToBase64(file) {
      const buf = await file.arrayBuffer();
      return arrayBufferToBase64(buf);
    }

    async function optimizeImageFile(file, options) {
      const opts = options || {};
      const maxBytes = typeof opts.maxBytes === 'number' ? opts.maxBytes : 700 * 1024;
      const maxDim = typeof opts.maxDim === 'number' ? opts.maxDim : 2000;

      if (!file) return { file: null, changed: false };
      const type = String(file.type || '').toLowerCase();
      if (!type.startsWith('image/')) return { file, changed: false };
      if (file.size <= maxBytes) return { file, changed: false };

      let imgBitmap = null;
      try {
        imgBitmap = await createImageBitmap(file);
      } catch (e) {
        return { file, changed: false };
      }

      let w = imgBitmap.width || 1;
      let h = imgBitmap.height || 1;
      const scale = Math.min(1, maxDim / Math.max(w, h));
      const tw = Math.max(1, Math.round(w * scale));
      const th = Math.max(1, Math.round(h * scale));

      const canvas = document.createElement('canvas');
      canvas.width = tw;
      canvas.height = th;
      const ctx = canvas.getContext('2d', { alpha: false });
      ctx.drawImage(imgBitmap, 0, 0, tw, th);

      let outBlob = null;
      let quality = 0.84;
      for (let i = 0; i < 9; i++) {
        outBlob = await new Promise((resolve) => canvas.toBlob(resolve, 'image/jpeg', quality));
        if (outBlob && outBlob.size <= maxBytes) break;
        quality = Math.max(0.45, quality - 0.07);
      }

      if (!outBlob || outBlob.size > maxBytes) return { file, changed: false };

      const base = String(file.name || 'image').replace(/\.[a-z0-9]+$/i, '');
      const outName = `${base}.jpg`;
      return { file: new File([outBlob], outName, { type: 'image/jpeg' }), changed: true };
    }

    function utf8ToBase64(str) {
      return btoa(unescape(encodeURIComponent(str)));
    }

    async function putImageWithRetry(gh, repoPath, message, base64, branch) {
      const tooBig = base64 && base64.length > 980000;
      if (tooBig) {
        throw new Error('حجم الصورة كبير جدًا بعد التحويل. حاول رفع صورة أصغر أو اترك الأدمن يضغطها أكثر.');
      }

      function shouldRetry(e) {
        const status = (e && typeof e.status !== 'undefined') ? Number(e.status) : null;
        const msg = String(e && e.message ? e.message : e).toLowerCase();
        const isNet = msg.includes('failed to fetch') || msg.includes('networkerror') || (!e || typeof e.status === 'undefined');
        if (isNet) return true;
        if (status === 429) return true;
        if (status === 500 || status === 502 || status === 503 || status === 504) return true;
        if (status === 403 && (msg.includes('secondary rate limit') || msg.includes('rate limit') || msg.includes('api rate limit'))) return true;
        return false;
      }

      for (let attempt = 1; attempt <= 5; attempt++) {
        try {
          try {
            await gh.putFile(repoPath, message, base64, undefined);
            return;
          } catch (e) {
            if (e && e.status === 422) {
              let sha = undefined;
              try {
                const meta = await gh.getFileMeta(repoPath, branch, true);
                if (meta && meta.sha) sha = meta.sha;
              } catch (e2) {}
              await gh.putFile(repoPath, message, base64, sha);
              return;
            }
            throw e;
          }
        } catch (e) {
          if (!shouldRetry(e) || attempt === 5) throw e;
          const base = 700 * attempt * attempt;
          const jitter = Math.floor(Math.random() * 250);
          await sleep(base + jitter);
        }
      }
    }

    function isNotFoundError(e) {
      const msg = String(e && e.message ? e.message : e);
      return (e && e.status === 404) || msg.toLowerCase().includes('not found') || msg.toLowerCase().includes('404');
    }

    function isAuthError(e) {
      const msg = String(e && e.message ? e.message : e);
      return (e && (e.status === 401 || e.status === 403)) || msg.toLowerCase().includes('bad credentials') || msg.toLowerCase().includes('requires authentication');
    }

    async function putPortfolioJsonWithRetry(gh, payload, branch) {
      const jsonPath = 'data/portfolio_projects.json';
      const jsonB64 = utf8ToBase64(JSON.stringify(payload, null, 2));

      for (let attempt = 1; attempt <= 6; attempt++) {
        try {
          let sha = undefined;
          try {
            const meta = await gh.getFileMeta(jsonPath, branch, true);
            if (meta && meta.sha) sha = meta.sha;
          } catch (e) {}
          await gh.putFile(jsonPath, 'Update portfolio projects data', jsonB64, sha);
          return;
        } catch (e) {
          const msg = String(e && e.message ? e.message : e);
          const isShaMismatch = msg.toLowerCase().includes('does not match') || msg.toLowerCase().includes('sha') || e.status === 409;
          if (!isShaMismatch || attempt === 6) throw e;
          await new Promise(r => setTimeout(r, 450 * attempt * attempt));
        }
      }
    }

    function sitePathToRepoPath(sitePath) {
      let p = String(sitePath || '').trim();
      if (!p) return '';
      if (/^https?:\/\//i.test(p)) {
        try {
          const u = new URL(p);
          p = u.pathname || '';
        } catch (e) {}
      }
      p = p.split('#')[0].split('?')[0];
      p = p.replace(/^\.\//, '').replace(/^\//, '');
      return p;
    }

    function createGithubClient(owner, repo, branch, token, apiBase) {
      const base = String(apiBase || '').trim() || 'https://api.github.com';
      const headers = () => ({
        'Accept': 'application/vnd.github+json',
        'Authorization': `Bearer ${token}`
      });

      const contentsUrl = (path, ref, bustCache) => {
        const enc = encodeURIComponent(path).replace(/%2F/g, '/');
        const qs = [];
        if (ref) qs.push(`ref=${encodeURIComponent(ref)}`);
        if (bustCache) qs.push(`ts=${Date.now()}`);
        return `${base}/repos/${owner}/${repo}/contents/${enc}` + (qs.length ? `?${qs.join('&')}` : '');
      };

      const requestJson = async (url, method, payload) => {
        let res;
        let text = '';
        try {
          res = await fetch(url, {
            method,
            cache: 'no-store',
            headers: payload ? { ...headers(), 'Content-Type': 'application/json' } : headers(),
            body: payload ? JSON.stringify(payload) : undefined
          });
          text = await res.text();
        } catch (e) {
          const origin = (typeof location !== 'undefined' && location) ? String(location.origin || '') : '';
          const proto = (typeof location !== 'undefined' && location) ? String(location.protocol || '') : '';
          const hint = (proto === 'file:' || origin === 'null')
            ? 'الحل: افتح الصفحة عبر http://localhost أو عبر GitHub Pages (ليس file://)'
            : 'الحل: تأكد من الإنترنت + جرّب تعطيل VPN/AdBlock/Firewall الذي قد يحجب api.github.com + جرّب شبكة أخرى';
          const err = new Error(`Failed to fetch\n${hint}`);
          err.cause = e;
          throw err;
        }

        let body = null;
        try { body = text ? JSON.parse(text) : null; } catch (e) {}
        if (!res.ok) {
          const msg = body && body.message ? body.message : text;
          const err = new Error(msg || `GitHub error: ${res.status}`);
          err.status = res.status;
          err.body = body;
          throw err;
        }
        return body;
      };

      const getFileMeta = (path, ref, bustCache) => requestJson(contentsUrl(path, ref, bustCache), 'GET');
      const putFile = (path, message, contentBase64, sha) => requestJson(contentsUrl(path, null), 'PUT', { message, content: contentBase64, branch, sha });
      const deleteFile = (path, message, sha) => requestJson(contentsUrl(path, null), 'DELETE', { message, branch, sha });

      return { getFileMeta, putFile, deleteFile };
    }

    async function testGithubConnection() {
      try {
        const token = getEffectiveToken();
        if (!token) {
          setLog('❌ اختبار الاتصال فشل\nالسبب: GitHub Token غير موجود\nالحل: الصق التوكن أو اضغط تذكّر', 'danger');
          return;
        }

        const apiBase = getGithubApiBase();

        setLog('⏳ جاري اختبار اتصال GitHub...', '');

        try {
          const res = await fetch(`${apiBase}/rate_limit`, {
            method: 'GET',
            cache: 'no-store',
            headers: {
              'Accept': 'application/vnd.github+json',
              'Authorization': `Bearer ${token}`
            }
          });
          if (!res.ok) {
            const t = await res.text();
            throw new Error(t || `HTTP ${res.status}`);
          }
        } catch (e) {
          const proto = (typeof location !== 'undefined' && location) ? String(location.protocol || '') : '';
          const origin = (typeof location !== 'undefined' && location) ? String(location.origin || '') : '';
          const hint = (proto === 'file:' || origin === 'null')
            ? 'الحل: افتح الصفحة عبر http://localhost أو عبر GitHub Pages (ليس file://)'
            : 'الحل: قد يكون api.github.com محجوب (VPN/Firewall/AdBlock/شبكة الشركة). جرّب شبكة أخرى.';
          setLog(`❌ اختبار الاتصال فشل\nالسبب: Failed to fetch\n${hint}`, 'danger');
          return;
        }

        const branches = Array.isArray(GITHUB_PUBLISH_BRANCHES) && GITHUB_PUBLISH_BRANCHES.length ? GITHUB_PUBLISH_BRANCHES : [GITHUB_BRANCH];
        for (const branch of branches) {
          const gh = createGithubClient(GITHUB_OWNER, GITHUB_REPO, branch, token, apiBase);
          await gh.getFileMeta('data/portfolio_projects.json', branch, true);
        }

        setLog('✓ اختبار الاتصال ناجح\nيمكنك الآن النشر بأمان.', 'ok');
      } catch (e) {
        if (isAuthError(e)) {
          setLog('❌ اختبار الاتصال فشل\nالسبب: Token غير صحيح/بدون صلاحية\nالحل: أنشئ Token بصلاحية repo + contents ثم جرّب', 'danger');
        } else {
          setLog(`❌ اختبار الاتصال فشل\nالسبب: ${String(e && e.message ? e.message : e)}`, 'danger');
        }
      }
    }

    async function publishNow() {
      if (state.publishInFlight) return;
      state.publishInFlight = true;

      try {
        const token = getEffectiveToken();
        if (!token) {
          setLog('❌ فشل الرفع\nالسبب: GitHub Token غير موجود\nالحل: الصق التوكن أو اضغط تذكّر', 'danger');
          return;
        }

        const uploads = state.pending.uploads.filter(u => u && u.file && u.targetPath);
        const deletes = Array.from(state.pending.deletes.values());
        const hasPending = uploads.length > 0 || deletes.length > 0 || state.pending.dirtyJson;
        if (!hasPending) {
          setLog('لا توجد تغييرات للنشر.', 'ok');
          return;
        }

        // build a payload that includes staged changes without mutating state.data yet
        const uploadsBySlug = new Map();
        for (const u of uploads) {
          const slug = String(u.projectSlug || '');
          if (!uploadsBySlug.has(slug)) uploadsBySlug.set(slug, []);
          uploadsBySlug.get(slug).push(u.targetPath);
        }

        const projects = (state.data.projects || [])
          .filter(p => p && !state.pending.projectDeletes.has(String(p.slug)))
          .map(p => {
            const edited = state.pending.nameEdits.get(String(p.slug));
            return {
              ...p,
              ...(edited || {}),
              images: Array.isArray(p.images) ? p.images.slice() : []
            };
          });

        for (const p of projects) {
          const slug = String(p.slug);
          const kept = (p.images || []).filter(img => !state.pending.deletes.has(img));
          const add = uploadsBySlug.get(slug) || [];
          const universe = kept.concat(add);

          const pref = state.pending.orderEdits.get(slug);
          let ordered = normalizeOrderForProject({ ...p, images: universe }, pref);
          ordered = ordered.filter(x => universe.includes(x));
          for (const x of universe) {
            if (!ordered.includes(x)) ordered.push(x);
          }

          p.images = ordered;

          const coverPref = state.pending.coverEdits.get(slug);
          let cover = coverPref || String(p.cover || '') || (p.images[0] || '');
          if (cover && !p.images.includes(cover)) cover = p.images[0] || '';
          p.cover = cover;
          p.imageCount = p.images.length;
        }

        const publishedAt = Date.now();

        const payload = {
          source: 'portfolio_projects',
          publishedAt,
          count: projects.length,
          projects
        };

        const branches = Array.isArray(GITHUB_PUBLISH_BRANCHES) && GITHUB_PUBLISH_BRANCHES.length ? GITHUB_PUBLISH_BRANCHES : [GITHUB_BRANCH];

        let anyUploadFailed = false;
        const failedUploads = [];

        for (let b = 0; b < branches.length; b++) {
          const branch = branches[b];
          const apiBase = getGithubApiBase();
          const gh = createGithubClient(GITHUB_OWNER, GITHUB_REPO, branch, token, apiBase);

          if (uploads.length) {
            const total = uploads.length;
            let done = 0;

            const concurrency = isLocalhost() ? 3 : 1;
            const results = await runWithConcurrency(uploads, concurrency, async (u, i) => {
              const repoPath = sitePathToRepoPath(u.targetPath);
              done++;
              setLog(`⏳ جاري الرفع...\n✓ تم رفع ${done}/${total} صورة\nالآن: ${repoPath}\nالفرع: ${branch}`, '');

              let fileToSend = u.optimizedFile || u.file;
              try {
                if (!u.optimizedFile && u.file && u.file.size > 700 * 1024) {
                  const resOpt = await optimizeImageFile(u.file, { maxBytes: 700 * 1024, maxDim: 2000 });
                  if (resOpt && resOpt.file && resOpt.changed) {
                    u.optimizedFile = resOpt.file;
                    fileToSend = u.optimizedFile;
                  }
                }
              } catch (e) {}

              const b64 = await fileToBase64(fileToSend);
              await putImageWithRetry(gh, repoPath, `Update portfolio image: ${repoPath}`, b64, branch);
              if (!isLocalhost()) await sleep(450);
              return repoPath;
            });

            for (let i = 0; i < results.length; i++) {
              const r = results[i];
              if (!r || r.ok) continue;
              anyUploadFailed = true;
              try {
                const u = uploads[i];
                failedUploads.push({ branch, path: u && u.targetPath ? String(u.targetPath) : '(unknown)', error: r.error });
              } catch (e) {
                failedUploads.push({ branch, path: '(unknown)', error: r.error });
              }
            }
          }

          if (deletes.length) {
            for (let i = 0; i < deletes.length; i++) {
              const rp = sitePathToRepoPath(deletes[i]);
              setLog(`⏳ جاري الحذف...\n✓ تم حذف ${i}/${deletes.length} صورة\nالآن: ${rp}`, '');
              try {
                const meta = await gh.getFileMeta(rp, branch, true);
                if (meta && meta.sha) {
                  await gh.deleteFile(rp, `Delete portfolio image: ${rp}`, meta.sha);
                }
              } catch (e) {
                if (!isNotFoundError(e)) throw e;
              }
            }
          }

          if (!anyUploadFailed) {
            setLog(`${uploads.length ? `✓ تم رفع ${uploads.length} صورة\n` : ''}${deletes.length ? `✓ تم حذف ${deletes.length} صورة\n` : ''}⏳ جاري تحديث البيانات...`, '');
            await putPortfolioJsonWithRetry(gh, payload, branch);
          }
        }

        if (anyUploadFailed) {
          const lines = failedUploads.slice(0, 6).map(x => {
            const st = (x && x.error && typeof x.error.status !== 'undefined') ? ` (HTTP ${x.error.status})` : '';
            const msg = (x && x.error && x.error.message) ? String(x.error.message).split('\n')[0] : '';
            const suffix = msg ? ` — ${msg}` : '';
            return `- ${x.branch}: ${x.path}${st}${suffix}`;
          });
          const more = failedUploads.length > 6 ? `\n... +${failedUploads.length - 6}` : '';
          setLog(`❌ تم رفع بعض الصور وفشل البعض\nلن يتم تحديث البيانات (JSON) حتى لا تظهر صور غير مرفوعة.\nأعد المحاولة بعد قليل.\n\nأمثلة للفشل (مع السبب):\n${lines.join('\n')}${more}`, 'danger');
          return;
        }

        // commit staged changes locally (mirror payload)
        state.data.projects = payload.projects;
        state.data.count = payload.count;

        state.pending.deletes.clear();
        state.pending.projectDeletes.clear();
        state.pending.nameEdits.clear();
        state.pending.coverEdits.clear();
        state.pending.orderEdits.clear();
        clearPendingUploads();
        state.pending.dirtyJson = false;

        updateEditorState();
        try {
          localStorage.setItem('artrova_last_published_at', String(publishedAt));
        } catch (e) {}
        updateOpenFreshBtn();
        setLog(`✓ تم النشر بنجاح!\n${uploads.length ? `✓ تم رفع ${uploads.length} صورة` : ''}${uploads.length && deletes.length ? '\n' : ''}${deletes.length ? `✓ تم حذف ${deletes.length} صورة` : ''}\n\nافتح الموقع بتحديث: ?v=${publishedAt}`, 'ok');
      } catch (e) {
        if (isAuthError(e)) {
          setLog('❌ فشل الرفع\nالسبب: GitHub Token غير صحيح أو ليس لديه صلاحية\nالحل: أنشئ Token بصلاحية repo + contents ثم جرّب', 'danger');
        } else {
          setLog(`❌ فشل\nالسبب: ${String(e && e.message ? e.message : e)}`, 'danger');
        }
      } finally {
        state.publishInFlight = false;
      }
    }

    function selectProject(slug) {
      closeImageModal();
      state.selectedSlug = slug || null;
      state.ui.selectedImages.clear();
      // keep pending changes across project switches; user can publish or reload to reset

      renderProjects();
      updateEditorState();
      renderImages();
      updateKpis();

      if (!slug) {
        setLog('اختر مشروع للبدء.', '');
        return;
      }

      const p = getProjectBySlug(slug);
      if (!p) {
        setLog('المشروع غير موجود.', 'danger');
        return;
      }

      setLog('جاهز. اختر صور أو عدّل الاسم أو احذف.', 'ok');
    }

    async function reloadData() {
      try {
        closeImageModal();
        await loadPortfolioJson(true);
        renderProjects();
        if (state.selectedSlug && !getProjectBySlug(state.selectedSlug)) state.selectedSlug = null;
        selectProject(state.selectedSlug);
        setLog('✓ تم تحديث البيانات من الموقع.', 'ok');
      } catch (e) {
        setLog(`❌ تعذر تحميل البيانات\nالسبب: ${String(e && e.message ? e.message : e)}`, 'danger');
      }
    }

    function showApp() {
      $('loginCard').classList.add('hidden');
      $('app').classList.remove('hidden');
      try { document.body.classList.add('ui-ready'); } catch (e) {}
    }

    function updateOpenFreshBtn() {
      const btn = $('btnOpenSiteFresh');
      if (!btn) return;
      let v = '';
      try { v = String(localStorage.getItem('artrova_last_published_at') || '').trim(); } catch (e) {}
      btn.disabled = !v;
    }

    function showLogin() {
      $('app').classList.add('hidden');
      $('loginCard').classList.remove('hidden');
      try { document.body.classList.add('ui-ready'); } catch (e) {}
    }

    async function boot() {
      setEnvPill();
      $('fileProtoNotice').classList.toggle('hidden', !isFileProtocol());

      setCompactMode(getCompactMode());
      $('btnCompact').addEventListener('click', () => {
        const on = !document.body.classList.contains('compact');
        setCompactMode(on);
      });

      $('btnLogin').addEventListener('click', async () => {
        const pass = String($('adminPass').value || '');
        if (pass !== ADMIN_PASSWORD) {
          alert('باسورد غير صحيح');
          return;
        }
        state.authed = true;
        showApp();
        await reloadData();
        setLog('✓ تم تسجيل الدخول. اختر مشروع.', 'ok');
      });

      $('btnLogout').addEventListener('click', () => {
        state.authed = false;
        showLogin();
      });

      $('btnRemember').addEventListener('click', rememberToken);
      $('btnTestGh').addEventListener('click', testGithubConnection);
      $('btnReload').addEventListener('click', reloadData);
      $('btnPublish').addEventListener('click', publishNow);

      $('btnSelectAll').addEventListener('click', selectAllVisibleImages);
      $('btnSelectNone').addEventListener('click', clearImageSelection);
      $('btnDeleteSelected').addEventListener('click', deleteSelectedImagesLocal);
      $('btnSetCoverSelected').addEventListener('click', setCoverFromSelection);

      $('imgModalClose').addEventListener('click', closeImageModal);
      $('imgModalBackdrop').addEventListener('click', closeImageModal);
      document.addEventListener('keydown', (e) => {
        if (e && e.key === 'Escape' && state.ui.imgModalOpen) closeImageModal();
      });

      $('btnModalCover').addEventListener('click', () => {
        if (!state.ui.imgModalOpen) return;
        setCoverLocal(state.ui.imgModalPath);
      });
      $('btnModalPrev').addEventListener('click', () => {
        if (!state.ui.imgModalOpen) return;
        moveImageLocal(state.ui.imgModalPath, -1);
      });
      $('btnModalNext').addEventListener('click', () => {
        if (!state.ui.imgModalOpen) return;
        moveImageLocal(state.ui.imgModalPath, +1);
      });
      $('btnModalDelete').addEventListener('click', () => {
        if (!state.ui.imgModalOpen) return;
        const slug = String(state.ui.imgModalSlug || '');
        const path = String(state.ui.imgModalPath || '');
        const staged = slug ? getStagedUploadByTargetPath(slug, path) : null;
        if (staged) {
          removeStagedUpload(staged);
        } else {
          deleteImageLocal(path);
        }
      });
      $('imgModalName').addEventListener('input', (e) => {
        // keep typing smooth; apply on Enter via keydown and on change/blur
      });

      $('imgModalName').addEventListener('change', (e) => {
        if (!state.ui.imgModalOpen) return;
        const slug = String(state.ui.imgModalSlug || '');
        const path = String(state.ui.imgModalPath || '');
        const staged = slug ? getStagedUploadByTargetPath(slug, path) : null;
        if (!staged) return;
        stageRenameUpload(staged, String(e.target.value || ''));
      });

      $('imgModalName').addEventListener('keydown', (e) => {
        if (!e) return;
        if (e.key !== 'Enter') return;
        if (!state.ui.imgModalOpen) return;
        const slug = String(state.ui.imgModalSlug || '');
        const path = String(state.ui.imgModalPath || '');
        const staged = slug ? getStagedUploadByTargetPath(slug, path) : null;
        if (!staged) return;
        stageRenameUpload(staged, String(e.target.value || ''));
      });

      $('search').addEventListener('input', (e) => {
        state.filter = String(e.target.value || '');
        renderProjects();
      });

      $('projectSelect').addEventListener('change', (e) => {
        selectProject(String(e.target.value || ''));
      });

      $('filePicker').addEventListener('change', (e) => {
        pickFiles(e.target.files);
      });

      $('btnSaveNames').addEventListener('click', saveNamesLocal);
      $('btnDeleteProject').addEventListener('click', deleteProjectLocal);
      $('btnNewProject').addEventListener('click', newProjectFlow);

      updateOpenFreshBtn();
      const openFresh = $('btnOpenSiteFresh');
      if (openFresh) {
        openFresh.addEventListener('click', () => {
          let v = '';
          try { v = String(localStorage.getItem('artrova_last_published_at') || '').trim(); } catch (e) {}
          const qs = v ? `?v=${encodeURIComponent(v)}` : '';
          const url = `index.html${qs}`;
          try { window.open(url, '_blank', 'noopener'); } catch (e) { window.location.href = url; }
        });
      }

      try {
        const t = localStorage.getItem(TOKEN_STORE_KEY);
        if (t && $('ghToken')) $('ghToken').value = t;
      } catch (e) {}

      setApiMode(getApiMode());
      if ($('ghApiMode')) {
        // Proxy only makes sense on localhost. On GitHub Pages, force direct to avoid upload failures.
        if (!isLocalhost()) {
          setApiMode('direct');
          try { $('ghApiMode').value = 'direct'; } catch (e) {}
          try { $('ghApiMode').setAttribute('disabled', 'disabled'); } catch (e) {}
        }
        $('ghApiMode').addEventListener('change', (e) => {
          setApiMode(String(e.target.value || 'proxy'));
        });
      }

      showLogin();
    }

    boot();
  </script>
</body>
</html>
