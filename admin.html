<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>لوحة إدارة المشاريع | Artrova</title>
  <link rel="icon" type="image/svg+xml" href="assets/favicon.svg">
  <link rel="icon" type="image/png" sizes="32x32" href="assets/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="assets/favicon-16x16.png">
  <link rel="apple-touch-icon" sizes="180x180" href="assets/apple-touch-icon.png">
  <style>
    :root {
      --bg: #0b1220;
      --panel: #0f172a;
      --card: #111827;
      --text: #e5e7eb;
      --muted: rgba(229,231,235,0.7);
      --border: rgba(255,255,255,0.12);
      --primary: #f08ac0;
      --danger: #ef4444;
      --ok: #10b981;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1000px 700px at 20% -10%, rgba(240,138,192,0.18), transparent 55%),
                  radial-gradient(900px 600px at 90% 0%, rgba(56,189,248,0.16), transparent 55%),
                  var(--bg);
      color: var(--text);
      min-height: 100vh;
    }
    a { color: var(--primary); }
    .wrap { max-width: 1220px; margin: 0 auto; padding: 18px; }

    .topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding: 14px 16px;
      border: 1px solid var(--border);
      border-radius: 14px;
      background: rgba(17,24,39,0.7);
      backdrop-filter: blur(10px);
    }
    .topbar h1 { margin: 0; font-size: 1.05rem; font-weight: 900; }
    .topbar .hint { color: var(--muted); font-size: 0.9rem; }

    .grid {
      display: grid;
      grid-template-columns: 380px 1fr;
      gap: 16px;
      margin-top: 16px;
    }
    @media (max-width: 980px) { .grid { grid-template-columns: 1fr; } }

    .panel {
      border: 1px solid var(--border);
      border-radius: 14px;
      background: rgba(15, 23, 42, 0.66);
      backdrop-filter: blur(10px);
      overflow: hidden;
    }
    .panel-header {
      padding: 12px 14px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      border-bottom: 1px solid var(--border);
      background: rgba(17, 24, 39, 0.55);
    }
    .panel-header h2 { margin: 0; font-size: 0.98rem; }
    .panel-body { padding: 14px; }

    .row { display: flex; gap: 10px; flex-wrap: wrap; }
    .col { display: flex; flex-direction: column; gap: 8px; }

    label { font-size: 0.85rem; color: var(--muted); }
    input[type="text"], input[type="password"], input[type="url"], select, textarea {
      width: 100%;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(2,6,23,0.55);
      color: var(--text);
      outline: none;
    }
    textarea { min-height: 110px; resize: vertical; }

    .btn {
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.06);
      color: var(--text);
      cursor: pointer;
      font-weight: 800;
    }
    .btn:hover { border-color: rgba(255,255,255,0.2); }
    .btn.primary { background: rgba(240,138,192,0.2); border-color: rgba(240,138,192,0.45); }
    .btn.ok { background: rgba(16,185,129,0.16); border-color: rgba(16,185,129,0.42); }
    .btn.danger { background: rgba(239,68,68,0.14); border-color: rgba(239,68,68,0.5); }
    .btn.small { padding: 6px 10px; border-radius: 10px; font-size: 0.86rem; }

    .list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      max-height: 62vh;
      overflow: auto;
      padding-right: 6px;
    }
    .item {
      border: 1px solid var(--border);
      border-radius: 12px;
      background: rgba(2,6,23,0.35);
      padding: 10px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      cursor: pointer;
    }
    .item.active { border-color: rgba(240,138,192,0.6); box-shadow: 0 0 0 3px rgba(240,138,192,0.12); }
    .item .title { font-weight: 900; }
    .item .meta { color: var(--muted); font-size: 0.85rem; }

    .notice {
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(2,6,23,0.35);
      color: var(--muted);
      font-size: 0.92rem;
    }
    .notice.danger { border-color: rgba(239,68,68,0.55); color: rgba(255,255,255,0.92); }
    .notice.ok { border-color: rgba(16,185,129,0.55); color: rgba(255,255,255,0.92); }

    .imgs {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      gap: 12px;
    }
    .img-card {
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
      background: rgba(2,6,23,0.3);
      display: flex;
      flex-direction: column;
    }
    .img-card .thumb {
      width: 100%;
      height: 120px;
      background: rgba(255,255,255,0.04);
      display: grid;
      place-items: center;
      overflow: hidden;
    }
    .img-card img { width: 100%; height: 100%; object-fit: cover; display: block; }
    .img-card .body { padding: 10px; display: flex; flex-direction: column; gap: 8px; }
    .img-card .flags { display: flex; justify-content: space-between; gap: 8px; }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 0.85rem;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.06);
      color: var(--muted);
    }

    .hidden { display: none !important; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div>
        <h1>لوحة إدارة المشاريع</h1>
        <div class="hint">رفع/حذف صور، إضافة/حذف مشاريع، وتحديث ملف <code>data/portfolio_projects.json</code></div>
      </div>
      <div class="row">
        <a class="btn" href="index.html" target="_blank" rel="noopener">فتح الموقع</a>
        <button class="btn danger" id="btnLogout">خروج</button>
      </div>
    </div>

    <div id="loginPanel" class="panel" style="margin-top:16px;">
      <div class="panel-header">
        <h2>دخول الأدمن</h2>
        <span class="pill">رابط + باسورد</span>
      </div>
      <div class="panel-body">
        <div class="notice danger" style="margin-bottom:10px;">
          تنبيه: الباسورد هنا حماية واجهة فقط (Client-side). لا تشارك رابط الأدمن مع أي شخص غير موثوق.
        </div>
        <div class="row" style="align-items:flex-end;">
          <div class="col" style="flex:1; min-width: 260px;">
            <label for="adminPass">الباسورد</label>
            <input id="adminPass" type="password" placeholder="اكتب الباسورد" autocomplete="current-password" />
          </div>
          <button class="btn primary" id="btnLogin">دخول</button>
        </div>
        <div class="notice" style="margin-top:10px;">ملاحظة: غير الباسورد من داخل ملف <code>admin.html</code> (متغير <code>ADMIN_PASSWORD</code>).</div>
      </div>
    </div>

    <div id="app" class="grid hidden">
      <div class="panel">
        <div class="panel-header">
          <h2>المشاريع</h2>
          <span class="pill" id="projectCount">0</span>
        </div>
        <div class="panel-body">
          <div class="row" style="align-items:flex-end; margin-bottom: 10px;">
            <div class="col" style="flex:1; min-width: 220px;">
              <label>اسم المشروع (AR)</label>
              <input id="newTitleAr" type="text" placeholder="مثال: سكني" />
            </div>
            <div class="col" style="flex:1; min-width: 220px;">
              <label>اسم المشروع (EN)</label>
              <input id="newTitleEn" type="text" placeholder="مثال: Residential" />
            </div>
          </div>
          <div class="row" style="align-items:flex-end; margin-bottom: 10px;">
            <div class="col" style="flex:1; min-width: 220px;">
              <label>Slug (اختياري)</label>
              <input id="newSlug" type="text" placeholder="مثال: residential" />
            </div>
            <button class="btn ok" id="btnAddProject">إضافة مشروع</button>
          </div>

          <div class="list" id="projectList"></div>
        </div>
      </div>

      <div class="panel">
        <div class="panel-header">
          <h2 id="selectedTitle">اختر مشروع</h2>
          <div class="row">
            <button class="btn danger small" id="btnDeleteProject" disabled>حذف المشروع</button>
          </div>
        </div>
        <div class="panel-body">
          <div id="fileProtoNotice" class="notice danger hidden" style="margin-bottom: 10px;">
            لن تعمل قراءة الملفات/الرفع عند فتح الصفحة عبر <code>file://</code>. شغّل Live Server أو افتح عبر <code>http://localhost</code>.
          </div>

          <div class="row" style="margin-bottom: 10px;">
            <div class="col" style="flex:1; min-width: 240px;">
              <label>رفع صور للمشروع (اختيار متعدد)</label>
              <input id="imagePicker" type="file" accept="image/*" multiple disabled />
            </div>
            <button class="btn" id="btnAutoNames" disabled>تسمية تلقائية</button>
            <button class="btn" id="btnApplyUploads" disabled>إضافة الصور للمشروع</button>
          </div>

          <div class="panel" style="border-radius: 12px; margin-bottom: 12px;">
            <div class="panel-header">
              <h2 style="margin:0; font-size:0.92rem;">بيانات المشروع</h2>
              <span class="pill">تعديل الاسم</span>
            </div>
            <div class="panel-body">
              <div class="row" style="align-items:flex-end;">
                <div class="col" style="flex:1; min-width: 220px;">
                  <label>اسم المشروع (AR)</label>
                  <input id="editTitleAr" type="text" placeholder="مثال: سكني" disabled />
                </div>
                <div class="col" style="flex:1; min-width: 220px;">
                  <label>اسم المشروع (EN)</label>
                  <input id="editTitleEn" type="text" placeholder="مثال: Residential" disabled />
                </div>
                <button class="btn ok" id="btnSaveProjectTitles" disabled>حفظ الاسم</button>
              </div>
              <div class="notice" style="margin-top: 10px;">تغيير الاسم هنا لا يغيّر اسم الفولدر (slug). يتم حفظه داخل ملف البيانات فقط.</div>
            </div>
          </div>

          <div class="notice" style="margin-bottom: 10px;">
            عدّل الصور هنا (ترتيب/حذف/إعادة تسمية)، ثم صدّر الملفات المطلوبة.
          </div>

          <div class="panel" style="border-radius: 12px; margin-bottom: 12px;">
            <div class="panel-header">
              <h2 style="margin:0; font-size:0.92rem;">قائمة الصور (داخل المشروع)</h2>
              <span class="pill" id="imgCount">0</span>
            </div>
            <div class="panel-body">
              <div class="imgs" id="existingImages"></div>
            </div>
          </div>

          <div class="panel" style="border-radius: 12px;">
            <div class="panel-header">
              <h2 style="margin:0; font-size:0.92rem;">صور جديدة (Preview قبل الإضافة)</h2>
              <span class="pill" id="uploadCount">0</span>
            </div>
            <div class="panel-body">
              <div class="imgs" id="uploadPreview"></div>
            </div>
          </div>

          <div class="panel" style="border-radius: 12px; margin-top: 12px;">
            <div class="panel-header">
              <h2 style="margin:0; font-size:0.92rem;">نشر التعديلات</h2>
              <span class="pill">GitHub</span>
            </div>
            <div class="panel-body">
              <div class="notice danger" style="margin-bottom: 10px;">
                الصق GitHub Token هنا وقت النشر فقط. لا تحفظه في أي مكان.
              </div>

              <div class="row" style="align-items:flex-end;">
                <div class="col" style="flex:1; min-width: 280px;">
                  <label>GitHub Token</label>
                  <input id="ghToken" type="password" placeholder="ghp_..." autocomplete="off" />
                </div>
                <div class="col" style="min-width: 220px;">
                  <label>&nbsp;</label>
                  <button class="btn" id="btnRememberToken" type="button">تذكّر التوكن على هذا الجهاز</button>
                </div>
                <button class="btn ok" id="btnPublish" disabled>نشر التعديلات</button>
                <button class="btn" id="btnExportJson" disabled>Export JSON</button>
              </div>

              <div class="notice" id="statusBox" style="margin-top: 10px;">جاهز.</div>
            </div>
          </div>

        </div>
      </div>
    </div>

  </div>

  <script>
    // ====== CONFIG ======
    // تغيير الباسورد من هنا
    const ADMIN_PASSWORD = 'artrova123';

    const TOKEN_STORE_KEY = 'artrova_admin_gh_token_v1';

    // إعدادات GitHub (ثابتة لتبسيط الاستخدام)
    // غيّرها مرة واحدة ثم ارفع الملف على GitHub
    const GITHUB_OWNER = 'Artovastudio';
    const GITHUB_REPO = 'artrova-landing';
    const GITHUB_BRANCH = 'main';

    // ملاحظة: لا نستخدم localStorage/sessionStorage لتجنب قيود المتصفح (Tracking Prevention)
    let authed = false;

    // ====== STATE ======
    let data = { source: 'portfolio_projects', count: 0, projects: [] };
    let selectedSlug = null;

    // existing images changes
    const deleteSet = new Set(); // image paths marked for deletion

    // rename plan (for existing images): oldPath -> newPath
    const renameMap = new Map();

    // uploads
    /** @type {Array<{file: File, previewUrl: string, name: string, targetPath: (string|null), appliedPath: (string|null), projectSlug: (string|null)}>} */
    let uploads = [];

    // ====== UTILS ======
    const $ = (id) => document.getElementById(id);

    function isFileProtocol() {
      try { return window.location && window.location.protocol === 'file:'; } catch (e) { return false; }
    }

    function slugify(input) {
      return String(input || '')
        .trim()
        .toLowerCase()
        .replace(/[^a-z0-9\s-_]/g, '')
        .replace(/\s+/g, '-')
        .replace(/-+/g, '-')
        .replace(/^\-+|\-+$/g, '') || 'project';
    }

    function sanitizeFilename(name) {
      const cleaned = String(name || '')
        .trim()
        .replace(/\s+/g, '-')
        .replace(/[^a-zA-Z0-9._-]/g, '')
        .replace(/-+/g, '-');
      return cleaned || 'image';
    }

    function getProjectBySlug(slug) {
      return (data.projects || []).find(p => p.slug === slug) || null;
    }

    function findProjectByImagePath(path) {
      const projects = data && Array.isArray(data.projects) ? data.projects : [];
      for (const p of projects) {
        if (p && Array.isArray(p.images) && p.images.includes(path)) return p;
      }
      return null;
    }

    function getProjectTitle(p) {
      if (!p) return '';
      const ar = String(p.titleAr || '').trim();
      const en = String(p.titleEn || '').trim();
      const any = String(p.title || '').trim();
      if (ar && en && ar.toLowerCase() !== en.toLowerCase()) return `${ar} | ${en}`;
      return ar || en || any || p.slug;
    }

    function updateCounts() {
      $('projectCount').textContent = String((data.projects || []).length);
      const p = selectedSlug ? getProjectBySlug(selectedSlug) : null;
      $('imgCount').textContent = p && Array.isArray(p.images) ? String(p.images.length) : '0';
      $('uploadCount').textContent = String(uploads.length);
    }

    function setStatus(text, kind) {
      const box = $('statusBox');
      box.textContent = text;
      box.classList.remove('danger', 'ok');
      if (kind === 'danger') box.classList.add('danger');
      if (kind === 'ok') box.classList.add('ok');
    }

    function downloadText(filename, content) {
      const blob = new Blob([content], { type: 'application/json;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    // ====== RENDER ======
    function renderProjects() {
      const list = $('projectList');
      list.innerHTML = '';
      const projects = (data.projects || []).slice().sort((a,b) => String(getProjectTitle(a)).localeCompare(String(getProjectTitle(b))));

      for (const p of projects) {
        const div = document.createElement('div');
        div.className = 'item' + (p.slug === selectedSlug ? ' active' : '');
        div.innerHTML = `
          <div>
            <div class="title"></div>
            <div class="meta"></div>
          </div>
          <div class="pill">${Array.isArray(p.images) ? p.images.length : 0}</div>
        `;
        div.querySelector('.title').textContent = getProjectTitle(p);
        div.querySelector('.meta').textContent = p.slug;
        div.addEventListener('click', () => selectProject(p.slug));
        list.appendChild(div);
      }

      updateCounts();
    }

    function renderExistingImages() {
      const wrap = $('existingImages');
      wrap.innerHTML = '';
      const p = selectedSlug ? getProjectBySlug(selectedSlug) : null;
      const imgs = p && Array.isArray(p.images) ? p.images : [];

      for (let idx = 0; idx < imgs.length; idx++) {
        const path = imgs[idx];
        const marked = deleteSet.has(path);
        const currentFile = String(path).split('/').pop() || '';
        const currentDir = String(path).split('/').slice(0, -1).join('/');
        const card = document.createElement('div');
        card.className = 'img-card';
        card.innerHTML = `
          <div class="thumb"></div>
          <div class="body">
            <div class="col">
              <label>اسم الملف (تغيير الاسم يحدّث JSON فقط)</label>
              <input type="text" value="${currentFile.replace(/\"/g,'&quot;')}" />
            </div>
            <div class="flags">
              <button class="btn small" data-act="up">↑</button>
              <button class="btn small" data-act="down">↓</button>
              <button class="btn small ${marked ? 'ok' : 'danger'}" data-act="toggleDel">${marked ? 'إلغاء حذف' : 'حذف'}</button>
            </div>
          </div>
        `;

        const thumb = card.querySelector('.thumb');
        const img = document.createElement('img');
        img.src = path;
        img.alt = '';
        img.loading = 'lazy';
        img.decoding = 'async';
        thumb.appendChild(img);

        const nameInput = card.querySelector('input');
        nameInput.addEventListener('input', (e) => {
          const newName = sanitizeFilename(e.target.value);
          const newPath = (currentDir ? `${currentDir}/${newName}` : newName);
          const oldPath = imgs[idx];
          if (newPath && newPath !== oldPath) {
            imgs[idx] = newPath;
            renameMap.set(oldPath, newPath);
            // if it was marked delete, move mark to new path
            if (deleteSet.has(oldPath)) {
              deleteSet.delete(oldPath);
              deleteSet.add(newPath);
            }
          }
        });

        card.querySelector('[data-act="up"]').addEventListener('click', () => moveExisting(idx, -1));
        card.querySelector('[data-act="down"]').addEventListener('click', () => moveExisting(idx, 1));
        card.querySelector('[data-act="toggleDel"]').addEventListener('click', () => toggleDelete(imgs[idx]));

        wrap.appendChild(card);
      }

      updateCounts();
    }

    function renderUploadPreview() {
      const wrap = $('uploadPreview');
      wrap.innerHTML = '';

      uploads.forEach((u, idx) => {
        const card = document.createElement('div');
        card.className = 'img-card';
        card.innerHTML = `
          <div class="thumb"><img src="${u.previewUrl}" alt="" /></div>
          <div class="body">
            <div class="col">
              <label>اسم الملف</label>
              <input type="text" value="${u.name.replace(/"/g,'&quot;')}" />
            </div>
            <div class="col">
              <label>المسار النهائي</label>
              <input type="text" value="${String(u.targetPath || 'غير محدد بعد (اضغط إضافة الصور للمشروع)').replace(/"/g,'&quot;')}" disabled />
            </div>
            <div class="flags">
              <button class="btn small" data-act="up">↑</button>
              <button class="btn small" data-act="down">↓</button>
              <button class="btn small danger" data-act="remove">حذف</button>
            </div>
          </div>
        `;

        const input = card.querySelector('input');
        input.addEventListener('input', (e) => {
          const newName = sanitizeFilename(e.target.value);
          uploads[idx].name = newName;

          // If already applied to project, keep JSON + targetPath in sync
          const applied = uploads[idx].appliedPath;
          const target = uploads[idx].targetPath;
          if (applied && target) {
            const dir = String(target).split('/').slice(0, -1).join('/');
            const newPath = dir ? `${dir}/${newName}` : newName;

            // Update the correct project's images array (do not rely on selected project)
            const p = findProjectByImagePath(applied);
            if (p && Array.isArray(p.images)) {
              const ix = p.images.indexOf(applied);
              if (ix !== -1) {
                p.images[ix] = newPath;
                p.cover = p.images[0] || '';
                p.imageCount = p.images.length;
              }
            }

            uploads[idx].targetPath = newPath;
            uploads[idx].appliedPath = newPath;
            renderUploadPreview();
          }
        });
        card.querySelector('[data-act="up"]').addEventListener('click', () => moveUpload(idx, -1));
        card.querySelector('[data-act="down"]').addEventListener('click', () => moveUpload(idx, 1));
        card.querySelector('[data-act="remove"]').addEventListener('click', () => removeUpload(idx));

        wrap.appendChild(card);
      });

      updateCounts();
    }

    function refreshUI() {
      renderProjects();
      renderExistingImages();
      renderUploadPreview();
      updateActionsEnabled();
    }

    // ====== ACTIONS ======
    function selectProject(slug) {
      selectedSlug = slug;
      deleteSet.clear();
      uploads.forEach(u => URL.revokeObjectURL(u.previewUrl));
      uploads = [];

      const p = getProjectBySlug(slug);
      $('selectedTitle').textContent = p ? getProjectTitle(p) : 'اختر مشروع';
      if ($('editTitleAr')) $('editTitleAr').value = p ? (p.titleAr || '') : '';
      if ($('editTitleEn')) $('editTitleEn').value = p ? (p.titleEn || '') : '';
      refreshUI();
    }

    function updateActionsEnabled() {
      const hasProject = !!selectedSlug && !!getProjectBySlug(selectedSlug);
      $('btnDeleteProject').disabled = !hasProject;
      $('imagePicker').disabled = !hasProject;
      $('btnAutoNames').disabled = !hasProject || uploads.length === 0;
      $('btnApplyUploads').disabled = !hasProject || uploads.length === 0;
      if ($('editTitleAr')) $('editTitleAr').disabled = !hasProject;
      if ($('editTitleEn')) $('editTitleEn').disabled = !hasProject;
      if ($('btnSaveProjectTitles')) $('btnSaveProjectTitles').disabled = !hasProject;

      const canExport = !!(data && Array.isArray(data.projects));
      $('btnExportJson').disabled = !canExport;
      $('btnPublish').disabled = !canExport;
    }

    function saveProjectTitles() {
      const p = selectedSlug ? getProjectBySlug(selectedSlug) : null;
      if (!p) return;
      const ar = String($('editTitleAr').value || '').trim();
      const en = String($('editTitleEn').value || '').trim();
      p.titleAr = ar || null;
      p.titleEn = en || null;
      p.title = (en || ar || p.slug);
      $('selectedTitle').textContent = getProjectTitle(p);
      renderProjects();
      setStatus('تم حفظ الاسم محليًا. اضغط "نشر التعديلات" لتحديث GitHub.', 'ok');
    }

    function tryLoadRememberedToken() {
      try {
        const t = localStorage.getItem(TOKEN_STORE_KEY);
        if (t && $('ghToken')) $('ghToken').value = t;
      } catch (e) {}
    }

    function rememberToken() {
      const token = $('ghToken').value.trim();
      if (!token) {
        alert('الصق التوكن أولاً');
        return;
      }
      try {
        localStorage.setItem(TOKEN_STORE_KEY, token);
        setStatus('تم حفظ التوكن على هذا الجهاز. (لو المتصفح يمنع التخزين، سيُطلب منك كل مرة).', 'ok');
      } catch (e) {
        setStatus('المتصفح منع حفظ التوكن على هذا الجهاز. ستحتاج لصقه كل مرة.', 'danger');
      }
    }

    function addProject() {
      const titleAr = $('newTitleAr').value.trim();
      const titleEn = $('newTitleEn').value.trim();
      const slugInput = $('newSlug').value.trim();

      const base = slugInput || titleEn || titleAr;
      const slug = slugify(base);

      if (!titleAr && !titleEn) {
        alert('اكتب اسم المشروع عربي أو إنجليزي.');
        return;
      }
      if ((data.projects || []).some(p => p.slug === slug)) {
        alert('Slug موجود بالفعل. غيّر الـ slug.');
        return;
      }

      const proj = {
        slug,
        titleAr: titleAr || null,
        titleEn: titleEn || null,
        title: (titleEn || titleAr || slug),
        images: [],
        cover: '',
        imageCount: 0
      };

      data.projects.push(proj);
      data.count = data.projects.length;

      $('newTitleAr').value = '';
      $('newTitleEn').value = '';
      $('newSlug').value = '';

      selectProject(slug);
    }

    function deleteProject() {
      const p = selectedSlug ? getProjectBySlug(selectedSlug) : null;
      if (!p) return;

      const ok = confirm(`تأكيد حذف المشروع: ${getProjectTitle(p)} ؟`);
      if (!ok) return;

      // mark all images for deletion so you can export a delete list
      if (Array.isArray(p.images)) {
        for (const img of p.images) deleteSet.add(img);
      }

      data.projects = (data.projects || []).filter(x => x.slug !== p.slug);
      data.count = data.projects.length;
      selectedSlug = null;
      $('selectedTitle').textContent = 'اختر مشروع';

      refreshUI();
    }

    function toggleDelete(path) {
      if (deleteSet.has(path)) deleteSet.delete(path);
      else deleteSet.add(path);
      renderExistingImages();
    }

    function moveExisting(index, delta) {
      const p = selectedSlug ? getProjectBySlug(selectedSlug) : null;
      if (!p || !Array.isArray(p.images)) return;
      const next = index + delta;
      if (next < 0 || next >= p.images.length) return;
      const arr = p.images;
      const tmp = arr[index];
      arr[index] = arr[next];
      arr[next] = tmp;
      p.cover = arr[0] || '';
      p.imageCount = arr.length;
      renderExistingImages();
    }

    function onPickFiles(files) {
      const picked = Array.from(files || []);
      if (!picked.length) return;

      for (const f of picked) {
        const url = URL.createObjectURL(f);
        uploads.push({ file: f, previewUrl: url, name: sanitizeFilename(f.name), targetPath: null, appliedPath: null, projectSlug: null });
      }

      renderUploadPreview();
      updateActionsEnabled();
    }

    function moveUpload(index, delta) {
      const next = index + delta;
      if (next < 0 || next >= uploads.length) return;
      const tmp = uploads[index];
      uploads[index] = uploads[next];
      uploads[next] = tmp;
      renderUploadPreview();
    }

    function removeUpload(index) {
      const u = uploads[index];
      if (u) URL.revokeObjectURL(u.previewUrl);
      uploads.splice(index, 1);
      renderUploadPreview();
      updateActionsEnabled();
    }

    function autoNameUploads() {
      const p = selectedSlug ? getProjectBySlug(selectedSlug) : null;
      if (!p) return;

      const extFrom = (fileName) => {
        const dot = fileName.lastIndexOf('.');
        return dot !== -1 ? fileName.slice(dot).toLowerCase() : '.jpg';
      };

      let start = 1;
      if (Array.isArray(p.images) && p.images.length) {
        // find max number in existing filenames for this slug
        const rx = new RegExp(`${p.slug}-?(\\d{3,})`, 'i');
        for (const img of p.images) {
          const file = String(img).split('/').pop() || '';
          const m = file.match(rx);
          if (m && m[1]) {
            const n = parseInt(m[1], 10);
            if (!Number.isNaN(n)) start = Math.max(start, n + 1);
          }
        }
      }

      for (let i = 0; i < uploads.length; i++) {
        const u = uploads[i];
        const ext = extFrom(u.name || u.file.name);
        const num = String(start + i).padStart(3, '0');
        uploads[i].name = sanitizeFilename(`${p.slug}-${num}${ext}`);
      }

      renderUploadPreview();
    }

    function applyUploadsToProject() {
      const p = selectedSlug ? getProjectBySlug(selectedSlug) : null;
      if (!p) return;

      const baseDir = `assets/site_images/projects/portfolio_projects/${p.slug}`;

      const used = new Set((p.images || []).map(x => String(x).split('/').pop() || ''));
      const pendingUploads = uploads.filter(u => !!u && !!u.file && !u.targetPath);
      for (const u of pendingUploads) {
        let fileName = sanitizeFilename(u.name);
        if (!fileName) fileName = sanitizeFilename(u.file.name);
        // ensure unique
        if (used.has(fileName)) {
          const dot = fileName.lastIndexOf('.');
          const ext = dot !== -1 ? fileName.slice(dot) : '';
          const stem = dot !== -1 ? fileName.slice(0, dot) : fileName;
          let k = 2;
          while (used.has(`${stem}-${k}${ext}`)) k++;
          fileName = `${stem}-${k}${ext}`;
        }
        used.add(fileName);
        const relPath = `${baseDir}/${fileName}`;
        p.images = Array.isArray(p.images) ? p.images : [];
        p.images.push(relPath);

        // bind upload to its final target path so publish doesn't depend on current selection
        u.targetPath = relPath;
        u.appliedPath = relPath;
        u.projectSlug = p.slug;
      }
      p.cover = (p.images || [])[0] || '';
      p.imageCount = (p.images || []).length;

      setStatus('تمت إضافة الصور للمشروع. الآن اضغط "نشر التعديلات" لرفع الصور وتحديث البيانات على GitHub.', 'ok');
      refreshUI();
    }

    function exportJson() {
      const payload = {
        source: 'portfolio_projects',
        count: (data.projects || []).length,
        projects: data.projects
      };
      downloadText('portfolio_projects.json', JSON.stringify(payload, null, 2));
    }

    // ====== GITHUB API (Simplified) ======
    function ghHeaders(token) {
      return {
        'Accept': 'application/vnd.github+json',
        'Authorization': `Bearer ${token}`
      };
    }

    async function ghGetJson(url, token) {
      const res = await fetch(url, { headers: ghHeaders(token) });
      const text = await res.text();
      let body = null;
      try { body = text ? JSON.parse(text) : null; } catch (e) {}
      if (!res.ok) {
        const msg = body && body.message ? body.message : text;
        throw new Error(msg || `GitHub error: ${res.status}`);
      }
      return body;
    }

    async function ghRequest(url, token, method, payload) {
      const res = await fetch(url, {
        method,
        headers: { ...ghHeaders(token), 'Content-Type': 'application/json' },
        body: payload ? JSON.stringify(payload) : undefined
      });
      const text = await res.text();
      let body = null;
      try { body = text ? JSON.parse(text) : null; } catch (e) {}
      if (!res.ok) {
        const msg = body && body.message ? body.message : text;
        throw new Error(msg || `GitHub error: ${res.status}`);
      }
      return body;
    }

    function ghContentsUrl(owner, repo, path, ref) {
      const enc = encodeURIComponent(path).replace(/%2F/g, '/');
      return `https://api.github.com/repos/${owner}/${repo}/contents/${enc}` + (ref ? `?ref=${encodeURIComponent(ref)}` : '');
    }

    async function ghGetFileMeta(owner, repo, path, ref, token) {
      return ghGetJson(ghContentsUrl(owner, repo, path, ref), token);
    }

    async function ghPutFile(owner, repo, path, branch, token, message, contentBase64, sha) {
      const url = ghContentsUrl(owner, repo, path, null);
      return ghRequest(url, token, 'PUT', { message, content: contentBase64, branch, sha });
    }

    async function ghDeleteFile(owner, repo, path, branch, token, message, sha) {
      const url = ghContentsUrl(owner, repo, path, null);
      return ghRequest(url, token, 'DELETE', { message, branch, sha });
    }

    function arrayBufferToBase64(buffer) {
      let binary = '';
      const bytes = new Uint8Array(buffer);
      for (let i = 0; i < bytes.byteLength; i++) binary += String.fromCharCode(bytes[i]);
      return btoa(binary);
    }

    async function fileToBase64(file) {
      const buf = await file.arrayBuffer();
      return arrayBufferToBase64(buf);
    }

    function utf8ToBase64(str) {
      return btoa(unescape(encodeURIComponent(str)));
    }

    function sitePathToRepoPath(sitePath) {
      return String(sitePath || '').replace(/^\//, '');
    }

    async function publish() {
      const token = $('ghToken').value.trim();
      if (!token) {
        alert('الصق GitHub Token');
        return;
      }

      const pendingNoTarget = uploads.filter(u => !!u && !!u.file && !u.targetPath);
      if (pendingNoTarget.length) {
        alert('في صور تم اختيارها من الجهاز لكن لم يتم إضافتها للمشروع بعد. اضغط "إضافة الصور للمشروع" أولاً.');
        return;
      }

      const owner = GITHUB_OWNER;
      const repo = GITHUB_REPO;
      const branch = GITHUB_BRANCH;

      setStatus('بدء النشر... (قد يأخذ وقت حسب عدد الصور)', '');

      try {
        // 1) Upload new files (bound to targetPath after "إضافة الصور للمشروع")
        const uploadOps = uploads.filter(u => !!u && !!u.file && !!u.targetPath);
        if (uploadOps.length) {
          for (let i = 0; i < uploadOps.length; i++) {
            const u = uploadOps[i];
            const repoPath = sitePathToRepoPath(u.targetPath);
            setStatus(`رفع صورة ${i + 1}/${uploadOps.length}: ${repoPath}`, '');

            let sha = undefined;
            try {
              const meta = await ghGetFileMeta(owner, repo, repoPath, branch, token);
              if (meta && meta.sha) sha = meta.sha;
            } catch (e) {}

            const b64 = await fileToBase64(u.file);
            await ghPutFile(owner, repo, repoPath, branch, token, `Update portfolio image: ${repoPath}`, b64, sha);
          }
        }

        // 2) Rename files (copy content to new path then delete old)
        const renames = Array.from(renameMap.entries());
        if (renames.length) {
          for (let i = 0; i < renames.length; i++) {
            const [fromSite, toSite] = renames[i];
            const fromPath = sitePathToRepoPath(fromSite);
            const toPath = sitePathToRepoPath(toSite);
            if (fromPath === toPath) continue;
            setStatus(`إعادة تسمية ${i + 1}/${renames.length}: ${fromPath} -> ${toPath}`, '');

            let fromMeta = null;
            try {
              fromMeta = await ghGetFileMeta(owner, repo, fromPath, branch, token);
            } catch (e) {
              continue;
            }
            if (!fromMeta || !fromMeta.content || !fromMeta.sha) continue;

            let toSha = undefined;
            try {
              const toMeta = await ghGetFileMeta(owner, repo, toPath, branch, token);
              if (toMeta && toMeta.sha) toSha = toMeta.sha;
            } catch (e) {}

            await ghPutFile(owner, repo, toPath, branch, token, `Rename portfolio image: ${toPath}`, String(fromMeta.content).replace(/\n/g,''), toSha);
            await ghDeleteFile(owner, repo, fromPath, branch, token, `Delete old portfolio image: ${fromPath}`, fromMeta.sha);
          }
        }

        // 3) Delete marked images
        const dels = Array.from(deleteSet.values()).map(sitePathToRepoPath);
        if (dels.length) {
          for (let i = 0; i < dels.length; i++) {
            const rp = dels[i];
            setStatus(`حذف صورة ${i + 1}/${dels.length}: ${rp}`, '');
            try {
              const meta = await ghGetFileMeta(owner, repo, rp, branch, token);
              if (meta && meta.sha) {
                await ghDeleteFile(owner, repo, rp, branch, token, `Delete portfolio image: ${rp}`, meta.sha);
              }
            } catch (e) {
              // ignore
            }
          }
        }

        // 4) Update JSON
        setStatus('تحديث data/portfolio_projects.json ...', '');
        const jsonPath = 'data/portfolio_projects.json';
        let jsonSha = undefined;
        try {
          const meta = await ghGetFileMeta(owner, repo, jsonPath, branch, token);
          if (meta && meta.sha) jsonSha = meta.sha;
        } catch (e) {}

        const payload = {
          source: 'portfolio_projects',
          count: (data.projects || []).length,
          projects: data.projects
        };
        const jsonB64 = utf8ToBase64(JSON.stringify(payload, null, 2));
        await ghPutFile(owner, repo, jsonPath, branch, token, 'Update portfolio projects data', jsonB64, jsonSha);

        deleteSet.clear();
        renameMap.clear();
        uploads.forEach(u => URL.revokeObjectURL(u.previewUrl));
        uploads = [];

        setStatus('تم النشر بنجاح ✅', 'ok');
        refreshUI();
      } catch (e) {
        setStatus(`فشل النشر: ${e && e.message ? e.message : e}`, 'danger');
      }
    }

    // ====== LOAD DATA ======
    async function loadPortfolioJson() {
      // on GitHub pages/static server, this will work.
      const res = await fetch('data/portfolio_projects.json', { cache: 'no-store' });
      if (!res.ok) throw new Error('data/portfolio_projects.json not found');
      const j = await res.json();
      if (!j || !Array.isArray(j.projects)) throw new Error('Invalid JSON structure');
      data = j;
      data.projects = data.projects || [];
      data.count = data.projects.length;
    }

    // ====== AUTH ======
    function isAuthed() {
      return !!authed;
    }

    function setAuthed(val) {
      authed = !!val;
    }

    function showApp() {
      $('loginPanel').classList.add('hidden');
      $('app').classList.remove('hidden');
    }

    function showLogin() {
      $('app').classList.add('hidden');
      $('loginPanel').classList.remove('hidden');
    }

    async function init() {
      $('btnLogout').addEventListener('click', () => {
        setAuthed(false);
        showLogin();
      });

      $('btnLogin').addEventListener('click', async () => {
        const pass = $('adminPass').value;
        if (pass !== ADMIN_PASSWORD) {
          alert('باسورد غير صحيح');
          return;
        }
        setAuthed(true);
        showApp();
        await boot();
      });

      showLogin();
    }

    async function boot() {
      $('fileProtoNotice').classList.toggle('hidden', !isFileProtocol());

      $('btnAddProject').addEventListener('click', addProject);
      $('btnDeleteProject').addEventListener('click', deleteProject);

      $('imagePicker').addEventListener('change', (e) => onPickFiles(e.target.files));
      $('btnAutoNames').addEventListener('click', autoNameUploads);
      $('btnApplyUploads').addEventListener('click', applyUploadsToProject);

      if ($('btnSaveProjectTitles')) $('btnSaveProjectTitles').addEventListener('click', saveProjectTitles);
      if ($('btnRememberToken')) $('btnRememberToken').addEventListener('click', rememberToken);
      tryLoadRememberedToken();

      $('btnExportJson').addEventListener('click', exportJson);
      $('btnPublish').addEventListener('click', publish);

      try {
        await loadPortfolioJson();
        setStatus('تم تحميل بيانات المشاريع.', 'ok');
      } catch (e) {
        setStatus(`تعذر تحميل data/portfolio_projects.json: ${e && e.message ? e.message : e}`, 'danger');
      }

      refreshUI();
      updateActionsEnabled();
    }

    init();
  </script>
</body>
</html>
